{% extends "base.html" %}
{% block title %}Watchers - Email Management Tool{% endblock %}

{% block content %}
<div class="page-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
  <div>
    <h1><i class="bi bi-activity"></i> Watchers</h1>
    <p class="page-subtitle">Monitor the SMTP proxy and IMAP watcher status in real time.</p>
  </div>
  <div class="header-actions btn-group-unified">
    <a href="/settings" class="btn btn-ghost btn-sm" role="button">
      <i class="bi bi-sliders"></i>
      Settings
    </a>
    <button class="btn btn-secondary btn-sm" type="button" onclick="refreshAll()">
      <i class="bi bi-arrow-clockwise"></i>
      Refresh
    </button>
    <button class="btn btn-secondary btn-sm" type="button" onclick="validateCounts()">
      <i class="bi bi-check2-circle"></i>
      Validate Counts
    </button>
  </div>
</div>

<div class="content-section">
  <div class="content-section-header">
    <h2 class="content-section-title">
      <i class="bi bi-speedometer"></i>
      System Overview
    </h2>
  </div>
  <div class="content-section-body">
    <div class="metric-grid">
      <div class="stat-card-modern">
        <div class="stat-label">SMTP Proxy</div>
        <div id="smtpStatus" class="stat-value">--</div>
        <div id="smtpMeta" class="stat-delta"></div>
        <div class="panel-actions">
          <button class="btn btn-ghost btn-sm" type="button" onclick="checkSmtp()">
            <i class="bi bi-heart-pulse"></i>
            Self-check
          </button>
        </div>
      </div>
      <div class="stat-card-modern">
        <div class="stat-label">IMAP Watchers Active</div>
        <div id="watchersCount" class="stat-value" aria-live="polite">0</div>
        <div class="stat-delta" id="watchersDelta">Across all accounts</div>
      </div>
    </div>
  </div>
</div>

<div class="content-section">
  <div class="content-section-header">
    <h2 class="content-section-title">
      <i class="bi bi-inboxes"></i>
      Per-account Watchers
    </h2>
    <div class="header-actions btn-group-unified">
      <button class="btn btn-secondary btn-sm" type="button" onclick="restartAll()">
        <i class="bi bi-arrow-repeat"></i>
        Restart All
      </button>
    </div>
  </div>
  <div class="content-section-body">
    <div id="accountsGrid" class="watcher-grid"></div>
    <div id="accountsEmpty" class="empty-state-unified d-none" role="status" aria-live="polite">
      <i class="bi bi-inboxes"></i>
      <div class="empty-title">No accounts configured</div>
      <div class="empty-description">
        Add an email account to enable live interception and monitoring.
      </div>
      <a href="/accounts" class="btn btn-primary-modern" role="button">
        <i class="bi bi-plus-circle"></i>
        Manage Accounts
      </a>
    </div>
  </div>
</div>

<div class="info-box">
  <h3 class="info-box-title">How it works</h3>
  <p class="mb-0">
    Each mailbox runs an IMAP watcher that moves new mail into Quarantine for review while the local SMTP proxy intercepts inbound messages. Use the controls above to start, stop, or restart watchers as needed.
  </p>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const htmlEntities = {
    '&': '&',
    '<': '<',
    '>': '>',
    '"': '"',
    "'": '''
  };
  const escapeHtml = (value) => {
    return String(value ?? '').replace(/[&<>"']/g, (char) => htmlEntities[char] || char);
  };
  const formatStateLabel = (value) => {
    const label = String(value ?? '').replace(/_/g, ' ').trim();
    return label ? label.charAt(0).toUpperCase() + label.slice(1) : 'Unknown';
  };

  async function loadOverview() {
    try {
      const response = await fetch('/api/watchers/overview');
      if (!response.ok) {
        throw new Error('Failed to load');
      }
      const payload = await response.json();

      const smtpStatusEl = document.getElementById('smtpStatus');
      const smtpMetaEl = document.getElementById('smtpMeta');
      if (payload.smtp && smtpStatusEl) {
        const listening = Boolean(payload.smtp.listening);
        smtpStatusEl.textContent = listening ? 'OK' : 'DOWN';
        smtpStatusEl.classList.toggle('status-ok', listening)
        smtpStatusEl.classList.toggle('status-down', !listening)

        if (smtpMetaEl) {
          const host = payload.smtp.host ?? '127.0.0.1';
          const port = payload.smtp.port ?? '8587';
          const lastCheck = payload.smtp.last_selfcheck_ts ? ` • last self-check ${payload.smtp.last_selfcheck_ts}` : '';
          smtpMetaEl.textContent = `${host}:${port}${lastCheck}`;
        }
      }

      const accounts = Array.isArray(payload.accounts) ? payload.accounts : [];
      const grid = document.getElementById('accountsGrid');
      const emptyState = document.getElementById('accountsEmpty');
      const watchersCountEl = document.getElementById('watchersCount');
      const watchersDeltaEl = document.getElementById('watchersDelta');

      if (grid) {
        grid.innerHTML = '';
        let activeCount = 0;

        accounts.forEach((acc) => {
          const accountId = acc?.id;
          const accountIdAttr = JSON.stringify(accountId);
          const watcherInfo = acc?.watcher || {};
          const rawState = watcherInfo.state || (acc?.is_active ? 'unknown' : 'stopped');
          const normalizedState = String(rawState || '').toLowerCase();
          const chipClass = normalizedState === 'active' ? 'active' : normalizedState === 'stopped' ? 'stopped' : 'unknown';
          const stateLabel = formatStateLabel(rawState);
          const heartbeat = watcherInfo.last_heartbeat || '—';

          if (normalizedState === 'active') {
            activeCount += 1;
          }

          const card = document.createElement('article');
          card.className = 'watcher-card';
          card.setAttribute('data-account-id', String(accountId ?? ''));
          card.innerHTML = `
            <div class="watcher-card-header">
              <div class="watcher-card-heading">
                <h3 class="watcher-card-title">${escapeHtml(acc?.account_name || acc?.email_address || 'Account')}</h3>
                <div class="watcher-card-email">${escapeHtml(acc?.email_address || '—')}</div>
              </div>
              <span class="watcher-chip ${chipClass}" aria-label="Watcher state ${escapeHtml(stateLabel)}">${escapeHtml(stateLabel)}</span>
            </div>
            <div class="watcher-card-body">
              <dl class="watcher-card-meta">
                <div>
                  <dt>State</dt>
                  <dd class="status-text ${chipClass}">${escapeHtml(stateLabel)}</dd>
                </div>
                <div>
                  <dt>Heartbeat</dt>
                  <dd>${escapeHtml(heartbeat)}</dd>
                </div>
              </dl>
              <div class="watcher-card-actions btn-group-unified" role="group" aria-label="Watcher controls for ${escapeHtml(acc?.account_name || 'account')}">
                <button class="btn btn-secondary btn-sm" type="button" onclick='startWatcher(${accountIdAttr}, this)'>
                  <i class="bi bi-play-fill"></i>
                  Start
                </button>
                <button class="btn btn-secondary btn-sm" type="button" onclick='stopWatcher(${accountIdAttr}, this)'>
                  <i class="bi bi-stop-fill"></i>
                  Stop
                </button>
                <button class="btn btn-secondary btn-sm" type="button" onclick='restartWatcher(${accountIdAttr}, this)'>
                  <i class="bi bi-arrow-repeat"></i>
                  Restart
                </button>
              </div>
            </div>
          `;
          grid.appendChild(card);
        });

        const hasAccounts = accounts.length > 0;
        if(grid) grid.classList.toggle('d-none', !hasAccounts);
        if(emptyState) emptyState.classList.toggle('d-none', hasAccounts);

        if (watchersCountEl) {
          watchersCountEl.textContent = activeCount;
          watchersCountEl.dataset.totalAccounts = String(accounts.length);
        }
        if (watchersDeltaEl) {
          watchersDeltaEl.textContent = hasAccounts
            ? (accounts.length === 1 ? 'Across 1 account' : `Across ${accounts.length} accounts`)
            : 'No accounts configured';
        }
      }
    } catch (error) {
      if (window.showError) {
        showError('Failed to load watchers overview: ' + error.message);
      }
      console.error(error);
    }
  }

  async function startWatcher(id, btn) { await controlWatcher(id, 'start', btn); }
  async function stopWatcher(id, btn) { await controlWatcher(id, 'stop', btn); }
  async function restartWatcher(id, btn) { await controlWatcher(id, 'restart', btn); }

  async function controlWatcher(id, action, btn) {
    try {
      if (btn) {
        btn.disabled = true;
        btn.dataset.originalLabel = btn.innerHTML;
        btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>` + btn.dataset.originalLabel;
      }
      const response = await fetch(`/api/accounts/${id}/monitor/${action}`, { method: 'POST' });
      const payload = await response.json();
      if (!payload.success) {
        throw new Error(payload.error || 'Failed');
      }
      if (window.showSuccess) {
        showSuccess(`Watcher ${action}ed`);
      }
    } catch (error) {
      if (window.showError) {
        showError(`Failed to ${action} watcher: ${error.message}`);
      }
    } finally {
      if (btn) {
        btn.innerHTML = btn.dataset.originalLabel || btn.innerHTML;
        btn.disabled = false;
      }
      loadOverview();
    }
  }

  async function restartAll() {
    try {
      const response = await fetch('/api/accounts');
      const payload = await response.json();
      const ids = (payload.accounts || []).map((a) => a.id);
      for (const id of ids) {
        try {
          await fetch(`/api/accounts/${id}/monitor/restart`, { method: 'POST' });
        } catch (error) {
          console.warn('Failed to restart watcher', id, error);
        }
      }
      if (window.showInfo) {
        showInfo('Restarting all watchers...');
      }
      setTimeout(loadOverview, 1500);
    } catch (error) {
      if (window.showError) {
        showError('Failed to restart all');
      }
    }
  }

  async function checkSmtp() {
    try {
      const response = await fetch('/api/smtp-health');
      const payload = await response.json();
      if (window.showInfo) {
        showInfo(payload.listening ? 'SMTP OK' : 'SMTP DOWN');
      }
      loadOverview();
    } catch (error) {
      if (window.showError) {
        showError('SMTP health check failed');
      }
    }
  }

  function refreshAll() {
    loadOverview();
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadOverview();
    setInterval(loadOverview, 10000);
  });

  async function validateCounts() {
    try {
      const response = await fetch('/api/stats-quick-validate');
      const payload = await response.json();
      if (!payload.success) {
        throw new Error(payload.error || 'Failed');
      }
      const counts = payload.counts;
      if (window.showInfo) {
        showInfo(`Counts → total:${counts.total} held:${counts.held} pending:${counts.pending} released:${counts.released} rejected:${counts.rejected}`);
      }
    } catch (error) {
      if (window.showError) {
        showError('Validation failed');
      }
    }
  }
</script>
{% endblock %}
