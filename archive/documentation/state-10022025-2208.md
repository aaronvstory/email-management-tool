Summarized conversation historyReviewing the repo snapshot now. Here’s the game plan before diving in:

- Recap what’s already finished versus still outstanding (code, tests, docs).
- Summarize the health of key systems (interception, SMTP/IMAP, UI, database).
- Produce a polished executive summary + technical spec so you’ve got a current “source of truth.”

---

## Where we stand (as of Oct 2 2025)

### Recent accomplishments

- **Dependency-injectable DB layer**: db.py now accepts injected connections, uses single-pass aggregates, enforces WAL, foreign keys, etc.
- **Dashboard & stats blueprints**: Auth, dashboard, stats, moderation, interception routes live under `app/routes/*` with centralized logging/audit helpers.
- **Interception lifecycle**: Three new pytest cases in test_intercept_flow.py cover fetch → hold → release, including manual edits and latency computation.
- **UI modernization**: Toast notifications, dark theme fixes, working edit modal, uniform `.input-modern` styling per STYLEGUIDE.md.
- **DB Hardening**: Added targeted indices + WAL activated; verification script (verify_indices.py) shows covering-index plans for COUNT queries.
- **Docs**: CLAUDE.md, STYLEGUIDE.md, INTERCEPTION_IMPLEMENTATION.md, and PERMANENT_TEST_ACCOUNTS.md kept current, including the two vetted live accounts.
- **Environment prep**: .env.example lists live test toggles (`ENABLE_LIVE_EMAIL_TESTS`, etc.) plus placeholders for Gmail/Hostinger credentials.

### Gaps & next steps

| Area                    | What’s missing                                                                 | Suggested next move                                                                                                                 |
| ----------------------- | ------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------- |
| **Test harness**        | 62/110 pytest cases fail due to missing fixtures/import changes after Phase 1B | Build a new conftest.py (Flask app/client fixtures, DB session), add a compatibility module for old imports, update pytest markers. |
| **Blueprint migration** | Email CRUD, accounts, diagnostics routes still in simple_app.py                | Continue Phase 1C: move email/account/compose endpoints into routes.                                                                |
| **Integration testing** | No automated live IMAP/SMTP run                                                | Optional: create gated pytest integration suite using the real accounts + dotenv toggles.                                           |
| **CI/story**            | No lint/test pipeline                                                          | Plan for GitHub Actions/pytest job after suite is stable.                                                                           |
| **Docs**                | Need high-level diagrams & quick-start for engineers                           | Use the executive summary below as the new top-level spec; expand diagrams later.                                                   |

---

## Executive Summary (High-Level)

**Email Management Tool** is a Flask-based interception and moderation gateway that sits between inbound email (via SMTP proxy / IMAP monitoring) and the user’s mailbox. It runs entirely on Windows (Python 3.13) with SQLite for persistence, and ships with two real test accounts (Gmail & Hostinger).

### System layout

```
+---------------------+           +-----------------------+
| External senders    | --------> | SMTP Proxy (port 8587)|
+---------------------+           +-----------------------+
                                          |
                                          v
                               +-----------------------+
                               | SQLite (email_messages|
                               |  + encrypted creds)   |
                               +-----------------------+
                                          |
                                          v
                    +-----------------------------------------+
                    | Flask Dashboard (http://localhost:5000) |
                    |  Auth / Dashboard / Stats / Moderation  |
                    +-----------------------------------------+
```

- **SMTP interception**: `EmailModerationHandler` (aiosmtpd). Parses inbound messages, scores risk, writes to `email_messages` with `status=PENDING` and optionally `interception_status=FETCHED/HELD`.
- **IMAP monitoring**: imap_startup.py spawns per-account daemon threads that IDLE on inbox, MOVE suspect mail to “Quarantine,” store raw MIME, and log latency.
- **Dashboard**: Blueprints under routes serve the web UI (stats pages, rules, SSE stream). Legacy routes (email CRUD/compose) remain in simple_app.py until Phase 1C finishes.
- **SQLite**: WAL mode, tuned pragmas, and indices for status/interception queries. Secrets (IMAP/SMTP passwords) encrypted via Fernet (crypto.py, key in key.txt).
- **UI**: Single-page admin panel with dark theme, toast notifications, edit modal, and queue filters. Styling standards enforced by STYLEGUIDE.md.

### Core functionality

| Capability                 | How it works                                                                                                                                           |
| -------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Intercept inbound mail** | SMTP proxy accepts message, stores raw content, risk score, keywords, sets `status=PENDING`. IMAP watcher can also quarantine messages after delivery. |
| **Hold & release**         | Dashboard lists HELD messages; admins can edit subject/body, release back to IMAP via APPEND, or discard (with audit logging).                         |
| **Editing**                | `POST /api/email/<id>/edit` persists changes; diff shown in UI.                                                                                        |
| **Rules & auto-hold**      | Moderation rules (UI + DB) can auto-mark messages for hold based on keywords/score.                                                                    |
| **Compose/reply/forward**  | Drafts through the web UI hit SMTP providers directly (STARTTLS or SSL depending on port).                                                             |
| **Audit trail**            | audit.py logs actions (LOGIN, INTERCEPT, RELEASE, etc.) for traceability.                                                                              |
| **Live stats**             | stats.py caches aggregated counts (total, pending, held, released, etc.) with TTL; SSE endpoint streams updates.                                       |

---

## Technical Specification Highlights

### Deployment

- Run EmailManager.bat or `python simple_app.py`.
- Requires Python 3.9+ on Windows (paths assume `\` separators).
- .env (not committed) can override DB path, enable watchers, and supply real credentials.

### Database

- `email_messages`: message metadata, raw bodies, action timestamps, latency, risk scores, intercept status.
- `email_accounts`: encrypted credentials + IMAP/SMTP connection parameters.
- `users`: admin login data (bcrypt hashes, default user `admin`/`admin123`).
- Indices (Phase 0) cover status, interception, account combos, original_uid.

### Email interception specifics

1. **SMTP path**
   - `EmailModerationHandler.handle_DATA` stores message, populates risk metadata, returns 250.
   - Optionally triggers rule-based auto-holds.
2. **IMAP path**
   - Threads select INBOX, IDLE, fetch new UIDs, move to Quarantine.
   - Database row updated to `interception_status='HELD'`, `original_uid` captured.
3. **Release**
   - `app/routes/interception.py::release_email` rebuilds MIME (optionally using edited body), APPENDs to INBOX, sets `interception_status='RELEASED'` + `status='DELIVERED'`.
4. **Manual intercept** (already inboxed)
   - `POST /api/email/<id>/intercept` can re-open and programmatically move messages from inbox back into hold, computing latency and logging the action.

### Threading & concurrency

- Flask server (main thread) hosts blueprints and API.
- SMTP proxy on its own daemon thread.
- One IMAP watcher thread per active account.
- All share the SQLite DB; WAL + busy_timeout mitigate contention.

### Testing

- **What works**: interception (80% pass), test_intercept_flow.py, test_db_utils.py, test_stats.py.
- **What’s broken**: Legacy suite (missing fixtures, wrong import paths). See test-failure-analysis.md for full breakdown.
- **Recommendations**: Build Flask fixtures, add import compatibility, then refactor tests to use DI-friendly db utilities.

### Credentials for live exercises

- Gmail: `ndayijecika@gmail.com` / `bjormgplhgwkgpad` (app password, keep spaces).
- Hostinger: `mcintyre@corrinbox.com` / `25Horses807$` (direct SSL).
- Configured in DB (IDs 3 and 2 respectively) and documented under “Permanent Test Accounts” in CLAUDE.md.

### Configuration toggles

- .env: `ENABLE_WATCHERS`, `ENABLE_LIVE_EMAIL_TESTS`, `LIVE_EMAIL_ACCOUNT`, etc.
- `ENABLE_WATCHERS=0` to run app without IMAP threads (useful for dev).

### Logging & observability

- app.log captures Flask + SMTP/IMAP events.
- Audit table (lightweight) records user actions; best-effort logging avoids blocking.

---

## Recommended immediate focus

1. **Finish Phase 1C blueprint split** (email CRUD + account routes).
2. **Test infrastructure**: new conftest.py, dependency-injected DB for counts/stats tests, import adapters.
3. **Optional live integration suite**: gated by .env to exercise Gmail/Hostinger end-to-end.
4. **CI pipeline**: once tests stable, add PyTest job to GitHub Actions.

Let me know which area you want to tackle first (blueprint migration, test harness, or live integration), and I’ll queue up the next actions.
