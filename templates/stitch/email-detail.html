{% extends "base.html" %}
{% from 'stitch/_macros.html' import badge, icon_btn %}

{% block title %}Email #{{ email.id }} - Email Management Tool{% endblock %}

{% block content %}
<div id="email-detail-page">
<main class="tw-flex-1 tw-p-6 tw-space-y-6">
    <div class="tw-flex tw-items-center tw-justify-between">
        <div class="tw-flex tw-items-center tw-gap-4">
            <a href="{{ url_for('emails.emails_unified_stitch') }}" class="tw-text-zinc-400 hover:tw-text-zinc-200">
                <span class="material-symbols-outlined">arrow_back</span>
            </a>
            <div>
                <h1 class="tw-text-2xl tw-font-bold tw-text-white">{{ email.subject or '(no subject)' }}</h1>
                <p class="tw-text-zinc-400 tw-text-sm tw-mt-1">Email #{{ email.id }}</p>
            </div>
        </div>
        <div class="tw-flex tw-gap-2">
            {% if email.interception_status == 'HELD' %}
                {{ icon_btn('Release', 'done', 'primary', url_for('interception_bp.release_stitch', email_id=email.id)) }}
                {{ icon_btn('Discard', 'delete', 'danger', url_for('interception_bp.discard_stitch', email_id=email.id)) }}
                {{ icon_btn('Edit', 'edit', 'neutral', url_for('emails.email_edit_stitch', id=email.id)) }}
            {% endif %}
        </div>
    </div>

    <!-- Email Details Card -->
    <div class="tw-bg-background tw-border tw-border-border">
        <div class="tw-px-4 tw-py-3 tw-border-b tw-border-border">
            <div class="tw-flex tw-justify-between tw-items-center">
                <h2 class="tw-text-zinc-200 tw-font-semibold">Message Details</h2>
                {{ badge(email.interception_status or 'PENDING') }}
            </div>
        </div>
        <div class="tw-p-4 tw-space-y-3">
            <div class="tw-grid tw-grid-cols-[100px_1fr] tw-gap-x-4 tw-gap-y-2">
                <div class="tw-text-zinc-400 tw-text-sm">From:</div>
                <div class="tw-text-zinc-200">{{ email.sender }}</div>

                <div class="tw-text-zinc-400 tw-text-sm">To:</div>
                <div class="tw-text-zinc-200">
                    {% if email.recipients %}
                        {{ email.recipients|join(', ') if email.recipients is iterable and email.recipients is not string else email.recipients }}
                    {% else %}
                        -
                    {% endif %}
                </div>

                <div class="tw-text-zinc-400 tw-text-sm">Account:</div>
                <div class="tw-text-zinc-200">{{ email.account_name or 'Unknown' }} ({{ email.email_address or 'N/A' }})</div>

                <div class="tw-text-zinc-400 tw-text-sm">Date:</div>
                <div class="tw-text-zinc-200">{{ email.created_at or '-' }}</div>

                {% if email.keywords_matched %}
                <div class="tw-text-zinc-400 tw-text-sm">Keywords:</div>
                <div class="tw-flex tw-flex-wrap tw-gap-1">
                    {% for keyword in email.keywords_matched %}
                    <span class="tw-bg-zinc-700 tw-text-zinc-300 tw-text-xs tw-px-2 tw-py-0.5">{{ keyword }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Email Body -->
    <div class="tw-bg-background tw-border tw-border-border">
        <div class="tw-px-4 tw-py-3 tw-border-b tw-border-border">
            <h2 class="tw-text-zinc-200 tw-font-semibold">Message Content</h2>
        </div>
        <div class="tw-p-4">
            <div class="tw-text-zinc-200 tw-whitespace-pre-wrap tw-font-mono tw-text-sm">
                {{ email.body_text or email.body_html|safe or '(no content)' }}
            </div>
        </div>
    </div>

    <!-- Attachments -->
    {% if attachments %}
    <div class="tw-bg-background tw-border tw-border-border">
        <div class="tw-px-4 tw-py-3 tw-border-b tw-border-border tw-flex tw-items-center tw-justify-between">
            <h2 class="tw-text-zinc-200 tw-font-semibold">
                <span class="material-symbols-outlined tw-text-base tw-align-middle">attach_file</span>
                Attachments ({{ attachments|length }})
            </h2>
            {% if attachments|length > 1 %}
            <a href="{{ url_for('interception_bp.api_email_attachments_download_all', email_id=email.id) }}"
               class="tw-inline-flex tw-items-center tw-gap-1 tw-text-sm tw-font-semibold tw-text-zinc-900 tw-bg-primary tw-border tw-border-primary tw-px-3 tw-py-1.5 hover:tw-bg-lime-400 tw-transition">
                <span class="material-symbols-outlined tw-text-base">download</span>
                Download All
            </a>
            {% endif %}
        </div>
        <div class="tw-p-4">
            <ul class="tw-divide-y tw-divide-zinc-800">
                {% for att in attachments %}
                <li class="tw-flex tw-items-center tw-justify-between tw-py-3 tw-group">
                    <div class="tw-flex tw-items-center tw-gap-3">
                        <span class="material-symbols-outlined tw-text-zinc-400 tw-text-2xl">
                            {% if att.mime_type %}
                                {% if 'image' in att.mime_type %}
                                    image
                                {% elif 'pdf' in att.mime_type %}
                                    picture_as_pdf
                                {% elif 'zip' in att.mime_type or 'compressed' in att.mime_type %}
                                    folder_zip
                                {% elif 'word' in att.mime_type or 'document' in att.mime_type %}
                                    description
                                {% elif 'excel' in att.mime_type or 'spreadsheet' in att.mime_type %}
                                    table_chart
                                {% else %}
                                    attach_file
                                {% endif %}
                            {% else %}
                                attach_file
                            {% endif %}
                        </span>
                        <div>
                            <div class="tw-text-zinc-200 tw-font-medium">{{ att.filename }}</div>
                            <div class="tw-text-zinc-500 tw-text-xs tw-mt-0.5">
                                {% if att.size %}
                                    {% if att.size < 1024 %}
                                        {{ att.size }} bytes
                                    {% elif att.size < 1048576 %}
                                        {{ (att.size / 1024)|round(1) }} KB
                                    {% else %}
                                        {{ (att.size / 1048576)|round(2) }} MB
                                    {% endif %}
                                {% endif %}
                                {% if att.mime_type %}
                                    <span class="tw-mx-1">â€¢</span>
                                    <span class="tw-text-zinc-600">{{ att.mime_type.split('/')[1]|upper if '/' in att.mime_type else att.mime_type|upper }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <a href="{{ url_for('interception_bp.api_attachment_download', attachment_id=att.id) }}"
                       class="tw-inline-flex tw-items-center tw-gap-1 tw-text-sm tw-text-zinc-400 hover:tw-text-primary tw-transition">
                        <span class="material-symbols-outlined tw-text-base">download</span>
                        Download
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}
</main>
</div>
{% endblock %}
