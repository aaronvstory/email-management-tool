{% extends "base.html" %}

{% block title %}Interception Test - Email Management Tool{% endblock %}

{% block content %}
<div id="test-page">
<main class="tw-flex-1 tw-p-6 tw-space-y-6">
    <div class="tw-flex tw-items-center tw-justify-between">
        <div>
            <h1 class="tw-text-2xl tw-font-bold tw-text-white">Interception Test Suite</h1>
            <p class="tw-text-zinc-400 tw-text-sm tw-mt-1">End-to-end testing of email interception and delivery flow</p>
        </div>
        <button onclick="clearResults()" class="tw-bg-zinc-700 tw-text-zinc-200 tw-font-semibold tw-py-2 tw-px-4 hover:tw-bg-zinc-600 tw-transition-colors tw-flex tw-items-center tw-gap-2">
            <span class="material-symbols-outlined tw-text-base">delete</span>
            Clear Results
        </button>
    </div>

    <!-- Quick Bi-Directional Tests -->
    <div class="tw-bg-background tw-border tw-border-border tw-p-4">
        <h3 class="tw-text-zinc-200 tw-font-semibold tw-mb-3">Quick Bi-Directional Tests</h3>
        <p class="tw-text-zinc-400 tw-text-sm tw-mb-4">Automated tests using permanent accounts with polling watcher interception</p>

        <div class="tw-grid tw-grid-cols-1 tw-md:grid-cols-2 tw-gap-4">
            <button id="testHostingerToGmail" onclick="runBiDirectionalTest('hostinger-to-gmail')" class="tw-bg-primary tw-text-zinc-900 tw-font-semibold tw-py-3 tw-px-4 hover:tw-bg-lime-400 tw-transition-colors tw-flex tw-items-center tw-justify-center tw-gap-2">
                <span class="material-symbols-outlined">arrow_forward</span>
                Test Hostinger → Gmail
            </button>
            <button id="testGmailToHostinger" onclick="runBiDirectionalTest('gmail-to-hostinger')" class="tw-bg-primary tw-text-zinc-900 tw-font-semibold tw-py-3 tw-px-4 hover:tw-bg-lime-400 tw-transition-colors tw-flex tw-items-center tw-justify-center tw-gap-2">
                <span class="material-symbols-outlined">arrow_back</span>
                Test Gmail → Hostinger
            </button>
        </div>

        <!-- Test Progress -->
        <div id="biDirectionalProgress" class="tw-hidden tw-mt-4 tw-bg-zinc-800 tw-border tw-border-zinc-700 tw-p-4">
            <div class="tw-flex tw-items-center tw-gap-3 tw-mb-2">
                <div class="tw-w-4 tw-h-4 tw-border-2 tw-border-primary tw-border-t-transparent tw-rounded-full tw-animate-spin"></div>
                <strong class="tw-text-primary" id="progressTitle">Running Test...</strong>
            </div>
            <div id="progressDetails" class="tw-text-zinc-400 tw-text-sm">Initializing...</div>
        </div>
    </div>

    <!-- Live Results Timeline -->
    <div class="tw-bg-background tw-border tw-border-border">
        <div class="tw-px-4 tw-py-3 tw-border-b tw-border-border tw-flex tw-justify-between tw-items-center">
            <h3 class="tw-text-zinc-200 tw-font-semibold">Live Test Results</h3>
            <span id="testStatus" class="tw-text-xs tw-font-bold tw-px-2 tw-py-0.5 tw-bg-zinc-700 tw-text-zinc-300">READY</span>
        </div>
        <div class="tw-p-4">
            <div id="resultsTimeline" class="tw-space-y-3">
                <!-- Timeline items will be added dynamically -->
            </div>
        </div>
    </div>
</main>
</div>

<script>
// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    addTimelineItem('info', 'System Ready', 'Test suite initialized');
});

// Run bi-directional test
async function runBiDirectionalTest(direction) {
    const progressDiv = document.getElementById('biDirectionalProgress');
    const progressTitle = document.getElementById('progressTitle');
    const progressDetails = document.getElementById('progressDetails');

    // Disable buttons during test
    const buttons = ['testHostingerToGmail', 'testGmailToHostinger'];
    buttons.forEach(id => {
        document.getElementById(id).disabled = true;
    });

    // Show progress
    progressDiv.classList.remove('tw-hidden', 'tw-bg-zinc-800', 'tw-bg-green-900/20', 'tw-bg-red-900/20');
    progressDiv.classList.add('tw-bg-zinc-800');

    try {
        progressTitle.textContent = direction === 'hostinger-to-gmail' ? 'Testing Hostinger → Gmail' : 'Testing Gmail → Hostinger';
        progressDetails.textContent = 'Step 1/3: Sending email...';

        addTimelineItem('info', `${direction === 'hostinger-to-gmail' ? 'Hostinger → Gmail' : 'Gmail → Hostinger'} Test`, 'Sending test email...');

        // Send email
        const sendResponse = await fetch('/api/test/send-bi-directional', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                direction: direction,
                subject: `INVOICE - Test ${direction === 'hostinger-to-gmail' ? 'Hostinger→Gmail' : 'Gmail→Hostinger'} ${new Date().toLocaleTimeString()}`
            })
        });
        const sendResult = await sendResponse.json();

        if (!sendResult.success) {
            throw new Error(sendResult.error || 'Failed to send email');
        }

        addTimelineItem('success', 'Email Sent', `Subject: ${sendResult.subject}`);
        progressDetails.textContent = 'Step 2/3: Waiting for interception (polling mode)...';

        // Poll for interception
        let intercepted = false;
        for (let i = 0; i < 30; i++) {
            await sleep(1000);
            progressDetails.textContent = `Step 2/3: Waiting for interception (${i + 1}s elapsed)...`;

            const checkResponse = await fetch(`/api/test/check-interception?subject=${encodeURIComponent(sendResult.subject)}`);
            const checkResult = await checkResponse.json();

            if (checkResult.success && checkResult.email_id) {
                intercepted = true;
                progressDetails.textContent = `Step 3/3: Email intercepted! ID: ${checkResult.email_id}`;
                addTimelineItem('success', 'Email Intercepted', `Email ID: ${checkResult.email_id}, Status: ${checkResult.status}`);
                await sleep(2000);
                break;
            }
        }

        if (!intercepted) {
            throw new Error('Email not intercepted within 30 seconds');
        }

        progressTitle.textContent = `✓ Test Complete`;
        progressDetails.textContent = 'Email successfully sent and intercepted by polling watcher';
        progressDiv.classList.remove('tw-bg-zinc-800');
        progressDiv.classList.add('tw-bg-green-900/20', 'tw-border-green-700');
        document.getElementById('testStatus').textContent = 'SUCCESS';
        document.getElementById('testStatus').className = 'tw-text-xs tw-font-bold tw-px-2 tw-py-0.5 tw-bg-green-500/15 tw-text-green-400';

    } catch (error) {
        progressTitle.textContent = '✗ Test Failed';
        progressDetails.textContent = error.message;
        progressDiv.classList.remove('tw-bg-zinc-800');
        progressDiv.classList.add('tw-bg-red-900/20', 'tw-border-red-700');
        addTimelineItem('error', 'Test Failed', error.message);
        document.getElementById('testStatus').textContent = 'FAILED';
        document.getElementById('testStatus').className = 'tw-text-xs tw-font-bold tw-px-2 tw-py-0.5 tw-bg-red-500/15 tw-text-red-400';
    } finally {
        // Re-enable buttons
        buttons.forEach(id => {
            document.getElementById(id).disabled = false;
        });
    }
}

// Add timeline item
function addTimelineItem(type, title, details) {
    const timeline = document.getElementById('resultsTimeline');

    const item = document.createElement('div');
    item.className = 'tw-flex tw-gap-3 tw-p-3 tw-bg-zinc-900 tw-border tw-border-zinc-800';

    const iconColor = type === 'success' ? 'tw-text-green-400' : type === 'error' ? 'tw-text-red-400' : 'tw-text-zinc-400';
    const icon = type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info';

    item.innerHTML = `
        <span class="material-symbols-outlined ${iconColor} tw-text-lg">${icon}</span>
        <div class="tw-flex-1">
            <div class="tw-text-white tw-font-medium tw-text-sm">${title}</div>
            <div class="tw-text-zinc-400 tw-text-xs tw-mt-1">${details}</div>
            <div class="tw-text-zinc-500 tw-text-xs tw-mt-1">${new Date().toLocaleTimeString()}</div>
        </div>
    `;

    timeline.insertBefore(item, timeline.firstChild);

    // Limit to 20 items
    while (timeline.children.length > 20) {
        timeline.removeChild(timeline.lastChild);
    }
}

// Clear results
function clearResults() {
    document.getElementById('resultsTimeline').innerHTML = '';
    document.getElementById('biDirectionalProgress').classList.add('tw-hidden');
    document.getElementById('testStatus').textContent = 'READY';
    document.getElementById('testStatus').className = 'tw-text-xs tw-font-bold tw-px-2 tw-py-0.5 tw-bg-zinc-700 tw-text-zinc-300';
    addTimelineItem('info', 'Results Cleared', 'Ready for new test');
}

// Sleep helper
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}
</script>
{% endblock %}
