{% extends "base.html" %}
{% block title %}Inbox - Email Management Tool{% endblock %}
{% block extra_css %}
<style>
  /* Account Selector */
  .account-selector {
    background: rgba(26,26,26,0.9);
    border-radius: 15px;
    padding: 15px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px -1px rgba(0,0,0,.6),0 1px 2px rgba(0,0,0,.4);
    border: 1px solid rgba(255,255,255,0.06);
  }

  .account-selector label {
    color: #ffffff;
    font-weight: 600;
    margin-bottom: 8px;
    display: block;
  }

  .account-selector select {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.12);
    color: #ffffff;
    width: 100%;
    padding: 10px;
    border-radius: 8px;
  }

  .account-selector select option {
    background: #1a1a1a;
    color: #ffffff;
  }

  .inbox-panel { background: var(--surface-highest); border:1px solid var(--border-subtle); border-radius: var(--radius-lg); padding:20px; box-shadow: var(--shadow-sm); }
  .email-row { display:grid; grid-template-columns: 70px 1fr 120px 90px; gap:1rem; padding:.75rem 1rem; border-bottom:1px solid rgba(255,255,255,0.06); cursor:pointer; transition: background .2s; }
  .email-row:hover { background: rgba(255,255,255,0.05); }
  .email-row:last-child { border-bottom:none; }
  /* Status chips use unified styles from main.css (.status-chip/.status-badge + .status-*) */
  .filters-bar { display:flex; gap:.75rem; flex-wrap:wrap; margin-bottom:1rem; }
  .search-input { flex:1; min-width:220px; }
  .preview-snippet { font-size:.7rem; opacity:.8; margin-top:.25rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <h1><i class="bi bi-inbox"></i> Inbox</h1>
    <p class="text-muted mb-0">View and manage received email messages from monitored accounts.</p>
  </div>
  <div class="header-actions">
    <a href="/compose" class="btn btn-secondary btn-sm">
      <i class="bi bi-envelope-plus"></i> Compose
    </a>
    <a href="/interception" class="btn btn-ghost btn-sm">
      <i class="bi bi-shield-lock"></i> Held Messages
    </a>
  </div>
</div>

<!-- Account Selector with Fetch Controls -->
<div class="account-selector">
  <div style="display: flex; gap: 15px; align-items: flex-end;">
    <div style="flex: 1;">
      <label class="form-label">Select Email Account:</label>
      <select class="form-select" id="accountSelector" onchange="switchAccount(this.value)">
        <option value="">All Accounts</option>
        {% for account in accounts %}
        <option value="{{ account.id }}" {% if selected_account == account.id %}selected{% endif %}>
          {{ account.account_name }} ({{ account.email_address }})
        </option>
        {% endfor %}
      </select>
    </div>

    <!-- Fetch Controls -->
    <div style="display: flex; gap: 10px; align-items: center;">
      <div>
        <label class="form-label" style="font-size: 0.85rem;">Fetch Count:</label>
        <select class="form-select" id="fetchCount" style="width: 80px;">
          <option value="10">10</option>
          <option value="20" selected>20</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
      <button class="btn btn-secondary btn-sm" onclick="fetchEmails()" style="margin-top: 20px;">
        <i class="bi bi-cloud-download"></i> Fetch Emails
      </button>
      <button class="btn btn-ghost btn-sm" onclick="fetchMore()" style="margin-top: 20px;">
        <i class="bi bi-plus-circle"></i> Load More
      </button>
    </div>
  </div>

  <!-- Fetch Status -->
  <div id="fetchStatus" style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 8px; display: none;">
    <span id="fetchMessage" style="color: #818cf8;"></span>
  </div>
</div>

<div class="inbox-panel">
  <div class="filters-bar">
    <select id="statusFilter" class="input-modern" style="max-width:140px;">
      <option value="">All</option>
      <option value="HELD">HELD</option>
      <option value="RELEASED">RELEASED</option>
      <option value="DISCARDED">DISCARDED</option>
      <option value="PENDING">PENDING</option>
    </select>
    <input id="searchBox" class="input-modern search-input" placeholder="Search subject or sender" style="background: rgba(255,255,255,0.06); color: #ffffff;" />
    <button class="btn btn-ghost btn-sm" onclick="reloadInbox()">Apply</button>
  </div>
  <div id="inboxList"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let fetchOffset = 0;  // Track pagination offset

function switchAccount(accountId) {
    let url = '/inbox';
    if (accountId) {
        url += `?account_id=${accountId}`;
    }
    window.location.href = url;
}

async function fetchEmails() {
    const accountId = document.getElementById('accountSelector').value;
    if (!accountId) {
        showWarning('Please select an account first');
        return;
    }

    const fetchCount = parseInt(document.getElementById('fetchCount').value);

    // Show status
    const statusDiv = document.getElementById('fetchStatus');
    const statusMsg = document.getElementById('fetchMessage');
    statusDiv.style.display = 'block';
    statusMsg.textContent = `Fetching ${fetchCount} emails from server...`;

    try {
        const response = await fetch('/api/fetch-emails', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                account_id: accountId,
                count: fetchCount,
                offset: 0
            })
        });

        const data = await response.json();

        if (data.success) {
            statusMsg.textContent = `‚úÖ Fetched ${data.fetched} emails successfully! Total available: ${data.total_available}`;
            fetchOffset = data.fetched;  // Update offset for next fetch

            // Reload inbox to show new emails
            setTimeout(() => {
                reloadInbox();
            }, 1500);
        } else {
            statusMsg.textContent = `‚ùå Error: ${data.error}`;
        }
    } catch (error) {
        statusMsg.textContent = `‚ùå Failed to fetch emails: ${error}`;
    }
}

async function fetchMore() {
    const accountId = document.getElementById('accountSelector').value;
    if (!accountId) {
        showWarning('Please select an account first');
        return;
    }

    const fetchCount = parseInt(document.getElementById('fetchCount').value);

    // Show status
    const statusDiv = document.getElementById('fetchStatus');
    const statusMsg = document.getElementById('fetchMessage');
    statusDiv.style.display = 'block';
    statusMsg.textContent = `Loading ${fetchCount} more emails...`;

    try {
        const response = await fetch('/api/fetch-emails', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                account_id: accountId,
                count: fetchCount,
                offset: fetchOffset
            })
        });

        const data = await response.json();

        if (data.success) {
            statusMsg.textContent = `‚úÖ Loaded ${data.fetched} more emails! Total available: ${data.total_available}`;
            fetchOffset += data.fetched;  // Update offset for next fetch

            // Reload inbox to show new emails
            setTimeout(() => {
                reloadInbox();
            }, 1500);
        } else {
            statusMsg.textContent = `‚ùå Error: ${data.error}`;
        }
    } catch (error) {
        statusMsg.textContent = `‚ùå Failed to load more emails: ${error}`;
    }
}

async function fetchInbox(){
    const status=document.getElementById('statusFilter').value;
    const accountId = document.getElementById('accountSelector').value;
    const q=document.getElementById('searchBox').value;
    const params=new URLSearchParams();
    if(status) params.append('status',status);
    if(q) params.append('q',q);
    if(accountId) params.append('account_id',accountId);
    const r=await fetch('/api/inbox?'+params.toString());
    if(!r.ok){return {messages:[]};}
    return r.json();
}
function renderInbox(msgs){
    const container=document.getElementById('inboxList');
    if(!msgs.length){container.innerHTML='<div style="padding:2rem;text-align:center;opacity:.7;">No messages in inbox</div>';return;}
    container.innerHTML='';
    msgs.forEach(m=>{
        const div=document.createElement('div');
        div.className='email-row';
        div.onclick=()=>window.location='/email/'+m.id;
        const status = m.interception_status || m.status || '';

        // Build indicators for rules matched and hold status
        let indicators = '';
        if (m.keywords_matched && m.keywords_matched.length > 0) {
            const keywords = JSON.parse(m.keywords_matched);
            indicators += `<span style="color:#fbbf24;font-size:0.7rem;margin-right:5px;" title="Matched rules: ${keywords.join(', ')}">‚ö†Ô∏è Rules: ${keywords.length}</span>`;
        }
        if (m.risk_score && m.risk_score > 0) {
            indicators += `<span style="color:#ef4444;font-size:0.7rem;margin-right:5px;" title="Risk score">Risk: ${m.risk_score}</span>`;
        }
        if (status === 'HELD') {
            indicators += `<span style="color:#3b82f6;font-size:0.7rem;" title="Email is being held for review">üîí Held</span>`;
        }

        div.innerHTML=`<div><div class='status-badge status-${status}'>${status||'‚Äî'}</div></div>
            <div>
                <div style='font-weight:600;'>${m.sender||''}</div>
                <div>${m.subject||'(No Subject)'}</div>
                <div class='preview-snippet'>${(m.preview_snippet||'').slice(0,120)}</div>
                ${indicators ? `<div style="margin-top:5px;">${indicators}</div>` : ''}
            </div>
            <div class='time-cell'>${m.created_at||''}</div>
            <div style='font-size:.7rem;opacity:.7;text-align:right;'>${m.latency_ms ? m.latency_ms + 'ms' : ''}</div>`;
        container.appendChild(div);
    });
}
async function reloadInbox(){
    const data=await fetchInbox();
    renderInbox(data.messages||[]);
}
reloadInbox();
setInterval(()=>{ if(!document.hidden) reloadInbox(); }, 30000);
</script>
{% endblock %}
