{% extends "base.html" %}
{% import 'partials/account_components.html' as account_ui %}
{% import 'partials/rule_components.html' as rule_ui %}

{% block title %}Dashboard - Email Management Tool{% endblock %}

{% block extra_css %}
<style>
  /* Compact account selector */
  .account-selector {
    background: rgba(26,26,26,0.9);
    border-radius: 12px;
    padding: 12px 15px;
    margin-bottom: 15px;
    box-shadow: 0 2px 4px -1px rgba(0,0,0,.6),0 1px 2px rgba(0,0,0,.4);
    border: 1px solid rgba(255,255,255,0.06);
  }

  .account-selector label {
    color: #9ca3af;
    font-weight: 500;
    margin-bottom: 6px;
    display: block;
    font-size: 0.85rem;
  }

  .account-selector select {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.12);
    color: #ffffff;
    width: 100%;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.95rem;
  }

  .account-selector select option {
    background: #1a1a1a;
    color: #ffffff;
  }

  /* Compact stats grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }

  .stat-card {
    background: linear-gradient(145deg, #1a1a1a 0%, #1f1f1f 60%, #242424 100%);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 12px;
    padding: 15px;
    text-align: center;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }

  .stat-value {
    font-size: 1.8rem;
    font-weight: 700;
    color: #ffffff;
    display: block;
    line-height: 1;
  }

  .stat-label {
    font-size: 0.75rem;
    color: #9ca3af;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 5px;
    display: block;
  }

  .stat-card.held .stat-value {
    color: #f87171;
  }

  .stat-card.released .stat-value {
    color: #34d399;
  }

  /* Recent emails section */
  .recent-emails-panel {
    background: linear-gradient(145deg, #1a1a1a 0%, #1f1f1f 60%, #242424 100%);
    border-radius: 18px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.6);
    border: 1px solid rgba(255,255,255,0.06);
  }

  #emailsList {
    max-height: 600px;
    overflow-y: auto;
    overflow-x: hidden;
    display: block;
    width: 100%;
  }

  #emailsList::-webkit-scrollbar {
    width: 8px;
  }

  #emailsList::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.03);
    border-radius: 4px;
  }

  #emailsList::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.15);
    border-radius: 4px;
  }

  #emailsList::-webkit-scrollbar-thumb:hover {
    background: rgba(255,255,255,0.25);
  }

  .panel-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #ffffff;
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .email-list-item {
    display: grid;
    grid-template-columns: 250px 1fr 80px 140px;
    align-items: center;
    padding: 12px;
    border-bottom: 1px solid rgba(255,255,255,0.06);
    transition: background 0.2s;
    gap: 12px;
    width: 100%;
    box-sizing: border-box;
    min-height: 50px;
    max-width: 100%;
    overflow: hidden;
  }

  .email-list-item:hover {
    background: rgba(255,255,255,0.03);
    cursor: pointer;
  }

  .email-list-item:last-child {
    border-bottom: none;
  }

  .email-list-header {
    display: grid;
    grid-template-columns: 250px 1fr 80px 140px;
    gap: 12px;
    padding: 10px 12px;
    border-bottom: 2px solid rgba(255,255,255,0.08);
    background: rgba(255,255,255,0.02);
    margin-bottom: 5px;
  }

  .email-list-header > div {
    color: #9ca3af;
    font-weight: 600;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .email-from {
    color: #ffffff;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 250px;
  }

  .email-subject {
    color: #d1d5db;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    min-width: 0;
  }

  .email-status {
    justify-self: center;
    text-align: center;
    width: 80px;
  }

  /* Consistent status badge styling */
  .email-status .status-badge {
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border: 1px solid;
    display: inline-block;
  }

  .email-time {
    color: #9ca3af;
    font-size: 0.85rem;
    white-space: nowrap;
    text-align: right;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 140px;
  }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #9ca3af;
  }

  .empty-state i {
    font-size: 3rem;
    color: #6b7280;
    margin-bottom: 15px;
  }

  /* Reduce header spacing */
  .page-header {
    margin-bottom: 15px !important;
  }

  /* Responsive adjustments for smaller screens */
  @media (max-width: 768px) {
    .email-list-header,
    .email-list-item {
      grid-template-columns: 180px 1fr 70px 100px;
      gap: 10px;
      padding: 10px;
    }

    .email-from {
      max-width: 180px;
    }

    .email-status {
      width: 70px;
    }

    .email-time {
      max-width: 100px;
      font-size: 0.8rem;
    }
  }

  @media (max-width: 576px) {
    .email-list-header,
    .email-list-item {
      grid-template-columns: 150px 1fr 65px;
      gap: 8px;
    }

    .email-list-header > div:last-child,
    .email-time {
      display: none;
    }

    .email-from {
      max-width: 150px;
    }

    .email-status {
      width: 65px;
    }

    .stat-value {
      font-size: 1.5rem;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <h1><i class="bi bi-speedometer2"></i> Dashboard</h1>
    <p class="text-muted mb-0">Track email activity and manage your monitored accounts.</p>
  </div>
  <div class="header-actions">
    <button class="btn btn-secondary btn-sm" type="button" onclick="location.reload()">
      <i class="bi bi-arrow-clockwise"></i> Refresh
    </button>
  </div>
</div>

<div class="account-selector">
  <div style="display: flex; gap: 10px; align-items: center;">
    <label class="form-label" style="margin: 0; flex-shrink: 0;">Filter by account:</label>
    <select class="form-select" id="accountSelector" onchange="switchAccount(this.value)" style="flex: 1; max-width: 600px;">
      <option value="">All accounts</option>
      {% for account in accounts %}
      <option value="{{ account.id }}" {% if selected_account_id == account.id|string %}selected{% endif %}>
        {{ account.account_name }} - {{ account.email_address }}
      </option>
      {% endfor %}
    </select>

    {% if selected_account_id %}
      {% for account in accounts %}
        {% if account.id|string == selected_account_id %}
        <span class="status-indicator {% if account.is_active %}success{% else %}danger{% endif %}">
          {% if account.is_active %}Active{% else %}Inactive{% endif %}
        </span>
        {% endif %}
      {% endfor %}
    {% endif %}

    <a href="{{ url_for('accounts.email_accounts') }}" class="btn btn-ghost btn-sm">
      <i class="bi bi-gear"></i> Manage
    </a>
  </div>
</div>

<!-- Compact Stats Grid -->
<div class="stats-grid" id="statsGrid">
  <div class="stat-card">
    <span class="stat-value" id="statTotal">{{ stats.total|default(0) }}</span>
    <span class="stat-label">Total</span>
  </div>
  <div class="stat-card held">
    <span class="stat-value" id="statHeld">{{ (stats.held|default(0)) + (stats.pending|default(0)) }}</span>
    <span class="stat-label">Held</span>
  </div>
  <div class="stat-card released">
    <span class="stat-value" id="statReleased">{{ stats.released|default(0) }}</span>
    <span class="stat-label">Released</span>
  </div>
</div>

<!-- Recent Emails -->
<div class="recent-emails-panel">
  <div class="panel-title">
    <span><i class="bi bi-envelope"></i> Recent Emails</span>
    <a href="{{ url_for('emails.emails_unified') }}" class="btn btn-ghost btn-sm">
      View All <i class="bi bi-arrow-right"></i>
    </a>
  </div>

  <div id="emailsList">
    <!-- Column Headers -->
    <div class="email-list-header">
      <div>From</div>
      <div>Subject</div>
      <div style="text-align: center;">Status</div>
      <div style="text-align: right;">Time</div>
    </div>

    {% if recent_emails %}
      {% for email in recent_emails[:20] %}
      <div class="email-list-item" onclick="window.location.href='/email/{{ email.id }}'">
        <div class="email-from">{{ email.sender[:35] }}{% if email.sender|length > 35 %}...{% endif %}</div>
        <div class="email-subject">{{ email.subject[:50] }}{% if email.subject|length > 50 %}...{% endif %}</div>
        <div class="email-status">
          {% set status = (email.status or '').lower() %}
          {% if status == 'pending' or status == 'held' %}
          <span class="status-badge status-HELD">Held</span>
          {% elif status == 'released' or status == 'approved' or status == 'delivered' %}
          <span class="status-badge status-RELEASED">Released</span>
          {% elif status == 'rejected' or status == 'discarded' %}
          <span class="status-badge status-REJECTED">Rejected</span>
          {% else %}
          <span class="status-badge">{{ email.status }}</span>
          {% endif %}
        </div>
        <div class="email-time">{{ email.created_at }}</div>
      </div>
      {% endfor %}
    {% else %}
      <div class="empty-state">
        <i class="bi bi-envelope-open"></i>
        <p>No emails to display</p>
        <a href="{{ url_for('compose.compose_email') }}" class="btn btn-secondary btn-sm">
          <i class="bi bi-envelope-plus"></i> Compose Email
        </a>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentAccountId = '{{ selected_account_id or "" }}';

function switchAccount(accountId) {
  currentAccountId = accountId;
  const searchParams = accountId ? '?account_id=' + accountId : '';
  window.location.href = `/dashboard${searchParams}`;
}

// Load stats with account filtering
async function loadStats() {
  try {
    let url = '/api/unified-stats';
    if (currentAccountId) {
      url += '?account_id=' + currentAccountId;
    }

    const response = await fetch(url);
    if (!response.ok) return;

    const data = await response.json();

    document.getElementById('statTotal').textContent = data.total || 0;
    // Combine pending and held into single "Held" stat
    const heldTotal = (data.held || 0) + (data.pending || 0);
    document.getElementById('statHeld').textContent = heldTotal;
    document.getElementById('statReleased').textContent = data.released || 0;
  } catch (error) {
    console.error('Error loading stats:', error);
  }
}

// Load recent emails with account filtering
async function loadRecentEmails() {
  try {
    let url = '/api/inbox';
    const params = new URLSearchParams();
    if (currentAccountId) {
      params.append('account_id', currentAccountId);
    }
    params.append('limit', '20');

    const response = await fetch(url + '?' + params.toString());
    if (!response.ok) return;

    const data = await response.json();
    const emails = data.messages || [];

    const container = document.getElementById('emailsList');

    if (emails.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="bi bi-envelope-open"></i>
          <p>No emails to display</p>
          <a href="/compose" class="btn btn-secondary btn-sm">
            <i class="bi bi-envelope-plus"></i> Compose Email
          </a>
        </div>
      `;
      return;
    }

    // Clear and rebuild the container
    container.innerHTML = '';

    // Add header row
    const headerDiv = document.createElement('div');
    headerDiv.className = 'email-list-header';
    headerDiv.innerHTML = `
      <div>From</div>
      <div>Subject</div>
      <div style="text-align: center;">Status</div>
      <div style="text-align: right;">Time</div>
    `;
    container.appendChild(headerDiv);

    emails.slice(0, 20).forEach(email => {
      const status = (email.status || email.interception_status || '').toLowerCase();
      const sender = email.sender || 'Unknown';
      const subject = email.subject || '(No Subject)';
      const time = email.created_at || '';

      // Create element using DOM methods for reliable construction
      const emailDiv = document.createElement('div');
      emailDiv.className = 'email-list-item';
      emailDiv.onclick = () => window.location.href = `/email/${email.id}`;

      // Create sender column
      const senderDiv = document.createElement('div');
      senderDiv.className = 'email-from';
      senderDiv.textContent = sender.substring(0, 35) + (sender.length > 35 ? '...' : '');

      // Create subject column
      const subjectDiv = document.createElement('div');
      subjectDiv.className = 'email-subject';
      subjectDiv.textContent = subject.substring(0, 50) + (subject.length > 50 ? '...' : '');

      // Create status column with badge - Consolidate PENDING and HELD
      const statusDiv = document.createElement('div');
      statusDiv.className = 'email-status';

      const statusBadge = document.createElement('span');
      if (status === 'pending' || status === 'held') {
        statusBadge.className = 'status-badge status-HELD';
        statusBadge.textContent = 'Held';
      } else if (status === 'released' || status === 'approved' || status === 'delivered') {
        statusBadge.className = 'status-badge status-RELEASED';
        statusBadge.textContent = 'Released';
      } else if (status === 'rejected' || status === 'discarded') {
        statusBadge.className = 'status-badge status-REJECTED';
        statusBadge.textContent = 'Rejected';
      } else {
        statusBadge.className = 'status-badge';
        statusBadge.textContent = email.status || 'Unknown';
      }
      statusDiv.appendChild(statusBadge);

      // Create time column
      const timeDiv = document.createElement('div');
      timeDiv.className = 'email-time';
      timeDiv.textContent = time;

      // Append all columns to the row
      emailDiv.appendChild(senderDiv);
      emailDiv.appendChild(subjectDiv);
      emailDiv.appendChild(statusDiv);
      emailDiv.appendChild(timeDiv);

      container.appendChild(emailDiv);
    });
  } catch (error) {
    console.error('Error loading emails:', error);
  }
}

// Initialize and set up auto-refresh
loadStats();
loadRecentEmails();

// Auto-refresh every 30 seconds
setInterval(() => {
  loadStats();
  loadRecentEmails();
}, 30000);

// Try to use SSE for real-time updates
try {
  const eventSource = new EventSource('/stream/stats');

  eventSource.onmessage = (event) => {
    try {
      const data = JSON.parse(event.data);

      // Only update if it matches our current filter
      if (!currentAccountId || data.account_id === currentAccountId) {
        document.getElementById('statTotal').textContent = data.total || 0;
        // Combine pending and held
        const heldTotal = (data.held || 0) + (data.pending || 0);
        document.getElementById('statHeld').textContent = heldTotal;
        document.getElementById('statReleased').textContent = data.released || 0;
      }
    } catch (err) {
      console.warn('SSE parse error:', err);
    }
  };

  eventSource.onerror = () => {
    eventSource.close();
    // Fall back to polling
  };
} catch (error) {
  console.warn('SSE not supported, using polling');
}
</script>
{% endblock %}