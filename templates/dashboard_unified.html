{% extends "base.html" %}
{% import 'partials/account_components.html' as account_ui %}
{% import 'partials/rule_components.html' as rule_ui %}

{% block title %}Unified Dashboard - Email Management Tool{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <h1><i class="bi bi-speedometer2"></i> Unified Dashboard</h1>
    <p class="text-muted mb-0">Track interception throughput, account health, and moderation rules from a single view.</p>
  </div>
  <div class="header-actions">
    <button class="btn btn-secondary btn-sm" type="button" onclick="location.reload()">
      <i class="bi bi-arrow-clockwise"></i> Refresh
    </button>
  </div>
</div>

<div class="panel mb-4">
  <div class="panel-header">
    <div class="panel-title"><i class="bi bi-diagram-3"></i> Scope</div>
    <div class="panel-actions">
      <a href="{{ url_for('accounts.email_accounts') }}" class="btn btn-ghost btn-sm">
        <i class="bi bi-envelope-at"></i> Manage Accounts
      </a>
    </div>
  </div>
  <div class="panel-body">
    <div class="row g-3 align-items-end">
      <div class="col-md-6">
        <label for="accountSelector" class="form-label">Filter by account</label>
        <select class="form-select" id="accountSelector" onchange="switchAccount(this.value)">
          <option value="">All accounts (overview)</option>
          {% for account in accounts %}
          <option value="{{ account.id }}" {% if selected_account_id == account.id|string %}selected{% endif %}>
            {{ account.account_name }} ({{ account.email_address }})
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-6">
        {% if selected_account_id %}
          {% for account in accounts %}
            {% if account.id|string == selected_account_id %}
            <div class="d-flex flex-column gap-2">
              <span class="status-indicator {% if account.is_active %}success{% else %}danger{% endif %}">
                {% if account.is_active %}Active{% else %}Inactive{% endif %}
              </span>
              <span class="text-muted small">Last checked: {{ account.last_checked or 'Never' }}</span>
            </div>
            {% endif %}
          {% endfor %}
        {% else %}
        <div class="panel-note">
          Showing aggregated telemetry across all active mailboxes.
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<nav class="nav-tabs-unified mb-4">
  <a class="nav-tab-unified {% if active_tab == 'overview' %}active{% endif %}"
     href="{{ url_for('dashboard.dashboard', tab='overview') }}{% if selected_account_id %}?account_id={{ selected_account_id }}{% endif %}">
    <i class="bi bi-grid-3x3-gap"></i> Overview
  </a>
  <a class="nav-tab-unified {% if active_tab == 'emails' %}active{% endif %}"
     href="{{ url_for('dashboard.dashboard', tab='emails') }}{% if selected_account_id %}?account_id={{ selected_account_id }}{% endif %}">
    <i class="bi bi-envelope"></i> Emails
    {% if stats.pending > 0 %}
    <span class="badge badge-soft-danger">{{ stats.pending }}</span>
    {% endif %}
  </a>
  <a class="nav-tab-unified {% if active_tab == 'accounts' %}active{% endif %}"
     href="{{ url_for('dashboard.dashboard', tab='accounts') }}">
    <i class="bi bi-person-lines-fill"></i> Accounts
  </a>
  <a class="nav-tab-unified {% if active_tab == 'diagnostics' %}active{% endif %}"
     href="{{ url_for('dashboard.dashboard', tab='diagnostics') }}{% if selected_account_id %}?account_id={{ selected_account_id }}{% endif %}">
    <i class="bi bi-heart-pulse"></i> Diagnostics
  </a>
  <a class="nav-tab-unified {% if active_tab == 'rules' %}active{% endif %}"
     href="{{ url_for('dashboard.dashboard', tab='rules') }}{% if selected_account_id %}?account_id={{ selected_account_id }}{% endif %}">
    <i class="bi bi-shield-check"></i> Rules
  </a>
</nav>

{% if active_tab == 'overview' %}
<section class="cards-grid" id="statsGrid">
  <div class="stat-card-modern">
    <span class="stat-label">Total Messages</span>
    <span class="stat-value" id="statTotal">--</span>
    <span class="stat-delta text-muted small">Captured within the selected scope</span>
  </div>
  <div class="stat-card-modern">
    <span class="stat-label">Pending Review</span>
    <span class="stat-value" id="statPending">--</span>
    <span class="stat-delta text-muted small">Held for analyst action</span>
  </div>
  <div class="stat-card-modern">
    <span class="stat-label">Held Messages</span>
    <span class="stat-value" id="statHeld">--</span>
    <span class="stat-delta text-muted small">Quarantined in the last 24h</span>
  </div>
  <div class="stat-card-modern">
    <span class="stat-label">Released</span>
    <span class="stat-value" id="statReleased">--</span>
    <span class="stat-delta text-muted small">Delivered after review</span>
  </div>
</section>

<div class="panel">
  <div class="panel-header">
    <div class="panel-title"><i class="bi bi-map"></i> Workflow Shortcuts</div>
    <div class="panel-actions">
      <span class="status-indicator info">Active Rules: {{ active_rules }}</span>
    </div>
  </div>
  <div class="panel-body">
    <div class="btn-group-unified mb-3">
      <a href="{{ url_for('emails.emails_unified') }}" class="btn btn-secondary btn-sm">
        <i class="bi bi-inbox"></i> Review Queue
      </a>
      <a href="{{ url_for('compose.compose_email') }}" class="btn btn-ghost btn-sm">
        <i class="bi bi-envelope-plus"></i> Compose
      </a>
      <a href="{{ url_for('diagnostics') }}" class="btn btn-ghost btn-sm">
        <i class="bi bi-heart-pulse"></i> Diagnostics
      </a>
      <a href="{{ url_for('moderation.rules') }}" class="btn btn-ghost btn-sm">
        <i class="bi bi-sliders"></i> Manage Rules
      </a>
    </div>
    <p class="panel-note mb-0">Counts update in real time via server-sent events. Use the shortcuts above to dive deeper into each workflow.</p>
  </div>
</div>

{% elif active_tab == 'emails' %}
<div class="panel">
  <div class="panel-header">
    <div class="panel-title"><i class="bi bi-envelope"></i> Recent Emails</div>
    <div class="panel-actions">
      <a href="{{ url_for('emails.emails_unified') }}" class="btn btn-secondary btn-sm">
        <i class="bi bi-box-arrow-up-right"></i> Open full queue
      </a>
    </div>
  </div>
  <div class="panel-body p-0">
    <div class="table-toolbar">
      <div class="bulk-actions">
        <span class="text-muted small">Latency</span>
        <span class="text-muted small" id="latencyBucket">—</span>
      </div>
      <div class="bulk-actions">
        <div class="input-group input-group-sm">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input type="search" class="form-control" placeholder="Quick filter (subject, from, to)" aria-label="Filter recent emails">
        </div>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead>
          <tr>
            <th>From</th>
            <th>To</th>
            <th>Subject</th>
            <th>Status</th>
            <th>Time</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for email in recent_emails %}
          <tr>
            <td class="truncate-inline">{{ email.sender }}</td>
            <td class="truncate-inline">{{ email.recipients }}</td>
            <td class="truncate-inline">{{ email.subject[:80] }}{% if email.subject|length > 80 %}…{% endif %}</td>
            <td>
              {% set status = (email.status or '').lower() %}
              {% if status == 'pending' %}
              <span class="status-indicator warning">{{ email.status }}</span>
              {% elif status == 'held' %}
              <span class="status-indicator danger">{{ email.status }}</span>
              {% elif status == 'released' %}
              <span class="status-indicator success">{{ email.status }}</span>
              {% else %}
              <span class="status-indicator info">{{ email.status }}</span>
              {% endif %}
            </td>
            <td class="text-muted small">{{ email.created_at }}</td>
            <td class="text-end">
              <a href="{{ url_for('emails.view_email', email_id=email.id) }}" class="btn btn-ghost btn-sm">
                <i class="bi bi-eye"></i> View
              </a>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="6" class="table-empty-cell">
              <div class="empty-state-unified">
                <i class="bi bi-envelope-open"></i>
                <div class="empty-title">No email traffic yet</div>
                <div class="empty-description">
                  <a href="{{ url_for('compose.compose_email') }}" class="text-accent">Compose your first message</a> or connect an account to start capturing mail.
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="table-toolbar table-toolbar-bottom">
      <div class="bulk-actions">
        <span class="text-muted small">Showing {{ recent_emails|length }} results</span>
      </div>
      <div class="bulk-actions">
        <button class="btn btn-ghost btn-sm" type="button" onclick="loadUnifiedStats()">
          <i class="bi bi-arrow-repeat"></i> Refresh counts
        </button>
      </div>
    </div>
  </div>
</div>

{% elif active_tab == 'accounts' %}
<div class="panel mb-3">
  <div class="panel-header">
    <div class="panel-title"><i class="bi bi-envelope-at"></i> Email Accounts</div>
    <div class="panel-actions">
      <a href="{{ url_for('accounts.add_email_account') }}" class="btn btn-secondary btn-sm">
        <i class="bi bi-plus-circle"></i> Add Account
      </a>
      <a href="{{ url_for('accounts.accounts_import_page') }}" class="btn btn-ghost btn-sm">
        <i class="bi bi-cloud-upload"></i> Import
      </a>
    </div>
  </div>
</div>
{{ account_ui.account_cards(accounts) }}
{{ account_ui.account_modals() }}

{% elif active_tab == 'diagnostics' %}
<div class="panel">
  <div class="panel-header">
    <div class="panel-title"><i class="bi bi-heart-pulse"></i> Diagnostics</div>
    <div class="panel-actions">
      {% if selected_account_id %}
      <button class="btn btn-secondary btn-sm" type="button" onclick="runDiagnostics('{{ selected_account_id }}')">
        <i class="bi bi-activity"></i> Run Diagnostics
      </button>
      {% endif %}
      <a href="{{ url_for('diagnostics') }}" class="btn btn-ghost btn-sm">
        <i class="bi bi-box-arrow-up-right"></i> Full diagnostics
      </a>
    </div>
  </div>
  <div class="panel-body">
    {% if selected_account_id %}
    <div id="diagnosticsResults" class="table-modern">
      <div class="loading-state-unified">
        <div class="loading-spinner-unified"></div>
        <span>Fetching diagnostics…</span>
      </div>
    </div>
    {% else %}
    <div class="empty-state-unified">
      <i class="bi bi-arrow-down-circle"></i>
      <div class="empty-title">Select an account</div>
      <div class="empty-description">Choose an account to run SMTP and IMAP self checks.</div>
    </div>
    {% endif %}
  </div>
</div>

{% elif active_tab == 'rules' %}
<div class="panel">
  <div class="panel-header">
    <div class="panel-title"><i class="bi bi-shield-check"></i> Moderation Rules</div>
    <div class="panel-actions">
      <span class="status-indicator info">Active: {{ active_rules }}</span>
      <a href="{{ url_for('moderation.rules') }}" class="btn btn-secondary btn-sm">
        <i class="bi bi-box-arrow-up-right"></i> Manage Rules
      </a>
    </div>
  </div>
  <div class="panel-body">
    <p class="text-muted mb-0">Rules execute from highest to lowest priority. Use the dedicated Rules screen to edit thresholds and actions.</p>
  </div>
  {{ rule_ui.rules_table(rules, show_actions=False) }}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
function switchAccount(accountId) {
  const currentTab = '{{ active_tab }}';
  const searchParams = accountId ? '?account_id=' + accountId : '';
  window.location.href = `/dashboard/${currentTab}${searchParams}`;
}

let useSSE = true;

function applyStats(payload) {
  const mapValue = (id, value) => {
    const node = document.getElementById(id);
    if (node) node.textContent = value;
  };
  const data = (payload.unified) ? payload.unified : payload;
  mapValue('statTotal', data.total ?? 0);
  mapValue('statPending', data.pending ?? 0);
  mapValue('statHeld', data.held ?? 0);
  mapValue('statReleased', data.released ?? 0);

  if (payload.latency) {
    const latencyNode = document.getElementById('latencyBucket');
    if (latencyNode) {
      const latency = payload.latency;
      latencyNode.textContent = latency.count
        ? `${latency.p50}ms p50 • ${latency.p95}ms p95 • ${latency.max}ms max`
        : '—';
    }
  }
}

async function loadUnifiedStats() {
  try {
    const [unifiedResponse, latencyResponse] = await Promise.all([
      fetch('/api/unified-stats'),
      fetch('/api/latency-stats')
    ]);
    if (!unifiedResponse.ok) return;
    const unified = await unifiedResponse.json();
    const latency = latencyResponse.ok ? await latencyResponse.json() : null;
    applyStats({ unified, latency });
  } catch (error) {
    console.warn('Stats fetch failed', error);
  }
}

function startSSE() {
  try {
    const stream = new EventSource('/stream/stats');
    stream.onmessage = (event) => {
      try {
        applyStats(JSON.parse(event.data));
      } catch (err) {
        console.warn('SSE parse error', err);
      }
    };
    stream.onerror = () => {
      stream.close();
      useSSE = false;
      setInterval(loadUnifiedStats, 10000);
    };
  } catch (error) {
    console.warn('SSE start failed', error);
    useSSE = false;
    setInterval(loadUnifiedStats, 10000);
  }
}

if (document.getElementById('statsGrid')) {
  startSSE();
  if (!useSSE) {
    loadUnifiedStats();
  }
}

function runDiagnostics(accountId) {
  const resultsDiv = document.getElementById('diagnosticsResults');
  if (!resultsDiv) return;
  resultsDiv.innerHTML = '<div class="loading-state-unified"><div class="loading-spinner-unified"></div><span>Running diagnostics…</span></div>';

  fetch(`/api/diagnostics/${accountId}`)
    .then((response) => response.json())
    .then((data) => {
      let html = '';
      html += `<div class="alert ${data.smtp_test.success ? 'alert-success' : 'alert-danger'}"><strong>SMTP:</strong> ${data.smtp_test.message}</div>`;
      html += `<div class="alert ${data.imap_test.success ? 'alert-success' : 'alert-danger'}"><strong>IMAP:</strong> ${data.imap_test.message}</div>`;
      resultsDiv.innerHTML = html;
    })
    .catch((error) => {
      resultsDiv.innerHTML = `<div class="alert alert-danger">Error running diagnostics: ${error}</div>`;
    });
}

function testAccount(accountId) {
  if (window.showInfo) showInfo('Testing account ' + accountId);
  fetch('/api/accounts/' + accountId + '/test', { method: 'POST' })
    .then((response) => response.json())
    .then((data) => {
      if (data && data.success) {
        if (window.showSuccess) showSuccess('Account test successful');
      } else {
        const message = (data && (data.error || (data.smtp && data.smtp.message) || (data.imap && data.imap.message))) || 'Test failed';
        if (window.showError) showError('Account test failed: ' + message);
      }
    })
    .catch((error) => {
      if (window.showError) showError('Error testing account: ' + error.message);
    });
}

function editAccount(accountId) {
  window.location.href = `/accounts?edit=${accountId}`;
}
</script>
{% endblock %}