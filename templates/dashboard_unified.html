{% extends "base.html" %}
{% import 'partials/account_components.html' as account_ui %}
{% import 'partials/rule_components.html' as rule_ui %}

{% block title %}Dashboard - Email Management Tool{% endblock %}

{% block extra_css %}
<style>
  /* Compact account selector */
  .account-selector {
    background: rgba(26,26,26,0.9);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px -1px rgba(0,0,0,.6),0 1px 2px rgba(0,0,0,.4);
    border: 1px solid rgba(255,255,255,0.06);
  }

  .account-selector .selector-grid {
    display: grid;
    grid-template-columns: minmax(260px, 2fr) auto;
    grid-template-areas:
      "select actions"
      "meta meta";
    column-gap: 20px;
    row-gap: 14px;
    align-items: center;
  }

  .selector-field {
    grid-area: select;
  }

  .selector-field label {
    color: #9ca3af;
    font-weight: 500;
    margin-bottom: 6px;
    display: block;
    font-size: 0.85rem;
  }

  .selector-field select {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.12);
    color: #ffffff;
    width: 100%;
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 0.95rem;
  }

  .selector-field select option {
    background: #1a1a1a;
    color: #ffffff;
  }

  .selector-meta {
    grid-area: meta;
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
  }

  .selector-meta .selector-note {
    color: #9ca3af;
    font-size: 0.85rem;
    flex: 1 1 auto;
  }

  .selector-actions {
    grid-area: actions;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    justify-content: flex-end;
    gap: 6px;
  }

  .selector-actions .btn {
    min-width: 110px;
    justify-content: center;
  }

  .selector-actions label {
    color: #9ca3af;
    font-weight: 500;
    font-size: 0.85rem;
    margin: 0;
  }

  @media (max-width: 992px) {
    .account-selector .selector-grid {
      grid-template-columns: 1fr;
      grid-template-areas:
        "select"
        "meta"
        "actions";
      grid-template-columns: 1fr;
      align-items: stretch;
    }

    .selector-actions {
      justify-content: flex-start;
      align-items: flex-start;
      flex-direction: row;
      gap: 10px;
    }

    .selector-actions label {
      display: none;
    }
  }

  .stat-card {
    background: linear-gradient(145deg, #1a1a1a 0%, #1f1f1f 60%, #242424 100%);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 12px;
    padding: 15px;
    text-align: center;
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }

  .stat-value {
    font-size: 1.8rem;
    font-weight: 700;
    color: #ffffff;
    display: block;
    line-height: 1;
  }

  .stat-label {
    font-size: 0.75rem;
    color: #9ca3af;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 5px;
    display: block;
  }

  .stat-card.held .stat-value {
    color: #f87171;
  }

  .stat-card.released .stat-value {
    color: #34d399;
  }

  /* Recent emails section */
  .recent-emails-panel {
    background: linear-gradient(145deg, #1a1a1a 0%, #1f1f1f 60%, #242424 100%);
    border-radius: 18px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.6);
    border: 1px solid rgba(255,255,255,0.06);
  }

  #emailsList {
    max-height: 600px;
    overflow-y: auto;
    overflow-x: hidden;
    display: block;
    width: 100%;
  }

  #emailsList::-webkit-scrollbar {
    width: 8px;
  }

  #emailsList::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.03);
    border-radius: 4px;
  }

  #emailsList::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.15);
    border-radius: 4px;
  }

  #emailsList::-webkit-scrollbar-thumb:hover {
    background: rgba(255,255,255,0.25);
  }

  .panel-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #ffffff;
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .email-list-item {
    display: grid;
    grid-template-columns: 280px 1fr 110px 150px;
    align-items: center;
    padding: 14px;
    border-bottom: 1px solid rgba(255,255,255,0.06);
    transition: background 0.2s;
    gap: 18px;
    width: 100%;
    box-sizing: border-box;
    min-height: 64px;
    max-width: 100%;
    overflow: hidden;
  }

  .email-list-item:hover {
    background: rgba(255,255,255,0.03);
    cursor: pointer;
  }

  .email-list-item:last-child {
    border-bottom: none;
  }

  .email-list-header {
    display: grid;
    grid-template-columns: 280px 1fr 110px 150px;
    gap: 18px;
    padding: 12px 14px;
    border-bottom: 2px solid rgba(255,255,255,0.08);
    background: rgba(255,255,255,0.02);
    margin-bottom: 6px;
  }

  .email-list-header > div {
    color: #9ca3af;
    font-weight: 600;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .email-correspondents {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .correspondent-line {
    display: flex;
    gap: 8px;
    align-items: baseline;
  }

  .correspondent-label {
    font-size: 0.7rem;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: #9ca3af;
    font-weight: 600;
    flex-shrink: 0;
    min-width: 42px;
  }

  .correspondent-value {
    color: #e5e7eb;
    font-size: 0.85rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1 1 auto;
    min-width: 0;
  }

  .email-subject {
    color: #d1d5db;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    min-width: 0;
  }

  .email-status {
    justify-self: center;
    text-align: center;
    width: 110px;
  }

  /* Consistent status badge styling */
  .email-status .status-badge {
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border: 1px solid;
    display: inline-block;
  }

  .email-time {
    color: #9ca3af;
    font-size: 0.9rem;
    white-space: nowrap;
    text-align: right;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 150px;
  }

  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #9ca3af;
  }

  .empty-state i {
    font-size: 3rem;
    color: #6b7280;
    margin-bottom: 15px;
  }

  /* Reduce header spacing */
  .page-header {
    margin-bottom: 15px !important;
  }

  /* Responsive adjustments for smaller screens */
  @media (max-width: 768px) {
    .email-list-header,
    .email-list-item {
      grid-template-columns: 1.2fr 1fr 90px 120px;
      gap: 14px;
      padding: 12px;
    }

    .correspondent-value {
      max-width: 220px;
    }

    .email-status {
      width: 90px;
    }

    .email-time {
      max-width: 120px;
      font-size: 0.82rem;
    }
  }

  @media (max-width: 576px) {
    .email-list-header,
    .email-list-item {
      grid-template-columns: minmax(0, 1fr) 1fr 75px;
      gap: 10px;
      padding: 10px;
    }

    .email-list-header > div:last-child,
    .email-time {
      display: none;
    }

    .email-status {
      width: 75px;
    }

    .correspondent-label {
      min-width: 38px;
    }

  }

</style>
{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <h1><i class="bi bi-speedometer2"></i> Dashboard</h1>
    <p class="text-muted mb-0">Track email activity and manage your monitored accounts.</p>
  </div>
  <div class="header-actions">
    <button class="btn btn-secondary btn-sm" type="button" onclick="location.reload()">
      <i class="bi bi-arrow-clockwise"></i> Refresh
    </button>
  </div>
</div>

<div class="account-selector">
  <div class="selector-grid">
    <div class="selector-field">
      <label for="accountSelector">Filter by account</label>
      <select class="form-select" id="accountSelector" onchange="switchAccount(this.value)">
        <option value="">All accounts</option>
        {% for account in accounts %}
        <option value="{{ account.id }}" {% if selected_account_id == account.id|string %}selected{% endif %}>
          {{ account.account_name }} ({{ account.email_address }})
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="selector-meta">
      {% if selected_account_id %}
        {% for account in accounts %}
          {% if account.id|string == selected_account_id %}
          <span class="tag-chip {% if account.is_active %}success{% else %}accent{% endif %}">
            {% if account.is_active %}Active{% else %}Inactive{% endif %}
          </span>
          {% if account.last_checked %}
          <span class="selector-note">
            Last checked: <span class="time-cell" data-ts="{{ account.last_checked }}">{{ account.last_checked }}</span>
          </span>
          {% else %}
          <span class="selector-note">Last checked: Never</span>
          {% endif %}
          {% endif %}
        {% endfor %}
      {% else %}
        <span class="selector-note">Showing aggregated telemetry across all monitored accounts.</span>
      {% endif %}
    </div>

    <div class="selector-actions">
      <label class="form-label">Actions</label>
      <a href="{{ url_for('accounts.email_accounts') }}" class="btn btn-ghost btn-sm">
        <i class="bi bi-gear"></i> Manage
      </a>
    </div>
  </div>
</div>

{% set totals = namespace(value = stats.total if stats.total is not none else 0, held = 0, released = 0) %}
{% set totals.held = (stats.held|default(0)) + (stats.pending|default(0)) %}
{% set totals.released = (stats.released|default(0)) + (stats.approved|default(0)) + (stats.delivered|default(0)) %}
{% if totals.value == 0 %}
  {% set totals.value = totals.held + totals.released + (stats.rejected|default(0)) + (stats.discarded|default(0)) %}
{% endif %}

<!-- Compact Stats Grid -->
<div class="stats-grid" id="statsGrid">
  <div class="stat-card-modern">
    <span class="stat-value" id="statTotal">{{ totals.value }}</span>
    <span class="stat-label">Total</span>
  </div>
  <div class="stat-card-modern held">
    <span class="stat-value" id="statHeld">{{ totals.held }}</span>
    <span class="stat-label">Held</span>
  </div>
  <div class="stat-card-modern released">
    <span class="stat-value" id="statReleased">{{ totals.released }}</span>
    <span class="stat-label">Released</span>
  </div>
</div>

<!-- Recent Emails -->
<div class="recent-emails-panel">
  <div class="panel-title">
    <span><i class="bi bi-envelope"></i> Recent Emails</span>
    <a href="{{ url_for('emails.emails_unified') }}" class="btn btn-ghost btn-sm">
      View All <i class="bi bi-arrow-right"></i>
    </a>
  </div>

  <div id="emailsList">
    <!-- Column Headers -->
      <div class="email-list-header">
        <div>Correspondents</div>
        <div>Subject</div>
        <div style="text-align: center;">Status</div>
        <div style="text-align: right;">Time</div>
      </div>

      {% if recent_emails %}
        {% for email in recent_emails[:20] %}
        {% set sender_text = email.sender or '—' %}
        {% set recipients = email.recipients %}
        {% set recipient_text = '—' %}
        {% if recipients %}
          {% if recipients is string %}
            {% set recipient_text = recipients %}
          {% else %}
            {% set recipient_text = recipients|join(', ') %}
          {% endif %}
        {% endif %}
        <div class="email-list-item" onclick="window.location.href='/email/{{ email.id }}'">
          <div class="email-correspondents">
            <div class="correspondent-line">
              <span class="correspondent-label">From</span>
              <span class="correspondent-value">{{ sender_text[:42] }}{% if sender_text|length > 42 %}...{% endif %}</span>
            </div>
            <div class="correspondent-line">
              <span class="correspondent-label">To</span>
              <span class="correspondent-value">{{ recipient_text[:42] }}{% if recipient_text|length > 42 %}...{% endif %}</span>
            </div>
          </div>
          <div class="email-subject">{{ email.subject[:60] }}{% if email.subject|length > 60 %}...{% endif %}</div>
          <div class="email-status">
            {% set status = (email.status or '').lower() %}
            {% if status == 'pending' or status == 'held' %}
            <span class="status-badge status-HELD">Held</span>
            {% elif status == 'released' or status == 'approved' or status == 'delivered' %}
          <span class="status-badge status-RELEASED">Released</span>
          {% elif status == 'rejected' or status == 'discarded' %}
          <span class="status-badge status-REJECTED">Rejected</span>
          {% else %}
          <span class="status-badge">{{ email.status }}</span>
          {% endif %}
        </div>
        <div class="email-time"><span class="time-cell" data-ts="{{ email.created_at }}">{{ email.created_at }}</span></div>
      </div>
      {% endfor %}
    {% else %}
      <div class="empty-state">
        <i class="bi bi-envelope-open"></i>
        <p>No emails to display</p>
        <a href="{{ url_for('compose.compose_email') }}" class="btn btn-secondary btn-sm">
          <i class="bi bi-envelope-plus"></i> Compose Email
        </a>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentAccountId = '{{ selected_account_id or "" }}';

function updateStatsFromPayload(payload) {
  if (!payload) return;
  const toNumber = (value) => {
    const parsed = Number(value);
    return Number.isFinite(parsed) ? parsed : 0;
  };

  const heldTotal = toNumber(payload.held) + toNumber(payload.pending);
  const releasedTotal = toNumber(payload.released) + toNumber(payload.approved) + toNumber(payload.delivered);
  const totalCandidate = toNumber(payload.total);
  const rejectedTotal = toNumber(payload.rejected) + toNumber(payload.discarded);
  const totalValue = totalCandidate > 0 ? totalCandidate : heldTotal + releasedTotal + rejectedTotal;

  document.getElementById('statTotal').textContent = totalValue;
  document.getElementById('statHeld').textContent = heldTotal;
  document.getElementById('statReleased').textContent = releasedTotal;
}

function formatTimestamp(ts) {
  if (!ts) return '—';
  const raw = typeof ts === 'string' ? ts.trim() : ts;
  const normalized = (typeof raw === 'string' && raw.includes(' ') && !raw.includes('T'))
    ? raw.replace(' ', 'T')
    : raw;
  const date = new Date(normalized);
  if (Number.isNaN(date.getTime())) return ts;
  return date.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true });
}

function applyTimeFormatting() {
  document.querySelectorAll('.time-cell').forEach(node => {
    const ts = node.dataset.ts || node.textContent;
    if (!ts) {
      node.textContent = '—';
      return;
    }
    node.dataset.ts = ts;
    node.textContent = formatTimestamp(ts);
  });
}

applyTimeFormatting();

function switchAccount(accountId) {
  currentAccountId = accountId;
  const searchParams = accountId ? '?account_id=' + accountId : '';
  window.location.href = `/dashboard${searchParams}`;
}

// Load stats with account filtering
async function loadStats() {
  try {
    let url = '/api/unified-stats';
    if (currentAccountId) {
      url += '?account_id=' + currentAccountId;
    }

    const response = await fetch(url);
    if (!response.ok) return;

    const data = await response.json();
    const payload = data && data.unified ? data.unified : data;
    updateStatsFromPayload(payload || {});
  } catch (error) {
    console.error('Error loading stats:', error);
  }
}

// Load recent emails with account filtering
async function loadRecentEmails() {
  try {
    let url = '/api/inbox';
    const params = new URLSearchParams();
    if (currentAccountId) {
      params.append('account_id', currentAccountId);
    }
    params.append('limit', '20');

    const response = await fetch(url + '?' + params.toString());
    if (!response.ok) return;

    const data = await response.json();
    const emails = data.messages || [];

    const container = document.getElementById('emailsList');

    if (emails.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="bi bi-envelope-open"></i>
          <p>No emails to display</p>
          <a href="/compose" class="btn btn-secondary btn-sm">
            <i class="bi bi-envelope-plus"></i> Compose Email
          </a>
        </div>
      `;
      return;
    }

    // Clear and rebuild the container
    container.innerHTML = '';

    // Add header row
    const headerDiv = document.createElement('div');
    headerDiv.className = 'email-list-header';
    headerDiv.innerHTML = `
      <div>Correspondents</div>
      <div>Subject</div>
      <div style="text-align: center;">Status</div>
      <div style="text-align: right;">Time</div>
    `;
    container.appendChild(headerDiv);

    const truncate = (text, length = 42) => {
      if (!text) return '—';
      const str = String(text);
      return str.length > length ? `${str.slice(0, length)}…` : str;
    };

    emails.slice(0, 20).forEach(email => {
      const status = (email.status || email.interception_status || '').toLowerCase();
      const sender = email.sender || 'Unknown';
      const subject = email.subject || '(No Subject)';
      const time = email.created_at || '';
      const rawRecipients = email.recipients || email.to || email.to_address || email.recipient;
      let recipients = '—';
      if (Array.isArray(rawRecipients) && rawRecipients.length > 0) {
        recipients = rawRecipients.join(', ');
      } else if (typeof rawRecipients === 'string' && rawRecipients.trim() !== '') {
        recipients = rawRecipients;
      }

      const emailDiv = document.createElement('div');
      emailDiv.className = 'email-list-item';
      emailDiv.onclick = () => window.location.href = `/email/${email.id}`;

      const correspondentsDiv = document.createElement('div');
      correspondentsDiv.className = 'email-correspondents';

      const fromLine = document.createElement('div');
      fromLine.className = 'correspondent-line';
      const fromLabel = document.createElement('span');
      fromLabel.className = 'correspondent-label';
      fromLabel.textContent = 'From';
      const fromValue = document.createElement('span');
      fromValue.className = 'correspondent-value';
      fromValue.textContent = truncate(sender, 48);
      fromLine.appendChild(fromLabel);
      fromLine.appendChild(fromValue);

      const toLine = document.createElement('div');
      toLine.className = 'correspondent-line';
      const toLabel = document.createElement('span');
      toLabel.className = 'correspondent-label';
      toLabel.textContent = 'To';
      const toValue = document.createElement('span');
      toValue.className = 'correspondent-value';
      toValue.textContent = truncate(recipients, 48);
      toLine.appendChild(toLabel);
      toLine.appendChild(toValue);

      correspondentsDiv.appendChild(fromLine);
      correspondentsDiv.appendChild(toLine);

      const subjectDiv = document.createElement('div');
      subjectDiv.className = 'email-subject';
      subjectDiv.textContent = truncate(subject, 70);

      const statusDiv = document.createElement('div');
      statusDiv.className = 'email-status';
      const statusBadge = document.createElement('span');
      if (status === 'pending' || status === 'held') {
        statusBadge.className = 'status-badge status-HELD';
        statusBadge.textContent = 'Held';
      } else if (status === 'released' || status === 'approved' || status === 'delivered') {
        statusBadge.className = 'status-badge status-RELEASED';
        statusBadge.textContent = 'Released';
      } else if (status === 'rejected' || status === 'discarded') {
        statusBadge.className = 'status-badge status-REJECTED';
        statusBadge.textContent = 'Rejected';
      } else {
        statusBadge.className = 'status-badge';
        statusBadge.textContent = email.status || 'Unknown';
      }
      statusDiv.appendChild(statusBadge);

      const timeDiv = document.createElement('div');
      timeDiv.className = 'email-time';
      const timeSpan = document.createElement('span');
      timeSpan.className = 'time-cell';
      timeSpan.dataset.ts = time;
      timeSpan.textContent = formatTimestamp(time);
      timeDiv.appendChild(timeSpan);

      emailDiv.appendChild(correspondentsDiv);
      emailDiv.appendChild(subjectDiv);
      emailDiv.appendChild(statusDiv);
      emailDiv.appendChild(timeDiv);

      container.appendChild(emailDiv);
    });
    applyTimeFormatting();
  } catch (error) {
    console.error('Error loading emails:', error);
  }
}

// Initialize and set up auto-refresh
loadStats();
loadRecentEmails();

// Auto-refresh every 30 seconds
setInterval(() => {
  loadStats();
  loadRecentEmails();
}, 30000);

// Try to use SSE for real-time updates
try {
  const eventSource = new EventSource('/stream/stats');

  eventSource.onmessage = (event) => {
    try {
      const raw = JSON.parse(event.data);
      const payload = raw && raw.unified ? raw.unified : raw;
      const targetAccount = raw && raw.account_id !== undefined
        ? String(raw.account_id)
        : (payload && payload.account_id !== undefined ? String(payload.account_id) : null);

      if (!currentAccountId || targetAccount === null || String(currentAccountId) === targetAccount) {
        updateStatsFromPayload(payload || {});
      }
    } catch (err) {
      console.warn('SSE parse error:', err);
    }
  };

  eventSource.onerror = () => {
    eventSource.close();
    // Fall back to polling
  };
} catch (error) {
  console.warn('SSE not supported, using polling');
}
</script>
{% endblock %}


