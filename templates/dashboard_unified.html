{% extends "base.html" %}

{% block title %}Dashboard - Email Management Tool{% endblock %}

{% block extra_css %}
<style>
    .account-selector {
        background: white;
        border-radius: 15px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    }
    
    .nav-tabs {
        border-bottom: 2px solid #e9ecef;
        margin-bottom: 25px;
    }
    
    .nav-tabs .nav-link {
        color: #212529; /* Dark color for excellent contrast */
        border: 2px solid transparent;
        padding: 12px 25px;
        font-weight: 500;
        transition: all 0.3s ease;
        background: white;
        margin-right: 5px;
        border-radius: 10px 10px 0 0;
        position: relative;
    }
    
    .nav-tabs .nav-link:hover {
        color: #212529; /* Keep text dark on hover for readability */
        background: #f8f9fa; /* Light gray background */
        border-color: #667eea; /* Purple border accent */
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.2);
    }
    
    .nav-tabs .nav-link.active {
        color: white;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        font-weight: 600;
        border-color: transparent;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .nav-tabs .nav-link.active:hover {
        color: white; /* Keep white text on active hover */
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }
    
    .nav-tabs .nav-link .badge {
        margin-left: 8px;
        font-size: 0.75rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-speedometer2"></i> Unified Dashboard</h1>
    <button class="btn btn-modern btn-primary-modern" onclick="location.reload()">
        <i class="bi bi-arrow-clockwise"></i> Refresh
    </button>
</div>

<!-- Account Selector -->
<div class="account-selector">
    <div class="row align-items-center">
        <div class="col-md-6">
            <label class="form-label fw-bold">Select Account:</label>
            <select class="form-select" id="accountSelector" onchange="switchAccount(this.value)">
                <option value="">All Accounts (Overview)</option>
                {% for account in accounts %}
                <option value="{{ account.id }}" {% if selected_account_id == account.id|string %}selected{% endif %}>
                    {{ account.account_name }} ({{ account.email_address }})
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6 text-end">
            {% if selected_account_id %}
            {% for account in accounts %}
                {% if account.id|string == selected_account_id %}
                <span class="badge {% if account.is_active %}bg-success{% else %}bg-danger{% endif %}">
                    {% if account.is_active %}Active{% else %}Inactive{% endif %}
                </span>
                <span class="text-muted ms-2">
                    Last checked: {{ account.last_checked or 'Never' }}
                </span>
                {% endif %}
            {% endfor %}
            {% endif %}
        </div>
    </div>
</div>

<!-- Navigation Tabs -->
<ul class="nav nav-tabs" role="tablist">
    <li class="nav-item">
        <a class="nav-link {% if active_tab == 'overview' %}active{% endif %}" 
           href="{{ url_for('dashboard', tab='overview') }}{% if selected_account_id %}?account_id={{ selected_account_id }}{% endif %}">
            <i class="bi bi-grid-3x3-gap"></i> Overview
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if active_tab == 'emails' %}active{% endif %}" 
           href="{{ url_for('dashboard', tab='emails') }}{% if selected_account_id %}?account_id={{ selected_account_id }}{% endif %}">
            <i class="bi bi-envelope"></i> Emails
            {% if stats.pending > 0 %}
            <span class="badge bg-danger">{{ stats.pending }}</span>
            {% endif %}
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if active_tab == 'accounts' %}active{% endif %}" 
           href="{{ url_for('dashboard', tab='accounts') }}">
            <i class="bi bi-person-lines-fill"></i> Accounts
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if active_tab == 'diagnostics' %}active{% endif %}" 
           href="{{ url_for('dashboard', tab='diagnostics') }}{% if selected_account_id %}?account_id={{ selected_account_id }}{% endif %}">
            <i class="bi bi-heart-pulse"></i> Diagnostics
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if active_tab == 'rules' %}active{% endif %}" 
           href="{{ url_for('dashboard', tab='rules') }}">
            <i class="bi bi-shield-check"></i> Rules
        </a>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content">
    {% if active_tab == 'overview' %}
    <!-- Overview Tab -->
    <div class="tab-pane fade show active">
        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stat-number">{{ stats.total }}</div>
                            <div class="stat-label">Total Emails</div>
                        </div>
                        <i class="bi bi-envelope-fill" style="font-size: 2rem; color: #667eea;"></i>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stat-number">{{ stats.pending }}</div>
                            <div class="stat-label">Pending Review</div>
                        </div>
                        <i class="bi bi-clock-fill" style="font-size: 2rem; color: #ffc107;"></i>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stat-number">{{ stats.approved }}</div>
                            <div class="stat-label">Approved</div>
                        </div>
                        <i class="bi bi-check-circle-fill" style="font-size: 2rem; color: #28a745;"></i>
                    </div>
                </div>
            </div>
            
            <div class="col-md-3 mb-3">
                <div class="stat-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="stat-number">{{ stats.rejected }}</div>
                            <div class="stat-label">Rejected</div>
                        </div>
                        <i class="bi bi-x-circle-fill" style="font-size: 2rem; color: #dc3545;"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Emails -->
        <div class="card table-modern">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Emails</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>From</th>
                                <th>To</th>
                                <th>Subject</th>
                                <th>Status</th>
                                <th>Risk</th>
                                <th>Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for email in recent_emails %}
                            <tr>
                                <td>{{ email.sender }}</td>
                                <td>{{ email.recipients }}</td>
                                <td>{{ email.subject[:50] }}{% if email.subject|length > 50 %}...{% endif %}</td>
                                <td>
                                    <span class="badge bg-{% if email.status == 'PENDING' %}warning{% elif email.status == 'APPROVED' %}success{% elif email.status == 'REJECTED' %}danger{% else %}secondary{% endif %}">
                                        {{ email.status }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-{% if email.risk_score >= 80 %}danger{% elif email.risk_score >= 50 %}warning{% else %}success{% endif %}">
                                        {{ email.risk_score }}
                                    </span>
                                </td>
                                <td>{{ email.created_at }}</td>
                                <td>
                                    <a href="/emails/{{ email.id }}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    {% elif active_tab == 'accounts' %}
    <!-- Accounts Tab -->
    <div class="tab-pane fade show active">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>Email Accounts</h4>
            <button class="btn btn-primary" onclick="window.location.href='/accounts/add'">
                <i class="bi bi-plus-circle"></i> Add Account
            </button>
        </div>
        
        <div class="row">
            {% for account in accounts %}
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">{{ account.account_name }}</h5>
                        <p class="card-text">
                            <strong>Email:</strong> {{ account.email_address }}<br>
                            <strong>SMTP:</strong> {{ account.smtp_host }}:{{ account.smtp_port }}<br>
                            <strong>IMAP:</strong> {{ account.imap_host }}:{{ account.imap_port }}<br>
                            <strong>Status:</strong> 
                            <span class="badge {% if account.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                {% if account.is_active %}Active{% else %}Inactive{% endif %}
                            </span>
                        </p>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-primary" onclick="testAccount('{{ account.id }}')">
                                <i class="bi bi-play-circle"></i> Test
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="editAccount('{{ account.id }}')">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <a href="{{ url_for('dashboard', tab='diagnostics') }}?account_id={{ account.id }}" 
                               class="btn btn-sm btn-info">
                                <i class="bi bi-heart-pulse"></i> Diagnostics
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    {% elif active_tab == 'diagnostics' %}
    <!-- Diagnostics Tab -->
    <div class="tab-pane fade show active">
        {% if selected_account_id %}
        <div class="card">
            <div class="card-header">
                <h5>Diagnostics for Account</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary" onclick="runDiagnostics('{{ selected_account_id }}')">
                    <i class="bi bi-play-circle"></i> Run Diagnostics
                </button>
                <div id="diagnosticsResults" class="mt-3"></div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Please select an account from the dropdown above to run diagnostics.
        </div>
        {% endif %}
    </div>
    
    {% elif active_tab == 'emails' %}
    <!-- Emails Tab -->
    <div class="tab-pane fade show active">
        <!-- Email queue content here -->
        <div class="card table-modern">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0"><i class="bi bi-envelope"></i> Email Queue</h5>
            </div>
            <div class="card-body">
                <!-- Add email queue table here -->
            </div>
        </div>
    </div>
    
    {% elif active_tab == 'rules' %}
    <!-- Rules Tab -->
    <div class="tab-pane fade show active">
        <div class="card">
            <div class="card-header">
                <h5>Moderation Rules</h5>
            </div>
            <div class="card-body">
                <p>Active Rules: {{ active_rules }}</p>
                <!-- Add rules management here -->
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
function switchAccount(accountId) {
    const currentTab = '{{ active_tab }}';
    let url = `/dashboard/${currentTab}`;
    if (accountId) {
        url += `?account_id=${accountId}`;
    }
    window.location.href = url;
}

function runDiagnostics(accountId) {
    const resultsDiv = document.getElementById('diagnosticsResults');
    resultsDiv.innerHTML = '<div class="spinner-border" role="status"><span class="visually-hidden">Running diagnostics...</span></div>';
    
    fetch(`/api/diagnostics/${accountId}`)
        .then(response => response.json())
        .then(data => {
            let html = '<div class="mt-3">';
            
            // SMTP Test
            html += '<div class="alert ' + (data.smtp_test.success ? 'alert-success' : 'alert-danger') + '">';
            html += '<strong>SMTP:</strong> ' + data.smtp_test.message;
            html += '</div>';
            
            // IMAP Test
            html += '<div class="alert ' + (data.imap_test.success ? 'alert-success' : 'alert-danger') + '">';
            html += '<strong>IMAP:</strong> ' + data.imap_test.message;
            html += '</div>';
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        })
        .catch(error => {
            resultsDiv.innerHTML = '<div class="alert alert-danger">Error running diagnostics: ' + error + '</div>';
        });
}

function testAccount(accountId) {
    alert('Testing account ' + accountId);
    // Add test logic here
}

function editAccount(accountId) {
    window.location.href = `/accounts/edit/${accountId}`;
}
</script>
{% endblock %}