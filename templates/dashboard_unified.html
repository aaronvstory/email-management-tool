{% extends "base.html" %}
{% import 'partials/account_components.html' as account_ui %}
{% import 'partials/rule_components.html' as rule_ui %}

{% block title %}Dashboard - Email Management Tool{% endblock %}

{% block extra_css %}
<!-- Dashboard-specific styles now in unified.css (extracted Oct 25, 2025) -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/patch.dashboard-emails.css') }}">
{% endblock %}

{% block content %}
<div id="dashboard-page">
<div class="page-header">
  <div>
    <h1><i class="bi bi-speedometer2"></i> Dashboard</h1>
    <p class="text-muted mb-0">Track email activity and manage your monitored accounts.</p>
  </div>
  <div class="header-actions">
    <button class="btn btn-secondary btn-sm" type="button" onclick="location.reload()">
      <i class="bi bi-arrow-clockwise"></i> Refresh
    </button>
  </div>
</div>

<div class="account-selector">
  <div class="selector-grid">
    <div class="selector-field">
      <label for="accountSelector">Filter by account</label>
      <select class="form-select" id="accountSelector" onchange="switchAccount(this.value)">
        <option value="">All accounts</option>
        {% for account in accounts %}
        <option value="{{ account.id }}" {% if selected_account_id == account.id|string %}selected{% endif %}>
          {{ account.account_name }} ({{ account.email_address }})
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="selector-meta">
      {% if selected_account_id %}
        {% for account in accounts %}
          {% if account.id|string == selected_account_id %}
          <span class="tag-chip {% if account.is_active %}success{% else %}accent{% endif %}">
            {% if account.is_active %}Active{% else %}Inactive{% endif %}
          </span>
          {% if account.last_checked %}
          <span class="selector-note">
            Last checked: <span class="time-cell" data-ts="{{ account.last_checked }}">{{ account.last_checked }}</span>
          </span>
          {% else %}
          <span class="selector-note">Last checked: Never</span>
          {% endif %}
          {% endif %}
        {% endfor %}
      {% else %}
        <span class="selector-note">Showing aggregated telemetry across all monitored accounts.</span>
      {% endif %}
    </div>

    <div class="selector-actions">
      <label class="form-label">Actions</label>
      <a href="{{ url_for('accounts.email_accounts') }}" class="btn btn-ghost btn-sm">
        <i class="bi bi-gear"></i> Manage
      </a>
    </div>
  </div>
</div>

{% set totals = namespace(value = stats.total if stats.total is not none else 0, held = 0, released = 0) %}
{% set totals.held = stats.held|default(0) %}
{% set totals.released = stats.released|default(0) %}
{% if totals.value == 0 %}
  {% set totals.value = totals.held + totals.released + (stats.rejected|default(0)) + (stats.discarded|default(0)) %}
{% endif %}

<!-- Compact Stats Grid -->
<div class="stats-grid" id="statsGrid">
  <div class="stat-card-modern">
    <span class="stat-value" id="statTotal">{{ totals.value }}</span>
    <span class="stat-label">Total</span>
  </div>
  <div class="stat-card-modern held">
    <span class="stat-value" id="statHeld">{{ totals.held }}</span>
    <span class="stat-label">Held</span>
  </div>
  <div class="stat-card-modern released">
    <span class="stat-value" id="statReleased">{{ totals.released }}</span>
    <span class="stat-label">Released</span>
  </div>
</div>

<!-- Recent Emails -->
<div class="recent-emails-panel">
  <div class="panel-title">
    <span><i class="bi bi-envelope"></i> Recent Emails</span>
    <a href="{{ url_for('emails.emails_unified') }}" class="btn btn-ghost btn-sm">
      View All <i class="bi bi-arrow-right"></i>
    </a>
  </div>

  <!-- Search Bar -->
  <div class="mb-3">
    <div class="input-group">
      <input type="text" id="email-search-input" class="form-control input-modern" placeholder="Search emails by subject, sender, recipient, or content...">
      <button class="btn btn-primary" id="email-search-btn" onclick="performEmailSearch()">
        <i class="bi bi-search"></i> Search
      </button>
      <button class="btn btn-secondary" id="email-search-clear" onclick="clearEmailSearch()" style="display:none;">
        <i class="bi bi-x-circle"></i> Clear
      </button>
    </div>
    <div id="email-search-results" style="display:none; margin-top:12px;">
      <div class="alert alert-info" id="email-search-status"></div>
    </div>
  </div>

  <!-- Filter Tabs -->
  <div class="status-tabs">
    <button class="status-tab active" data-status="ALL" onclick="switchDashboardFilter('ALL')">
      <i class="bi bi-inbox"></i> All
      <span class="badge" id="dashboard-badge-all">0</span>
    </button>
    <button class="status-tab" data-status="HELD" onclick="switchDashboardFilter('HELD')">
      <i class="bi bi-hand-stop"></i> Held
      <span class="badge" id="dashboard-badge-held">0</span>
    </button>
    <button class="status-tab" data-status="RELEASED" onclick="switchDashboardFilter('RELEASED')">
      <i class="bi bi-send-check"></i> Released
      <span class="badge" id="dashboard-badge-released">0</span>
    </button>
    <button class="status-tab" data-status="REJECTED" onclick="switchDashboardFilter('REJECTED')">
      <i class="bi bi-x-circle"></i> Rejected
      <span class="badge" id="dashboard-badge-rejected">0</span>
    </button>
  </div>

  <!-- Search and Controls -->
  <div class="filters-bar">
    <div class="search-group">
      <i class="bi bi-search"></i>
      <input id="dashboardSearchBox" class="search-input" placeholder="Filter dashboard emailsâ€¦" oninput="filterDashboardEmails()" />
    </div>
    <div class="toolbar-actions">
      <label class="form-check">
        <input type="checkbox" class="form-check-input" id="dashboardAutoRefresh" onchange="toggleDashboardAutoRefresh(this.checked)">
        <span>Auto-refresh</span>
      </label>
      <button class="btn-secondary" type="button" onclick="loadDashboardEmails()">
        <i class="bi bi-arrow-clockwise"></i> Refresh
      </button>
    </div>
  </div>

  <!-- Bulk Actions Bar -->
  <div id="bulk-actions-bar" class="bulk-toolbar">
    <span id="bulk-selection-count">0 selected</span>
    <button class="btn btn-sm btn-primary" onclick="bulkReleaseEmails()">
      <i class="bi bi-send-check"></i> Release Selected
    </button>
    <button class="btn btn-sm btn-danger" onclick="bulkDiscardEmails()">
      <i class="bi bi-trash"></i> Discard Selected
    </button>
    <button class="btn btn-sm btn-secondary" onclick="clearBulkSelection()">
      <i class="bi bi-x-circle"></i> Clear Selection
    </button>
  </div>

  <!-- Email Table -->
  <div style="overflow-x: auto;">
    <table class="email-table">
      <thead>
        <tr>
          <th class="col-select">
            <input type="checkbox" id="select-all-emails" onchange="toggleSelectAll(this.checked)" style="cursor:pointer;">
          </th>
          <th>Time</th>
          <th class="col-from">Correspondents</th>
          <th class="col-subject">Subject</th>
          <th class="col-status">Status</th>
          <th class="col-actions">Actions</th>
        </tr>
      </thead>
      <tbody id="dashboardEmailTableBody">
        <!-- Dynamic content loaded via JavaScript -->
      </tbody>
    </table>
  </div>

  <!-- Loading Spinner -->
  <div id="dashboardLoadingSpinner" class="loading-spinner">
    <div class="spinner"></div>
    <p>Loading emails...</p>
  </div>

  <!-- Empty State -->
  <div id="dashboardEmptyState" class="empty-state" style="display: none;">
    <i class="bi bi-inbox"></i>
    <p id="emptyStateMessage">No emails found</p>
    <p id="emptyStateHint" style="font-size: 0.85rem; margin-top: 8px; opacity: 0.7;"></p>
  </div>

  <!-- Pagination Controls -->
  <div id="paginationControls" style="display: none; margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 8px;">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
      <div style="color: #9ca3af; font-size: 0.9rem;">
        Showing <span id="pagination-showing-start">0</span>-<span id="pagination-showing-end">0</span> of <span id="pagination-total">0</span> emails
      </div>
      <div style="display: flex; gap: 8px; align-items: center;">
        <button class="btn btn-sm btn-secondary" id="pagination-first" onclick="goToPage(1)" disabled>
          <i class="bi bi-chevron-double-left"></i> First
        </button>
        <button class="btn btn-sm btn-secondary" id="pagination-prev" onclick="goToPage(currentPage - 1)" disabled>
          <i class="bi bi-chevron-left"></i> Previous
        </button>
        <div id="pagination-numbers" style="display: flex; gap: 4px;">
          <!-- Page numbers inserted here -->
        </div>
        <button class="btn btn-sm btn-secondary" id="pagination-next" onclick="goToPage(currentPage + 1)" disabled>
          Next <i class="bi bi-chevron-right"></i>
        </button>
        <button class="btn btn-sm btn-secondary" id="pagination-last" onclick="goToPage(totalPages)" disabled>
          Last <i class="bi bi-chevron-double-right"></i>
        </button>
      </div>
    </div>
  </div>
</div>
</div><!-- /#dashboard-page -->
{% endblock %}
