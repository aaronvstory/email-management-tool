{% extends "base.html" %}
{% import 'partials/account_components.html' as account_ui %}
{% import 'partials/rule_components.html' as rule_ui %}

{% block title %}Dashboard - Email Management Tool{% endblock %}

{% block extra_css %}
<!-- Dashboard uses base styles from base.html (theme-dark.css + main.css + design-system.css) -->
{% endblock %}

{% block content %}
<div id="dashboard-page" class="container-page">
  <!-- HERO -->
  <section class="section">
    <div class="card hero-card">
      <div class="title-row">
        <h1 class="page-title"><i class="bi bi-speedometer2"></i> Unified Dashboard</h1>
        <div class="page-badges">
          <span class="badge released">SMTP: OK</span>
          <span class="badge accent">Watchers: 2</span>
          <button class="btn btn-secondary" onclick="loadDashboardEmails()">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- FILTER ROW -->
  <section class="section">
    <div class="row-between">
      <label class="form-label">Select Account:</label>
      <select id="accountSelector" class="form-select" onchange="switchAccount(this.value)" style="max-width: 400px;">
        <option value="">All Accounts (Overview)</option>
        {% for account in accounts %}
        <option value="{{ account.id }}" {% if selected_account_id == account.id|string %}selected{% endif %}>
          {{ account.account_name }} ({{ account.email_address }})
        </option>
        {% endfor %}
      </select>
    </div>
  </section>

  <!-- SYSTEM STATS: 5-UP -->
  {% set totals = namespace(value = stats.total if stats.total is not none else 0, held = 0, released = 0) %}
  {% set totals.held = stats.held|default(0) %}
  {% set totals.released = stats.released|default(0) %}
  {% if totals.value == 0 %}
    {% set totals.value = totals.held + totals.released + (stats.rejected|default(0)) + (stats.discarded|default(0)) %}
  {% endif %}
  {% set pending = stats.pending|default(0) %}
  {% set latency = stats.latency_display|default('—') %}

  <section class="section">
    <h2 style="font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); margin-bottom: var(--space-3);">System Stats</h2>
    <div class="stats-grid stats-5">
      <div class="stat-card-modern">
        <div class="stat-value" id="statTotal">{{ totals.value }}</div>
        <div class="stat-label">Total</div>
      </div>

      <div class="stat-card-modern">
        <div class="stat-value" id="statPending">{{ pending }}</div>
        <div class="stat-label">Pending (Outbound)</div>
      </div>

      <div class="stat-card-modern held">
        <div class="stat-value" id="statHeld">{{ totals.held }}</div>
        <div class="stat-label">Held (Inbound)</div>
      </div>

      <div class="stat-card-modern released">
        <div class="stat-value" id="statReleased">{{ totals.released }}</div>
        <div class="stat-label">Released / Delivered</div>
      </div>

      <div class="stat-card-modern">
        <div class="stat-value" id="statLatency">{{ latency }}</div>
        <div class="stat-label">Latency</div>
      </div>
    </div>
  </section>

  <!-- RECENT EMAILS -->
  <section class="section">
    <div class="row-between mb-3">
      <h2 style="font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim);">
        <i class="bi bi-inbox"></i> Recent Emails
      </h2>
      <a href="{{ url_for('emails.emails_unified') }}" class="btn btn-ghost btn-sm">View All <i class="bi bi-arrow-right"></i></a>
    </div>

    <!-- Search Bar -->
    <div class="mb-3">
      <div class="input-group">
        <input type="text" id="email-search-input" class="form-control input-modern" placeholder="Search emails by subject, sender, recipient, or content...">
        <button class="btn btn-primary" id="email-search-btn" onclick="performEmailSearch()">
          <i class="bi bi-search"></i> Search
        </button>
        <button class="btn btn-secondary" id="email-search-clear" onclick="clearEmailSearch()" hidden>
          <i class="bi bi-x-circle"></i> Clear
        </button>
      </div>
      <div id="email-search-results" class="mt-3" hidden>
        <div class="alert alert-info" id="email-search-status"></div>
      </div>
    </div>

    <!-- Filter Tabs -->
    <div class="status-tabs">
      <button class="status-tab active" data-status="ALL" onclick="switchDashboardFilter('ALL')">
        <i class="bi bi-inbox"></i> All
        <span class="badge" id="dashboard-badge-all">0</span>
      </button>
      <button class="status-tab" data-status="HELD" onclick="switchDashboardFilter('HELD')">
        <i class="bi bi-hand-stop"></i> Held
        <span class="badge" id="dashboard-badge-held">0</span>
      </button>
      <button class="status-tab" data-status="RELEASED" onclick="switchDashboardFilter('RELEASED')">
        <i class="bi bi-send-check"></i> Released
        <span class="badge" id="dashboard-badge-released">0</span>
      </button>
      <button class="status-tab" data-status="REJECTED" onclick="switchDashboardFilter('REJECTED')">
        <i class="bi bi-x-circle"></i> Rejected
        <span class="badge" id="dashboard-badge-rejected">0</span>
      </button>
    </div>

    <!-- Search and Controls -->
    <div class="filters-bar">
      <div class="search-group">
        <i class="bi bi-search"></i>
        <input id="dashboardSearchBox" class="input-modern" placeholder="Search subject, sender, or recipient..." oninput="filterDashboardEmails()" />
      </div>
      <div class="toolbar-actions">
        <label class="form-check">
          <input type="checkbox" class="form-check-input" id="dashboardAutoRefresh" onchange="toggleDashboardAutoRefresh(this.checked)">
          <span>Auto-refresh</span>
        </label>
        <button class="btn btn-secondary" type="button" onclick="loadDashboardEmails()">
          <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
      </div>
    </div>

    <!-- Bulk Actions Bar -->
    <div id="bulk-actions-bar" class="bulk-toolbar">
      <span id="bulk-selection-count">0 selected</span>
      <div class="action-buttons">
        <button class="btn btn-sm btn-primary" onclick="bulkReleaseEmails()">
          <i class="bi bi-send-check"></i> Release Selected
        </button>
        <button class="btn btn-sm btn-danger" onclick="bulkDiscardEmails()">
          <i class="bi bi-trash"></i> Discard Selected
        </button>
        <button class="btn btn-sm btn-secondary" onclick="clearBulkSelection()">
          <i class="bi bi-x-circle"></i> Clear Selection
        </button>
      </div>
    </div>

    <!-- Email Table -->
    <div class="card">
      <table class="email-table">
        <thead>
          <tr>
            <th class="col-select">
              <input type="checkbox" id="select-all-emails" onchange="toggleSelectAll(this.checked)">
            </th>
            <th>Time</th>
            <th class="col-from">Correspondents</th>
            <th class="col-subject">Subject</th>
            <th class="col-status">Status</th>
            <th class="col-actions">Actions</th>
          </tr>
        </thead>
        <tbody id="dashboardEmailTableBody">
          <!-- Dynamic content loaded via JavaScript -->
        </tbody>
      </table>
    </div>

    <!-- Loading Spinner -->
    <div id="dashboardLoadingSpinner" class="loading-spinner">
      <div class="spinner"></div>
      <p>Loading emails...</p>
    </div>

    <!-- Empty State -->
    <div id="dashboardEmptyState" class="empty-state" hidden>
      <i class="bi bi-inbox"></i>
      <p id="emptyStateMessage">No emails found</p>
      <p id="emptyStateHint" class="text-muted mt-2"></p>
    </div>

    <!-- Pagination Controls -->
    <div id="paginationControls" class="card mt-5" hidden>
      <div class="row-between">
        <div class="text-muted">
          Showing <span id="pagination-showing-start">0</span>-<span id="pagination-showing-end">0</span> of <span id="pagination-total">0</span> emails
        </div>
        <div class="action-buttons">
          <button class="btn btn-sm btn-secondary" id="pagination-first" onclick="goToPage(1)" disabled>
            <i class="bi bi-chevron-double-left"></i> First
          </button>
          <button class="btn btn-sm btn-secondary" id="pagination-prev" onclick="goToPage(currentPage - 1)" disabled>
            <i class="bi bi-chevron-left"></i> Previous
          </button>
          <div id="pagination-numbers" class="d-flex gap-2">
            <!-- Page numbers inserted here -->
          </div>
          <button class="btn btn-sm btn-secondary" id="pagination-next" onclick="goToPage(currentPage + 1)" disabled>
            Next <i class="bi bi-chevron-right"></i>
          </button>
          <button class="btn btn-sm btn-secondary" id="pagination-last" onclick="goToPage(totalPages)" disabled>
            Last <i class="bi bi-chevron-double-right"></i>
          </button>
        </div>
      </div>
    </div>
  </section>
</div><!-- /#dashboard-page -->
{% endblock %}


{% block extra_js %}
<script>
// ============================
// Dashboard JavaScript
// ============================

let currentAccountId = '{{ selected_account_id or "" }}';
const { renderTimeCell, applyTimeFormatting, escapeHtml } = window.MailOps;

let allDashboardEmails = [];
let filteredDashboardEmails = [];
let currentFilter = 'ALL';
let currentPage = 1;
let totalPages = 1;
const itemsPerPage = 20;
let autoRefreshInterval = null;

// SSE connection for real-time updates
let dashboardEventSource = null;

function initDashboardSSE() {
  if (dashboardEventSource) {
    dashboardEventSource.close();
  }
  
  const url = currentAccountId 
    ? `/api/stream/emails?account_id=${currentAccountId}`
    : '/api/stream/emails';
  
  dashboardEventSource = new EventSource(url);
  
  dashboardEventSource.onmessage = function(event) {
    const data = JSON.parse(event.data);
    if (data.type === 'update') {
      loadDashboardEmails();
    }
  };
  
  dashboardEventSource.onerror = function() {
    console.error('SSE connection error, will retry...');
    dashboardEventSource.close();
    setTimeout(initDashboardSSE, 5000);
  };
}

function switchAccount(accountId) {
  currentAccountId = accountId;
  loadDashboardEmails();
  initDashboardSSE();
}

function switchDashboardFilter(status) {
  currentFilter = status;
  document.querySelectorAll('.status-tab').forEach(tab => {
    tab.classList.toggle('active', tab.dataset.status === status);
  });
  filterDashboardEmails();
  currentPage = 1;
  renderDashboardTable();
}

function filterDashboardEmails() {
  const searchTerm = document.getElementById('dashboardSearchBox').value.toLowerCase();
  
  filteredDashboardEmails = allDashboardEmails.filter(email => {
    const matchesFilter = currentFilter === 'ALL' || email.status === currentFilter;
    const matchesSearch = !searchTerm || 
      email.subject.toLowerCase().includes(searchTerm) ||
      email.from_address.toLowerCase().includes(searchTerm) ||
      (email.to_address && email.to_address.toLowerCase().includes(searchTerm));
    return matchesFilter && matchesSearch;
  });
  
  totalPages = Math.ceil(filteredDashboardEmails.length / itemsPerPage);
  if (currentPage > totalPages) currentPage = 1;
  
  renderDashboardTable();
  updatePagination();
}

async function loadDashboardEmails() {
  const spinner = document.getElementById('dashboardLoadingSpinner');
  const tbody = document.getElementById('dashboardEmailTableBody');
  const emptyState = document.getElementById('dashboardEmptyState');
  
  spinner.style.display = 'flex';
  tbody.innerHTML = '';
  emptyState.hidden = true;
  
  try {
    const url = currentAccountId 
      ? `/api/dashboard/emails?account_id=${currentAccountId}`
      : '/api/dashboard/emails';
    
    const response = await fetch(url);
    if (!response.ok) throw new Error('Failed to load emails');
    
    const data = await response.json();
    allDashboardEmails = data.emails || [];
    
    // Update stats
    updateDashboardStats(data.stats || {});
    
    // Update filter badges
    updateFilterBadges();
    
    // Filter and render
    filterDashboardEmails();
    
  } catch (error) {
    console.error('Error loading dashboard emails:', error);
    showError('Failed to load emails');
    emptyState.hidden = false;
    document.getElementById('emptyStateMessage').textContent = 'Error loading emails';
  } finally {
    spinner.style.display = 'none';
  }
}

function updateDashboardStats(stats) {
  document.getElementById('statTotal').textContent = stats.total || 0;
  document.getElementById('statPending').textContent = stats.pending || 0;
  document.getElementById('statHeld').textContent = stats.held || 0;
  document.getElementById('statReleased').textContent = stats.released || 0;
  document.getElementById('statLatency').textContent = stats.latency_display || '—';
}

function updateFilterBadges() {
  const counts = {
    ALL: allDashboardEmails.length,
    HELD: allDashboardEmails.filter(e => e.status === 'HELD').length,
    RELEASED: allDashboardEmails.filter(e => e.status === 'RELEASED').length,
    REJECTED: allDashboardEmails.filter(e => e.status === 'REJECTED').length
  };
  
  Object.entries(counts).forEach(([status, count]) => {
    const badge = document.getElementById(`dashboard-badge-${status.toLowerCase()}`);
    if (badge) badge.textContent = count;
  });
}

function renderDashboardTable() {
  const tbody = document.getElementById('dashboardEmailTableBody');
  const emptyState = document.getElementById('dashboardEmptyState');
  
  if (filteredDashboardEmails.length === 0) {
    tbody.innerHTML = '';
    emptyState.hidden = false;
    const msg = currentFilter === 'ALL' ? 'No emails found' : `No ${currentFilter.toLowerCase()} emails`;
    document.getElementById('emptyStateMessage').textContent = msg;
    document.getElementById('paginationControls').hidden = true;
    return;
  }
  
  emptyState.hidden = true;
  document.getElementById('paginationControls').hidden = false;
  
  const start = (currentPage - 1) * itemsPerPage;
  const end = start + itemsPerPage;
  const pageEmails = filteredDashboardEmails.slice(start, end);
  
  tbody.innerHTML = pageEmails.map(email => {
    const statusClass = email.status.toLowerCase();
    const timeCell = renderTimeCell(email.timestamp);
    
    return `
      <tr data-email-id="${email.id}">
        <td class="col-select">
          <input type="checkbox" class="email-checkbox" data-email-id="${email.id}">
        </td>
        <td>${timeCell}</td>
        <td class="col-from">
          <div class="correspondent-cell">
            <div class="correspondent-primary">${escapeHtml(email.from_address)}</div>
            ${email.to_address ? `<div class="correspondent-secondary">→ ${escapeHtml(email.to_address)}</div>` : ''}
          </div>
        </td>
        <td class="col-subject">
          <a href="/email/${email.id}" class="email-subject-link">${escapeHtml(email.subject || '(No Subject)')}</a>
        </td>
        <td class="col-status">
          <span class="badge ${statusClass}">${email.status}</span>
        </td>
        <td class="col-actions">
          ${renderEmailActions(email)}
        </td>
      </tr>
    `;
  }).join('');
  
  applyTimeFormatting();
  updateBulkSelectionUI();
}

function renderEmailActions(email) {
  const actions = [];
  
  if (email.status === 'HELD') {
    actions.push(`<button class="btn btn-sm btn-primary" onclick="releaseEmail(${email.id})" title="Release to inbox"><i class="bi bi-send-check"></i></button>`);
    actions.push(`<button class="btn btn-sm btn-secondary" onclick="editEmail(${email.id})" title="Edit before releasing"><i class="bi bi-pencil"></i></button>`);
    actions.push(`<button class="btn btn-sm btn-danger" onclick="discardEmail(${email.id})" title="Discard permanently"><i class="bi bi-trash"></i></button>`);
  } else {
    actions.push(`<button class="btn btn-sm btn-secondary" onclick="viewEmail(${email.id})" title="View details"><i class="bi bi-eye"></i></button>`);
  }
  
  return actions.join(' ');
}

async function releaseEmail(id) {
  if (!confirm('Release this email to inbox?')) return;
  
  try {
    const response = await fetch(`/api/interception/release/${id}`, {
      method: 'POST',
      headers: { 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content }
    });
    
    if (!response.ok) throw new Error('Release failed');
    
    showSuccess('Email released successfully');
    loadDashboardEmails();
  } catch (error) {
    console.error('Error releasing email:', error);
    showError('Failed to release email');
  }
}

async function discardEmail(id) {
  if (!confirm('Permanently discard this email? This cannot be undone.')) return;
  
  try {
    const response = await fetch(`/api/interception/discard/${id}`, {
      method: 'POST',
      headers: { 'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content }
    });
    
    if (!response.ok) throw new Error('Discard failed');
    
    showSuccess('Email discarded');
    loadDashboardEmails();
  } catch (error) {
    console.error('Error discarding email:', error);
    showError('Failed to discard email');
  }
}

function editEmail(id) {
  window.location.href = `/email/${id}/edit`;
}

function viewEmail(id) {
  window.location.href = `/email/${id}`;
}

// Bulk operations
function toggleSelectAll(checked) {
  document.querySelectorAll('.email-checkbox').forEach(cb => {
    cb.checked = checked;
  });
  updateBulkSelectionUI();
}

function updateBulkSelectionUI() {
  const checkboxes = document.querySelectorAll('.email-checkbox');
  const checked = Array.from(checkboxes).filter(cb => cb.checked);
  const bulkBar = document.getElementById('bulk-actions-bar');
  const count = document.getElementById('bulk-selection-count');
  
  if (checked.length > 0) {
    bulkBar.style.display = 'flex';
    count.textContent = `${checked.length} selected`;
  } else {
    bulkBar.style.display = 'none';
  }
  
  document.getElementById('select-all-emails').checked = 
    checkboxes.length > 0 && checked.length === checkboxes.length;
}

document.addEventListener('change', function(e) {
  if (e.target.classList.contains('email-checkbox')) {
    updateBulkSelectionUI();
  }
});

async function bulkReleaseEmails() {
  const ids = getSelectedEmailIds();
  if (ids.length === 0) return;
  
  if (!confirm(`Release ${ids.length} email(s) to inbox?`)) return;
  
  try {
    const response = await fetch('/api/interception/bulk-release', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({ ids })
    });
    
    if (!response.ok) throw new Error('Bulk release failed');
    
    const result = await response.json();
    showSuccess(`Released ${result.success} email(s)`);
    clearBulkSelection();
    loadDashboardEmails();
  } catch (error) {
    console.error('Error in bulk release:', error);
    showError('Bulk release failed');
  }
}

async function bulkDiscardEmails() {
  const ids = getSelectedEmailIds();
  if (ids.length === 0) return;
  
  if (!confirm(`Permanently discard ${ids.length} email(s)? This cannot be undone.`)) return;
  
  try {
    const response = await fetch('/api/interception/bulk-discard', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({ ids })
    });
    
    if (!response.ok) throw new Error('Bulk discard failed');
    
    const result = await response.json();
    showSuccess(`Discarded ${result.success} email(s)`);
    clearBulkSelection();
    loadDashboardEmails();
  } catch (error) {
    console.error('Error in bulk discard:', error);
    showError('Bulk discard failed');
  }
}

function getSelectedEmailIds() {
  return Array.from(document.querySelectorAll('.email-checkbox:checked'))
    .map(cb => parseInt(cb.dataset.emailId));
}

function clearBulkSelection() {
  document.querySelectorAll('.email-checkbox').forEach(cb => cb.checked = false);
  document.getElementById('select-all-emails').checked = false;
  updateBulkSelectionUI();
}

// Pagination
function updatePagination() {
  const start = (currentPage - 1) * itemsPerPage + 1;
  const end = Math.min(currentPage * itemsPerPage, filteredDashboardEmails.length);
  
  document.getElementById('pagination-showing-start').textContent = filteredDashboardEmails.length > 0 ? start : 0;
  document.getElementById('pagination-showing-end').textContent = end;
  document.getElementById('pagination-total').textContent = filteredDashboardEmails.length;
  
  document.getElementById('pagination-first').disabled = currentPage === 1;
  document.getElementById('pagination-prev').disabled = currentPage === 1;
  document.getElementById('pagination-next').disabled = currentPage === totalPages;
  document.getElementById('pagination-last').disabled = currentPage === totalPages;
  
  renderPaginationNumbers();
}

function renderPaginationNumbers() {
  const container = document.getElementById('pagination-numbers');
  const maxVisible = 5;
  let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
  let endPage = Math.min(totalPages, startPage + maxVisible - 1);
  
  if (endPage - startPage + 1 < maxVisible) {
    startPage = Math.max(1, endPage - maxVisible + 1);
  }
  
  const buttons = [];
  for (let i = startPage; i <= endPage; i++) {
    const active = i === currentPage ? 'active' : '';
    buttons.push(`
      <button class="btn btn-sm btn-secondary ${active}" onclick="goToPage(${i})">
        ${i}
      </button>
    `);
  }
  
  container.innerHTML = buttons.join('');
}

function goToPage(page) {
  if (page < 1 || page > totalPages) return;
  currentPage = page;
  renderDashboardTable();
  updatePagination();
}

// Auto-refresh
function toggleDashboardAutoRefresh(enabled) {
  if (enabled) {
    autoRefreshInterval = setInterval(loadDashboardEmails, 30000);
    showInfo('Auto-refresh enabled (30s)');
  } else {
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
      autoRefreshInterval = null;
    }
    showInfo('Auto-refresh disabled');
  }
}

// Email search
async function performEmailSearch() {
  const query = document.getElementById('email-search-input').value.trim();
  if (!query) {
    showWarning('Please enter a search query');
    return;
  }
  
  const resultsDiv = document.getElementById('email-search-results');
  const statusDiv = document.getElementById('email-search-status');
  const clearBtn = document.getElementById('email-search-clear');
  
  resultsDiv.hidden = false;
  statusDiv.textContent = 'Searching...';
  statusDiv.className = 'alert alert-info';
  
  try {
    const params = new URLSearchParams({ q: query });
    if (currentAccountId) params.append('account_id', currentAccountId);
    
    const response = await fetch(`/api/emails/search?${params}`);
    if (!response.ok) throw new Error('Search failed');
    
    const data = await response.json();
    
    if (data.results && data.results.length > 0) {
      statusDiv.className = 'alert alert-success';
      statusDiv.textContent = `Found ${data.results.length} result(s)`;
      
      allDashboardEmails = data.results;
      filterDashboardEmails();
      clearBtn.hidden = false;
    } else {
      statusDiv.className = 'alert alert-warning';
      statusDiv.textContent = 'No results found';
    }
  } catch (error) {
    console.error('Search error:', error);
    statusDiv.className = 'alert alert-danger';
    statusDiv.textContent = 'Search failed';
  }
}

function clearEmailSearch() {
  document.getElementById('email-search-input').value = '';
  document.getElementById('email-search-results').hidden = true;
  document.getElementById('email-search-clear').hidden = true;
  loadDashboardEmails();
}

document.getElementById('email-search-input')?.addEventListener('keypress', function(e) {
  if (e.key === 'Enter') performEmailSearch();
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  loadDashboardEmails();
  initDashboardSSE();
  
  // Refresh every 2 minutes if auto-refresh not enabled
  setInterval(() => {
    if (!document.getElementById('dashboardAutoRefresh').checked) {
      loadDashboardEmails();
    }
  }, 120000);
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
  if (dashboardEventSource) {
    dashboardEventSource.close();
  }
  if (autoRefreshInterval) {
    clearInterval(autoRefreshInterval);
  }
});
</script>
{% endblock %}
