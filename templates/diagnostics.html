{% extends "base.html" %}
{% block title %}Diagnostics - Email Management Tool{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <h1><i class="bi bi-heart-pulse"></i> System Diagnostics</h1>
    <p class="text-muted mb-0">Check system health, connection status, and run account diagnostics.</p>
  </div>
  <div class="header-actions">
    <button class="btn btn-secondary btn-sm" onclick="runFullDiagnostics()">
      <i class="bi bi-activity"></i> Run Full Check
    </button>
    <button class="btn btn-ghost btn-sm" onclick="location.reload()">
      <i class="bi bi-arrow-clockwise"></i> Refresh
    </button>
  </div>
</div>

<div class="cards-grid mb-4">
  <div class="stat-card-modern">
    <span class="stat-label">SMTP Status</span>
    <span class="stat-value" id="smtpStatus">
      <span class="tag-chip muted">Checking...</span>
    </span>
  </div>
  <div class="stat-card-modern">
    <span class="stat-label">Active Watchers</span>
    <span class="stat-value" id="watcherCount">--</span>
  </div>
  <div class="stat-card-modern">
    <span class="stat-label">Database Size</span>
    <span class="stat-value" id="dbSize">--</span>
  </div>
  <div class="stat-card-modern">
    <span class="stat-label">System Uptime</span>
    <span class="stat-value" id="uptime">--</span>
  </div>
</div>

<div class="panel mb-4">
  <div class="panel-header">
    <div class="panel-title"><i class="bi bi-envelope-at"></i> Account Diagnostics</div>
  </div>
  <div class="panel-body">
    <div class="mb-3">
      <label for="accountSelector" class="form-label">Select Account</label>
      <select class="form-select" id="accountSelector" onchange="loadAccountDiagnostics(this.value)">
        <option value="">Choose an account to test...</option>
        {% for account in accounts %}
        <option value="{{ account.id }}">{{ account.account_name }} ({{ account.email_address }})</option>
        {% endfor %}
      </select>
    </div>
    <div id="accountDiagnosticsResults" class="mt-3"></div>
  </div>
</div>

<div class="panel">
  <div class="panel-header">
    <div class="panel-title"><i class="bi bi-clipboard-data"></i> System Logs</div>
    <div class="panel-actions">
      <button class="btn btn-ghost btn-sm" onclick="clearLogs()">
        <i class="bi bi-trash"></i> Clear
      </button>
    </div>
  </div>
  <div class="panel-body">
    <div id="systemLogs" class="console-output">
      <div class="text-muted">Loading recent logs...</div>
    </div>
  </div>
</div>

<style>
.console-output {
  background: #1a1a1a;
  border: 1px solid var(--border-subtle);
  border-radius: var(--radius-md);
  padding: 15px;
  max-height: 400px;
  overflow-y: auto;
  font-family: 'Consolas', 'Monaco', monospace;
  font-size: 0.875rem;
  line-height: 1.5;
}

.console-output .log-entry {
  margin-bottom: 8px;
  padding-bottom: 8px;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.console-output .log-entry:last-child {
  border-bottom: none;
}

.log-timestamp {
  color: #666;
  margin-right: 10px;
}

.log-level-info { color: #4a9eff; }
.log-level-warning { color: #ffb347; }
.log-level-error { color: #ff4747; }
.log-level-success { color: #4caf50; }
</style>

<script>
async function loadSystemStatus() {
  try {
    // Check SMTP
    const smtpResp = await fetch('/api/smtp-health', { credentials: 'same-origin' });
    const smtpData = await smtpResp.json();
    const smtpChip = smtpData.status === 'running'
      ? '<span class="tag-chip success"><i class="bi bi-check-circle"></i> Running</span>'
      : '<span class="tag-chip accent"><i class="bi bi-exclamation-triangle"></i> Stopped</span>';
    document.getElementById('smtpStatus').innerHTML = smtpChip;

    // Check watchers
    const watcherResp = await fetch('/api/watchers/status', { credentials: 'same-origin' });
    const watcherData = await watcherResp.json();
    document.getElementById('watcherCount').textContent = (watcherData.workers || []).length;

    // Load other stats
    const statsResp = await fetch('/api/stats/summary', { credentials: 'same-origin' });
    const statsData = await statsResp.json();

    // Mock some values for now
    document.getElementById('dbSize').textContent = '12.3 MB';
    document.getElementById('uptime').textContent = '2d 14h';

    // Load logs
    loadSystemLogs();
  } catch (e) {
    console.error('Error loading system status:', e);
  }
}

async function loadAccountDiagnostics(accountId) {
  if (!accountId) {
    document.getElementById('accountDiagnosticsResults').innerHTML = '';
    return;
  }

  const resultsDiv = document.getElementById('accountDiagnosticsResults');
  resultsDiv.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Running diagnostics...</span></div></div>';

  try {
    const resp = await fetch('/api/diagnostics/' + accountId, { credentials: 'same-origin' });
    const data = await resp.json();

    let html = '<div class="mt-3">';

    // SMTP Test
    html += '<div class="alert ' + (data.smtp_test.success ? 'alert-success' : 'alert-danger') + '">';
    html += '<strong>SMTP Test:</strong><br>' + data.smtp_test.message;
    html += '</div>';

    // IMAP Test
    html += '<div class="alert ' + (data.imap_test.success ? 'alert-success' : 'alert-danger') + '">';
    html += '<strong>IMAP Test:</strong><br>' + data.imap_test.message;
    html += '</div>';

    html += '<small class="text-muted">Tested at: ' + data.timestamp + '</small>';
    html += '</div>';

    resultsDiv.innerHTML = html;
  } catch (e) {
    resultsDiv.innerHTML = '<div class="alert alert-danger">Error running diagnostics: ' + e + '</div>';
  }
}

async function runFullDiagnostics() {
  if (window.showInfo) showInfo('Running full system diagnostics...');

  // Reload all status
  await loadSystemStatus();

  // Test each account
  const selector = document.getElementById('accountSelector');
  if (selector.value) {
    await loadAccountDiagnostics(selector.value);
  }

  if (window.showSuccess) showSuccess('Diagnostics complete');
}

function loadSystemLogs() {
  // Mock some log entries for now
  const logs = [
    { time: '21:52:14', level: 'info', msg: 'SMTP Proxy started on 127.0.0.1:8587' },
    { time: '21:52:14', level: 'info', msg: 'Starting IMAP monitor for account 2' },
    { time: '21:52:14', level: 'info', msg: 'Starting IMAP monitor for account 3' },
    { time: '21:52:15', level: 'success', msg: 'Connected to imap.hostinger.com:993' },
    { time: '21:52:15', level: 'success', msg: 'Connected to imap.gmail.com:993' },
    { time: '21:52:16', level: 'warning', msg: 'SMTP Proxy port already in use - likely from previous instance' },
  ];

  let html = '';
  for (const log of logs) {
    const levelClass = 'log-level-' + log.level;
    html += '<div class="log-entry">';
    html += '<span class="log-timestamp">' + log.time + '</span>';
    html += '<span class="' + levelClass + '">[' + log.level.toUpperCase() + ']</span> ';
    html += log.msg;
    html += '</div>';
  }

  document.getElementById('systemLogs').innerHTML = html;
}

function clearLogs() {
  document.getElementById('systemLogs').innerHTML = '<div class="text-muted">Logs cleared</div>';
  if (window.showSuccess) showSuccess('Logs cleared');
}

// Load on page load
document.addEventListener('DOMContentLoaded', loadSystemStatus);
</script>
{% endblock %}

