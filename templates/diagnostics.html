{% extends "base.html" %}

{% block title %}Email Connectivity Diagnostics{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="h2 mb-4">
        <i class="fas fa-stethoscope"></i> Email Connectivity Diagnostics
    </h1>

    <!-- Summary Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-{{ 'success' if results.summary.ready_to_use else 'danger' }} text-white">
                    <h5 class="mb-0">
                        {% if results.summary.ready_to_use %}
                            <i class="fas fa-check-circle"></i> System Ready
                        {% else %}
                            <i class="fas fa-exclamation-triangle"></i> System Not Ready
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <i class="fas fa-cog fa-3x {{ 'text-success' if results.summary.configuration_valid else 'text-danger' }}"></i>
                                <p class="mt-2">Configuration</p>
                                <span class="badge bg-{{ 'success' if results.summary.configuration_valid else 'danger' }}">
                                    {{ 'Valid' if results.summary.configuration_valid else 'Invalid' }}
                                </span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <i class="fas fa-network-wired fa-3x {{ 'text-success' if results.summary.network_ok else 'text-danger' }}"></i>
                                <p class="mt-2">Network</p>
                                <span class="badge bg-{{ 'success' if results.summary.network_ok else 'danger' }}">
                                    {{ 'Connected' if results.summary.network_ok else 'Disconnected' }}
                                </span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <i class="fas fa-paper-plane fa-3x {{ 'text-success' if results.summary.smtp_ok else 'text-danger' }}"></i>
                                <p class="mt-2">SMTP (Outgoing)</p>
                                <span class="badge bg-{{ 'success' if results.summary.smtp_ok else 'danger' }}">
                                    {{ 'Working' if results.summary.smtp_ok else 'Failed' }}
                                </span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <i class="fas fa-inbox fa-3x {{ 'text-success' if results.summary.imap_ok else 'text-danger' }}"></i>
                                <p class="mt-2">IMAP (Incoming)</p>
                                <span class="badge bg-{{ 'success' if results.summary.imap_ok else 'danger' }}">
                                    {{ 'Working' if results.summary.imap_ok else 'Failed' }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Details -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs"></i> Configuration Status
                    </h5>
                </div>
                <div class="card-body">
                    <h6>SMTP Settings</h6>
                    <table class="table table-sm">
                        <tr>
                            <td>Host:</td>
                            <td>{{ results.configuration.smtp_settings.host }}</td>
                        </tr>
                        <tr>
                            <td>Port:</td>
                            <td>{{ results.configuration.smtp_settings.port }}</td>
                        </tr>
                        <tr>
                            <td>Username:</td>
                            <td>{{ results.configuration.smtp_settings.username or 'Not configured' }}</td>
                        </tr>
                        <tr>
                            <td>Password:</td>
                            <td>{{ '••••••••' if results.configuration.smtp_settings.has_password else 'Not set' }}</td>
                        </tr>
                        <tr>
                            <td>TLS:</td>
                            <td>
                                <span class="badge bg-{{ 'success' if results.configuration.smtp_settings.use_tls else 'secondary' }}">
                                    {{ 'Enabled' if results.configuration.smtp_settings.use_tls else 'Disabled' }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td>SSL:</td>
                            <td>
                                <span class="badge bg-{{ 'success' if results.configuration.smtp_settings.use_ssl else 'secondary' }}">
                                    {{ 'Enabled' if results.configuration.smtp_settings.use_ssl else 'Disabled' }}
                                </span>
                            </td>
                        </tr>
                    </table>

                    <h6 class="mt-3">IMAP Settings</h6>
                    <table class="table table-sm">
                        <tr>
                            <td>Host:</td>
                            <td>{{ results.configuration.imap_settings.host }}</td>
                        </tr>
                        <tr>
                            <td>Port:</td>
                            <td>{{ results.configuration.imap_settings.port }}</td>
                        </tr>
                        <tr>
                            <td>Username:</td>
                            <td>{{ results.configuration.imap_settings.username or 'Not configured' }}</td>
                        </tr>
                        <tr>
                            <td>Password:</td>
                            <td>{{ '••••••••' if results.configuration.imap_settings.has_password else 'Not set' }}</td>
                        </tr>
                        <tr>
                            <td>SSL:</td>
                            <td>
                                <span class="badge bg-{{ 'success' if results.configuration.imap_settings.use_ssl else 'secondary' }}">
                                    {{ 'Enabled' if results.configuration.imap_settings.use_ssl else 'Disabled' }}
                                </span>
                            </td>
                        </tr>
                    </table>

                    {% if results.configuration.issues %}
                    <div class="alert alert-warning">
                        <h6>Configuration Issues:</h6>
                        <ul class="mb-0">
                            {% for issue in results.configuration.issues %}
                            <li>{{ issue }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Network Connectivity -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-network-wired"></i> Network Connectivity
                    </h5>
                </div>
                <div class="card-body">
                    <h6>Server Reachability</h6>
                    <table class="table table-sm">
                        <tr>
                            <td>SMTP Server:</td>
                            <td>
                                {% if results.network.smtp_reachable %}
                                    <span class="badge bg-success">Reachable</span>
                                    <small class="text-muted d-block">{{ results.network.smtp_message }}</small>
                                {% else %}
                                    <span class="badge bg-danger">Unreachable</span>
                                    <small class="text-danger d-block">{{ results.network.smtp_error }}</small>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>IMAP Server:</td>
                            <td>
                                {% if results.network.imap_reachable %}
                                    <span class="badge bg-success">Reachable</span>
                                    <small class="text-muted d-block">{{ results.network.imap_message }}</small>
                                {% else %}
                                    <span class="badge bg-danger">Unreachable</span>
                                    <small class="text-danger d-block">{{ results.network.imap_error }}</small>
                                {% endif %}
                            </td>
                        </tr>
                    </table>

                    {% if results.network.dns_resolution %}
                    <h6 class="mt-3">DNS Resolution</h6>
                    <table class="table table-sm">
                        {% if results.network.dns_resolution.status == 'success' %}
                        <tr>
                            <td>SMTP Host:</td>
                            <td>{{ results.network.dns_resolution.smtp_host }} → {{ results.network.dns_resolution.smtp_ip }}</td>
                        </tr>
                        <tr>
                            <td>IMAP Host:</td>
                            <td>{{ results.network.dns_resolution.imap_host }} → {{ results.network.dns_resolution.imap_ip }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="2" class="text-danger">
                                DNS resolution failed: {{ results.network.dns_resolution.error }}
                            </td>
                        </tr>
                        {% endif %}
                    </table>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- SMTP and IMAP Details -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-paper-plane"></i> SMTP Status
                    </h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <td>Connection:</td>
                            <td>
                                <span class="badge bg-{{ 'success' if results.smtp.connection else 'danger' }}">
                                    {{ 'Established' if results.smtp.connection else 'Failed' }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td>Authentication:</td>
                            <td>
                                <span class="badge bg-{{ 'success' if results.smtp.authentication else 'danger' }}">
                                    {{ 'Success' if results.smtp.authentication else 'Failed' }}
                                </span>
                                {% if results.smtp.authenticated_user %}
                                    <small class="text-muted d-block">User: {{ results.smtp.authenticated_user }}</small>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>TLS Support:</td>
                            <td>
                                <span class="badge bg-{{ 'success' if results.smtp.tls_support else 'secondary' }}">
                                    {{ 'Supported' if results.smtp.tls_support else 'Not Used' }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td>Send Capability:</td>
                            <td>
                                <span class="badge bg-{{ 'success' if results.smtp.send_capability else 'warning' }}">
                                    {{ 'Verified' if results.smtp.send_capability else 'Unknown' }}
                                </span>
                            </td>
                        </tr>
                    </table>

                    {% if results.smtp.error %}
                    <div class="alert alert-danger">
                        <strong>Error:</strong> {{ results.smtp.error }}
                    </div>
                    {% endif %}

                    {% if results.smtp.auth_error %}
                    <div class="alert alert-warning">
                        <strong>Authentication Error:</strong> {{ results.smtp.auth_error }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-inbox"></i> IMAP Status
                    </h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <td>Connection:</td>
                            <td>
                                <span class="badge bg-{{ 'success' if results.imap.connection else 'danger' }}">
                                    {{ 'Established' if results.imap.connection else 'Failed' }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td>Authentication:</td>
                            <td>
                                <span class="badge bg-{{ 'success' if results.imap.authentication else 'danger' }}">
                                    {{ 'Success' if results.imap.authentication else 'Failed' }}
                                </span>
                                {% if results.imap.authenticated_user %}
                                    <small class="text-muted d-block">User: {{ results.imap.authenticated_user }}</small>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>Mailbox Access:</td>
                            <td>
                                <span class="badge bg-{{ 'success' if results.imap.mailbox_access else 'danger' }}">
                                    {{ 'Granted' if results.imap.mailbox_access else 'Denied' }}
                                </span>
                            </td>
                        </tr>
                        {% if results.imap.inbox_message_count is defined %}
                        <tr>
                            <td>Inbox Messages:</td>
                            <td>{{ results.imap.inbox_message_count }}</td>
                        </tr>
                        {% endif %}
                        {% if results.imap.folder_count %}
                        <tr>
                            <td>Total Folders:</td>
                            <td>{{ results.imap.folder_count }}</td>
                        </tr>
                        {% endif %}
                    </table>

                    {% if results.imap.folder_list %}
                    <h6 class="mt-3">Available Folders (First 10):</h6>
                    <ul class="list-unstyled">
                        {% for folder in results.imap.folder_list %}
                        <li><i class="fas fa-folder"></i> {{ folder }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}

                    {% if results.imap.error %}
                    <div class="alert alert-danger">
                        <strong>Error:</strong> {{ results.imap.error }}
                    </div>
                    {% endif %}

                    {% if results.imap.auth_error %}
                    <div class="alert alert-warning">
                        <strong>Authentication Error:</strong> {{ results.imap.auth_error }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Test Email Section -->
    {% if results.summary.smtp_ok %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-vial"></i> Send Test Email
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('test_email_send') }}">
                        <div class="row">
                            <div class="col-md-8">
                                <input type="email" name="to_address" class="form-control" 
                                       placeholder="Enter recipient email (leave blank to use configured address)">
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i> Send Test Email
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Instructions -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle"></i> Configuration Instructions
                    </h5>
                </div>
                <div class="card-body">
                    <h6>To configure email settings:</h6>
                    <ol>
                        <li>Copy <code>.env.example</code> to <code>.env</code></li>
                        <li>Edit <code>.env</code> and add your email credentials</li>
                        <li>For Gmail:
                            <ul>
                                <li>Enable 2-factor authentication</li>
                                <li>Generate an app-specific password</li>
                                <li>Use the app password instead of your regular password</li>
                            </ul>
                        </li>
                        <li>Restart the application after updating <code>.env</code></li>
                    </ol>

                    <h6 class="mt-3">Common Email Providers:</h6>
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Provider</th>
                                <th>SMTP Host</th>
                                <th>SMTP Port</th>
                                <th>IMAP Host</th>
                                <th>IMAP Port</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Gmail</td>
                                <td>smtp.gmail.com</td>
                                <td>587 (TLS)</td>
                                <td>imap.gmail.com</td>
                                <td>993 (SSL)</td>
                            </tr>
                            <tr>
                                <td>Outlook</td>
                                <td>smtp-mail.outlook.com</td>
                                <td>587 (TLS)</td>
                                <td>outlook.office365.com</td>
                                <td>993 (SSL)</td>
                            </tr>
                            <tr>
                                <td>Yahoo</td>
                                <td>smtp.mail.yahoo.com</td>
                                <td>587 (TLS)</td>
                                <td>imap.mail.yahoo.com</td>
                                <td>993 (SSL)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-refresh diagnostics every 30 seconds if not ready
{% if not results.summary.ready_to_use %}
setTimeout(function() {
    location.reload();
}, 30000);
{% endif %}
</script>
{% endblock %}