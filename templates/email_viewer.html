{% extends "base.html" %}
{% block title %}Email Viewer - Email Management Tool{% endblock %}
{% block extra_css %}
<style>
  .email-viewer {
    background: linear-gradient(145deg, #1a1a1a 0%, #1f1f1f 60%, #242424 100%);
    border-radius: 18px;
    padding: 25px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.6);
    border: 1px solid rgba(255,255,255,0.06);
  }

  .email-header {
    border-bottom: 2px solid rgba(255,255,255,0.1);
    padding-bottom: 20px;
    margin-bottom: 20px;
  }

  .email-subject {
    font-size: 1.5rem;
    font-weight: 600;
    color: #ffffff;
    margin-bottom: 15px;
  }

  .email-subject.editable {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 8px;
    padding: 10px;
    width: 100%;
  }

  .email-meta {
    display: grid;
    gap: 10px;
  }

  .meta-row {
    display: flex;
    align-items: baseline;
  }

  .meta-label {
    font-weight: 600;
    color: #9ca3af;
    min-width: 80px;
    margin-right: 10px;
  }

  .meta-value {
    color: #ffffff;
    flex: 1;
  }

  .email-actions {
    display: flex;
    gap: 10px;
    margin: 20px 0;
    padding: 15px;
    background: rgba(255,255,255,0.03);
    border-radius: 12px;
    flex-wrap: wrap;
  }

  .action-btn {
    padding: 10px 20px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.06);
    color: #ffffff;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .action-btn:hover {
    background: rgba(255,255,255,0.12);
    transform: translateY(-2px);
  }

  .action-btn.primary {
    background: var(--bs-primary);
    border: none;
  }

  .action-btn.danger {
    background: rgba(220,38,38,0.8);
    border: none;
  }

  .action-btn.success {
    background: rgba(16,185,129,0.8);
    border: none;
  }

  .email-body {
    padding: 20px;
    background: rgba(255,255,255,0.03);
    border-radius: 12px;
    margin-top: 20px;
    min-height: 300px;
  }

  .body-toggle {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
  }

  .toggle-btn {
    padding: 5px 15px;
    border-radius: 6px;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.12);
    color: #9ca3af;
    cursor: pointer;
  }

  .toggle-btn.active {
    background: var(--bs-primary);
    border-color: var(--bs-primary);
    color: #ffffff;
  }

  .email-content {
    color: #ffffff;
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .email-content.editable {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 8px;
    padding: 15px;
    width: 100%;
    min-height: 400px;
    font-family: monospace;
    resize: vertical;
  }

  .email-html-content {
    background: #ffffff;
    border-radius: 8px;
    padding: 20px;
    color: #000000;
  }

  .attachments-section {
    margin-top: 20px;
    padding: 15px;
    background: rgba(255,255,255,0.03);
    border-radius: 12px;
  }

  .attachment-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px;
    background: rgba(255,255,255,0.06);
    border-radius: 8px;
    margin: 5px 0;
  }

  .edit-mode-banner {
    background: rgba(251,191,36,0.1);
    border: 1px solid rgba(251,191,36,0.3);
    color: #fbbf24;
    padding: 12px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: none;
    align-items: center;
    gap: 15px;
  }

  .edit-mode-banner.active {
    display: flex;
  }

  .edit-mode-banner i {
    font-size: 1.2rem;
  }

  .edit-mode-actions {
    margin-left: auto;
    display: flex;
    gap: 10px;
  }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <h1><i class="bi bi-envelope-open"></i> Email Viewer</h1>
    <p class="text-muted mb-0">View email message details and content.</p>
  </div>
  <div class="header-actions">
    <a href="/inbox" class="btn btn-ghost btn-sm">
      <i class="bi bi-arrow-left"></i> Back to Inbox
    </a>
  </div>
</div>

<div class="email-viewer">
  <!-- Edit Mode Banner -->
  <div class="edit-mode-banner" id="editModeBanner">
    <i class="bi bi-pencil-square"></i>
    <span>Editing mode - Make changes below and save when done</span>
    <div class="edit-mode-actions">
      <button class="btn btn-ghost btn-sm" onclick="cancelEdit()">
        <i class="bi bi-x-circle"></i> Cancel
      </button>
      <button class="btn btn-secondary btn-sm" onclick="saveEdit()">
        <i class="bi bi-save"></i> Save Changes
      </button>
      <button class="btn btn-success btn-sm" id="saveAndReleaseBtn" onclick="saveAndRelease()" style="display:none;">
        <i class="bi bi-check-circle"></i> Save & Release
      </button>
    </div>
  </div>

  <!-- Email Header -->
  <div class="email-header">
    <input type="text" id="emailSubject" class="email-subject" value="{{ email.subject or 'No Subject' }}" readonly>
    <div class="email-meta">
      <div class="meta-row">
        <span class="meta-label">From:</span>
        <span class="meta-value">{{ email.sender }}</span>
      </div>
      <div class="meta-row">
        <span class="meta-label">To:</span>
        <span class="meta-value">
          {% if email.recipients is string %}
            {{ email.recipients }}
          {% elif email.recipients %}
            {{ email.recipients|join(', ') }}
          {% else %}
            (none)
          {% endif %}
        </span>
      </div>
      <div class="meta-row">
        <span class="meta-label">Date:</span>
        <span class="meta-value">{{ email.created_at }}</span>
      </div>
      <div class="meta-row">
        <span class="meta-label">Status:</span>
        <span class="status-badge status-{{ email.interception_status or email.status }}">
          {{ email.interception_status or email.status or 'UNKNOWN' }}
        </span>
      </div>
      {% if (email.interception_status or '') == 'HELD' %}
      <div class="alert alert-warning mt-2" role="alert">
        <strong>HELD</strong> â€” Not visible in recipient's mailbox until release
      </div>
      {% endif %}
      {% if email.account_id %}
      <div class="meta-row">
        <span class="meta-label">Account:</span>
        <span class="meta-value">Account #{{ email.account_id }}</span>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Email Actions -->
  <div class="email-actions">
    <button class="action-btn primary" onclick="replyEmail({{ email.id }})">
      <i class="bi bi-reply"></i> Reply
    </button>
    <button class="action-btn primary" onclick="forwardEmail({{ email.id }})">
      <i class="bi bi-forward"></i> Forward
    </button>
    <button class="action-btn success" onclick="downloadEmail({{ email.id }})">
      <i class="bi bi-download"></i> Download
    </button>
    {% if email.interception_status != 'HELD' %}
    <button class="action-btn danger" onclick="interceptEmail({{ email.id }})">
      <i class="bi bi-hand-stop"></i> Intercept
    </button>
    {% else %}
    <button class="action-btn success" onclick="editEmail({{ email.id }}, true)">
      <i class="bi bi-check-circle"></i> Edit & Release
    </button>
    <button class="action-btn" onclick="editEmail({{ email.id }}, false)">
      <i class="bi bi-pencil"></i> Edit
    </button>
    <button class="action-btn" onclick="releaseEmail({{ email.id }})">
      <i class="bi bi-send-check"></i> Quick Release
    </button>
    <button class="action-btn danger" onclick="discardEmail({{ email.id }})">
      <i class="bi bi-trash"></i> Discard
    </button>
    {% endif %}
  </div>

  <!-- Email Body -->
  <div class="email-body">
    <div class="body-toggle">
      <button class="toggle-btn active" onclick="showTextBody()">Text</button>
      <button class="toggle-btn" onclick="showHtmlBody()">HTML</button>
      <button class="toggle-btn" onclick="showRawBody()">Raw</button>
    </div>

    <div id="textBody">
      <textarea id="emailBodyText" class="email-content" readonly>{{ email.body_text or 'No text content' }}</textarea>
    </div>

    <div id="htmlBody" class="email-html-content" style="display:none;">
      {% if email.body_html %}
        <iframe srcdoc="{{ email.body_html | e }}" style="width:100%; height:500px; border:none;"></iframe>
      {% else %}
        No HTML content
      {% endif %}
    </div>

    <div id="rawBody" style="display:none;">
      <textarea id="emailRawContent" class="email-content" readonly style="font-family:monospace; font-size:0.9rem;">{{ email.raw_content[:5000] if email.raw_content else 'No raw content available' }}</textarea>
    </div>
  </div>

  <!-- Attachments if any -->
  {% if email.attachments %}
  <div class="attachments-section">
    <h3 style="color:#ffffff; margin-bottom:10px;">Attachments</h3>
    {% for attachment in email.attachments %}
    <div class="attachment-item">
      <span>{{ attachment.filename }}</span>
      <button class="action-btn" onclick="downloadAttachment({{ attachment.id }})">
        <i class="bi bi-download"></i>
      </button>
    </div>
    {% endfor %}
  </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
let isEditMode = false;
let emailId = {{ email.id }};
let releaseAfterSave = false;

function showTextBody() {
  document.getElementById('textBody').style.display = 'block';
  document.getElementById('htmlBody').style.display = 'none';
  document.getElementById('rawBody').style.display = 'none';
  updateToggleButtons(0);
}

function showHtmlBody() {
  document.getElementById('textBody').style.display = 'none';
  document.getElementById('htmlBody').style.display = 'block';
  document.getElementById('rawBody').style.display = 'none';
  updateToggleButtons(1);
}

function showRawBody() {
  document.getElementById('textBody').style.display = 'none';
  document.getElementById('htmlBody').style.display = 'none';
  document.getElementById('rawBody').style.display = 'block';
  updateToggleButtons(2);
}

function updateToggleButtons(activeIndex) {
  const buttons = document.querySelectorAll('.toggle-btn');
  buttons.forEach((btn, idx) => {
    if (idx === activeIndex) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });
}

async function replyEmail(emailId) {
  const response = await fetch(`/api/email/${emailId}/reply-forward?action=reply`);
  const data = await response.json();
  if (data.success) {
    localStorage.setItem('emailDraft', JSON.stringify(data.data));
    window.location.href = '/compose';
  }
}

async function forwardEmail(emailId) {
  const response = await fetch(`/api/email/${emailId}/reply-forward?action=forward`);
  const data = await response.json();
  if (data.success) {
    localStorage.setItem('emailDraft', JSON.stringify(data.data));
    window.location.href = '/compose';
  }
}

function downloadEmail(emailId) {
  window.location.href = `/api/email/${emailId}/download`;
}

async function interceptEmail(emailId) {
  const response = await fetch(`/api/email/${emailId}/intercept`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'}
  });

  const data = await response.json();
  if (data.success) {
    showSuccess('Email intercepted and moved to HELD status');
    setTimeout(() => window.location.reload(), 1000);
  } else {
    showError(data.error || 'Failed to intercept email');
  }
}

async function releaseEmail(emailId) {
  try {
    const response = await fetch(`/api/interception/release/${emailId}`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({target_folder: 'INBOX'})
    });

    let data = null;
    try {
      data = await response.json();
    } catch (err) {
      data = null;
    }

    if (!response.ok || !(data && (data.ok || data.success))) {
      const reason = data && (data.error || data.reason) ? (data.error || data.reason) : `Request failed with status ${response.status}`;
      throw new Error(reason);
    }

    showSuccess('Email released to inbox');
    setTimeout(() => window.location.reload(), 1000);
  } catch (error) {
    console.error('Error releasing email:', error);
    showError(error.message || 'Failed to release email');
  }
}

async function discardEmail(emailId) {
  if (confirm('Are you sure you want to discard this email?')) {
    try {
      const response = await fetch(`/api/interception/discard/${emailId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
      });

      const data = await response.json();
      if (data.success || data.ok) {
        showSuccess('Email discarded');
        setTimeout(() => window.location.href = '/interception', 1000);
      } else {
        showError(data.error || 'Failed to discard email');
      }
    } catch (error) {
      showError('Failed to discard email');
    }
  }
}

function editEmail(id, releaseMode = false) {
  releaseAfterSave = releaseMode;
  isEditMode = true;

  // Show edit mode banner
  document.getElementById('editModeBanner').classList.add('active');

  // Make fields editable
  const subjectField = document.getElementById('emailSubject');
  const bodyField = document.getElementById('emailBodyText');

  subjectField.readOnly = false;
  subjectField.classList.add('editable');
  bodyField.readOnly = false;
  bodyField.classList.add('editable');

  // Show save & release button if in release mode
  if (releaseMode) {
    document.getElementById('saveAndReleaseBtn').style.display = 'inline-flex';
  }

  // Focus on subject field
  subjectField.focus();

  showSuccess('Edit mode enabled - make your changes and save');
}

function cancelEdit() {
  if (confirm('Cancel editing? Any unsaved changes will be lost.')) {
    window.location.reload();
  }
}

async function saveEdit() {
  const subject = document.getElementById('emailSubject').value;
  const bodyText = document.getElementById('emailBodyText').value;

  try {
    const response = await fetch(`/api/email/${emailId}/edit`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        subject: subject,
        body_text: bodyText
      })
    });

    const data = await response.json();
    if (data.success) {
      showSuccess('Email saved successfully');
      setTimeout(() => window.location.reload(), 1000);
    } else {
      showError(data.error || 'Failed to save changes');
    }
  } catch (error) {
    showError('Failed to save changes');
  }
}

async function saveAndRelease() {
  const subject = document.getElementById('emailSubject').value;
  const bodyText = document.getElementById('emailBodyText').value;

  try {
    // First save the edit
    const editResponse = await fetch(`/api/email/${emailId}/edit`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        subject: subject,
        body_text: bodyText
      })
    });

    const editData = await editResponse.json();
    if (!editData.success) {
      showError(editData.error || 'Failed to save changes');
      return;
    }

    // Then release the email
    const releaseResponse = await fetch(`/api/interception/release/${emailId}`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({target_folder: 'INBOX'})
    });

    const releaseData = await releaseResponse.json();
    if (releaseData.success || releaseData.ok) {
      showSuccess('Email saved and released to inbox');
      setTimeout(() => window.location.href = '/interception', 1500);
    } else {
      showError(releaseData.error || 'Failed to release email');
    }
  } catch (error) {
    showError('Failed to save and release email');
  }
}

function downloadAttachment(attachmentId) {
  window.location.href = `/api/attachment/${attachmentId}/download`;
}
</script>
{% endblock %}