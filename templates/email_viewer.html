{% extends "base.html" %}
{% block title %}Email Viewer - Email Management Tool{% endblock %}
{% block extra_css %}
<style>
  .email-viewer {
    background: var(--surface-highest);
    border-radius: var(--radius-lg);
    padding: 25px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-subtle);
  }

  .email-header {
    border-bottom: 1px solid var(--border-subtle);
    padding-bottom: 20px;
    margin-bottom: 20px;
  }

  .email-subject {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 15px;
  }

  .email-subject.editable {
    background: var(--surface-base);
    border: 1px solid var(--border-subtle);
    border-radius: 8px;
    padding: 10px;
    width: 100%;
  }

  .email-meta {
    display: grid;
    gap: 10px;
  }

  .meta-row {
    display: flex;
    align-items: baseline;
  }

  .meta-label {
    font-weight: 600;
    color: var(--text-muted);
    min-width: 80px;
    margin-right: 10px;
  }

  .meta-value {
    color: var(--text-secondary);
    flex: 1;
  }

  .email-actions {
    display: flex;
    gap: 10px;
    margin: 20px 0;
    padding: 15px;
    background: var(--surface-base);
    border-radius: var(--radius-md);
    flex-wrap: wrap;
    border: 1px solid var(--border-subtle);
  }

  .action-btn {
    padding: 10px 20px;
    border-radius: 8px;
    border: 1px solid transparent;
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .action-btn:hover {
    transform: translateY(-2px);
  }

  /* Consistent action button colors matching emails-unified */
  .action-btn.primary,
  .action-btn[onclick*="reply"],
  .action-btn[onclick*="forward"] {
    background: rgba(59,130,246,0.16);
    border-color: rgba(59,130,246,0.28);
    color: #93c5fd;
  }

  .action-btn.success,
  .action-btn[onclick*="download"],
  .action-btn[onclick*="release"] {
    background: rgba(16,185,129,0.16);
    border-color: rgba(16,185,129,0.3);
    color: #6ee7b7;
  }

  .action-btn.danger,
  .action-btn[onclick*="discard"],
  .action-btn[onclick*="intercept"] {
    background: rgba(239,68,68,0.16);
    border-color: rgba(239,68,68,0.3);
    color: #fecaca;
  }

  .action-btn[onclick*="edit"] {
    background: rgba(59,130,246,0.16);
    border-color: rgba(59,130,246,0.28);
    color: #93c5fd;
  }

  /* Hover states */
  .action-btn.primary:hover,
  .action-btn[onclick*="reply"]:hover,
  .action-btn[onclick*="forward"]:hover,
  .action-btn[onclick*="edit"]:hover {
    background: rgba(59,130,246,0.24);
  }

  .action-btn.success:hover,
  .action-btn[onclick*="download"]:hover,
  .action-btn[onclick*="release"]:hover {
    background: rgba(16,185,129,0.24);
  }

  .action-btn.danger:hover,
  .action-btn[onclick*="discard"]:hover,
  .action-btn[onclick*="intercept"]:hover {
    background: rgba(239,68,68,0.24);
  }

  .email-body {
    padding: 20px;
    background: var(--surface-base);
    border-radius: var(--radius-md);
    margin-top: 20px;
    min-height: 300px;
  }

  .body-toggle {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
  }

  .toggle-btn {
    padding: 5px 15px;
    border-radius: 6px;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.12);
    color: var(--text-muted);
    cursor: pointer;
  }

  .toggle-btn.active {
    background: var(--bs-primary);
    border-color: var(--bs-primary);
    color: var(--text-primary);
  }

  .email-content {
    color: var(--text-primary);
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
    width: 100%;
    min-height: 400px;
    background: var(--surface-base);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 8px;
    padding: 15px;
    font-family: inherit;
    resize: vertical;
  }

  .email-content.editable {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 8px;
    padding: 15px;
    width: 100%;
    min-height: 400px;
    font-family: monospace;
    resize: vertical;
  }

  .email-html-content {
    background: #ffffff;
    border-radius: 8px;
    padding: 20px;
    color: #000000;
  }

  .attachments-section {
    margin-top: 20px;
    padding: 15px;
    background: var(--surface-base);
    border-radius: var(--radius-md);
  }

  .attachment-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px;
    background: rgba(255,255,255,0.06);
    border-radius: 8px;
    margin: 5px 0;
  }

  .edit-mode-banner {
    background: rgba(251,191,36,0.1);
    border: 1px solid rgba(251,191,36,0.3);
    color: #fbbf24;
    padding: 12px 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: none;
    align-items: center;
    gap: 15px;
  }

  .edit-mode-banner.active {
    display: flex;
  }

  .edit-mode-banner i {
    font-size: 1.2rem;
  }

  .edit-mode-actions {
    margin-left: auto;
    display: flex;
    gap: 10px;
  }

  /* Fix edit mode banner buttons */
  .edit-mode-actions .btn {
    padding: 6px 16px;
    border-radius: 6px;
    border: 1px solid transparent;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
  }

  .edit-mode-actions .btn-ghost {
    background: rgba(255,255,255,0.06);
    border-color: rgba(255,255,255,0.12);
    color: var(--text-muted);
  }

  .edit-mode-actions .btn-ghost:hover {
    background: rgba(255,255,255,0.1);
    color: var(--text-primary);
  }

  .edit-mode-actions .btn-secondary {
    background: rgba(59,130,246,0.16);
    border-color: rgba(59,130,246,0.28);
    color: #93c5fd;
  }

  .edit-mode-actions .btn-secondary:hover {
    background: rgba(59,130,246,0.24);
  }

  .edit-mode-actions .btn-success {
    background: rgba(16,185,129,0.16);
    border-color: rgba(16,185,129,0.3);
    color: #6ee7b7;
  }

  .edit-mode-actions .btn-success:hover {
    background: rgba(16,185,129,0.24);
  }
  /* Overrides & refinements */
  .email-subject { width: 100%; max-width: 100%; }
  .edit-mode-banner { padding: 10px 14px; border-radius: 10px; gap: 12px; margin-bottom: 16px; }
  .edit-mode-actions { gap: 8px; align-items: center; }
  .edit-mode-actions .btn { padding: 6px 14px; font-size: 0.85rem; }
  .body-toggle { display: inline-flex; gap: 0; margin-bottom: 12px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 8px; overflow: hidden; }
  .toggle-btn { padding: 8px 14px; background: transparent; border: 0; color: var(--text-muted); }
  .toggle-btn.active { background: var(--brand-primary-tint); color: var(--text-primary); }
  .email-html-content { background: var(--surface-highest); color: var(--text-primary); border: 1px solid var(--border-subtle); border-radius: 8px; padding: 0; overflow: hidden; }
  .email-html-content iframe { display:block; width:100%; height:560px; border:0; background: var(--surface-base); }
  .email-raw-pre { color: var(--text-primary); background: var(--surface-base); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 12px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 0.9rem; white-space: pre-wrap; word-wrap: break-word; max-height: 520px; overflow: auto; }
  .tech-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:10px; }
  .tech-item { background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); border-radius:8px; padding:10px; }
  .tech-item .label { color: var(--text-muted); font-size: 0.8rem; }
  .tech-item .value { color: var(--text-primary); font-weight: 600; }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <h1><i class="bi bi-envelope-open"></i> Email Viewer</h1>
    <p class="text-muted mb-0">View email message details and content.</p>
  </div>
  <div class="header-actions">
    <a href="/inbox" class="btn btn-ghost btn-sm">
      <i class="bi bi-arrow-left"></i> Back to Inbox
    </a>
  </div>
</div>

<div class="email-viewer">
  <!-- Edit Mode Banner -->
  <div class="edit-mode-banner" id="editModeBanner">
    <i class="bi bi-pencil-square"></i>
    <span>Editing mode - Make changes below and save when done</span>
    <div class="edit-mode-actions">
      <button class="btn btn-ghost btn-sm" onclick="cancelEdit()">
        <i class="bi bi-x-circle"></i> Cancel
      </button>
      <button class="btn btn-secondary btn-sm" onclick="saveEdit()">
        <i class="bi bi-save"></i> Save Changes
      </button>
      <button class="btn btn-success btn-sm" id="saveAndReleaseBtn" onclick="saveAndRelease()" style="display:none;">
        <i class="bi bi-check-circle"></i> Save & Release
      </button>
    </div>
  </div>

  <!-- Email Header -->
  <div class="email-header">
    <input type="text" id="emailSubject" class="email-subject" value="{{ email.subject or 'No Subject' }}" readonly>
    <div class="email-meta">
      <div class="meta-row">
        <span class="meta-label">From:</span>
        <span class="meta-value">{{ email.sender }}</span>
      </div>
      <div class="meta-row">
        <span class="meta-label">To:</span>
        <span class="meta-value">
          {% if email.recipients is string %}
            {{ email.recipients }}
          {% elif email.recipients %}
            {{ email.recipients|join(', ') }}
          {% else %}
            (none)
          {% endif %}
        </span>
      </div>
      <div class="meta-row">
        <span class="meta-label">Date:</span>
        <span class="meta-value">{{ email.created_at }}</span>
      </div>
      <div class="meta-row">
        <span class="meta-label">Status:</span>
        <span class="status-badge status-{{ email.interception_status or email.status }}">
          {{ email.interception_status or email.status or 'UNKNOWN' }}
        </span>
      </div>
      {% if (email.interception_status or '') == 'HELD' %}
      <div class="alert alert-warning mt-2" role="alert">
        <strong>HELD</strong> — Not visible in recipient's mailbox until release
      </div>
      {% endif %}
      {% if email.account_id %}
      <div class="meta-row">
        <span class="meta-label">Account:</span>
        <span class="meta-value">
          {% if email.account_name or email.email_address %}
            {{ email.account_name or 'Account' }}{% if email.email_address %} ({{ email.email_address }}){% endif %}
          {% else %}
            Account #{{ email.account_id }}
          {% endif %}
        </span>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Email Actions -->
  <div class="email-actions">
    <button class="action-btn primary" onclick="replyEmail({{ email.id }})">
      <i class="bi bi-reply"></i> Reply
    </button>
    <button class="action-btn primary" onclick="forwardEmail({{ email.id }})">
      <i class="bi bi-forward"></i> Forward
    </button>
    <button class="action-btn success" onclick="downloadEmail({{ email.id }})">
      <i class="bi bi-download"></i> Download
    </button>
    {% if email.interception_status != 'HELD' %}
    <button class="action-btn danger" onclick="interceptEmail({{ email.id }})">
      <i class="bi bi-hand-stop"></i> Intercept
    </button>
    {% else %}
    <button class="action-btn success" onclick="editEmail({{ email.id }}, true)">
      <i class="bi bi-check-circle"></i> Edit & Release
    </button>
    <button class="action-btn" onclick="editEmail({{ email.id }}, false)">
      <i class="bi bi-pencil"></i> Edit
    </button>
    <button class="action-btn" onclick="releaseEmail({{ email.id }})">
      <i class="bi bi-send-check"></i> Quick Release
    </button>
    <button class="action-btn danger" onclick="discardEmail({{ email.id }})">
      <i class="bi bi-trash"></i> Discard
    </button>
    {% endif %}
  </div>

  <!-- Email Body -->
  <div class="email-body">
    <div class="body-toggle">
      <button class="toggle-btn active" onclick="showTextBody()">Text</button>
      <button class="toggle-btn" onclick="showHtmlBody()">HTML</button>
      <button class="toggle-btn" onclick="showRawBody()">Raw</button>
      <button class="toggle-btn" onclick="showDetails()">Details</button>
    </div>

    <div id="textBody">
      <textarea id="emailBodyText" class="email-content" readonly>{{ email.body_text or 'No text content' }}</textarea>
    </div>

    <div id="htmlBody" class="email-html-content" style="display:none;">
      {% if email.body_html %}
        <iframe srcdoc="{{ email.body_html | e }}"></iframe>
      {% else %}
        <div style="padding:16px; color: var(--text-secondary);">No HTML content</div>
      {% endif %}
    </div>

    <div id="rawBody" style="display:none;">
      <pre id="emailRawContent" class="email-raw-pre">{{ email.raw_content[:5000] if email.raw_content else 'No raw content available' }}</pre>
    </div>

    <div id="detailsBody" style="display:none;">
      <div id="techDetails" class="tech-grid"></div>
    </div>
  </div>

  <div id="viewerAttachments" class="panel-card attachments-card mt-4" data-visible="{{ 'true' if attachments_flags.ui else 'false' }}">
    <div class="panel-header">
      <div class="panel-title"><i class="bi bi-paperclip"></i> Attachments</div>
    </div>
    <div class="panel-body attachments-panel-body">
      <div id="viewerAttachmentsSkeleton" class="attachments-skeleton hidden"></div>
      <div id="viewerAttachmentsList" class="attachments-list"></div>
      <div id="viewerAttachmentsEmpty" class="attachments-empty text-muted">No attachments</div>
    </div>
  </div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let isEditMode = false;
let emailId = {{ email.id }};
let releaseAfterSave = false;

function showTextBody() {
  document.getElementById('textBody').style.display = 'block';
  document.getElementById('htmlBody').style.display = 'none';
  document.getElementById('rawBody').style.display = 'none';
  updateToggleButtons(0);
}

function showHtmlBody() {
  document.getElementById('textBody').style.display = 'none';
  document.getElementById('htmlBody').style.display = 'block';
  document.getElementById('rawBody').style.display = 'none';
  updateToggleButtons(1);
}

function showRawBody() {
  document.getElementById('textBody').style.display = 'none';
  document.getElementById('htmlBody').style.display = 'none';
  document.getElementById('rawBody').style.display = 'block';
  document.getElementById('detailsBody').style.display = 'none';
  updateToggleButtons(2);
}

function showDetails() {
  document.getElementById('textBody').style.display = 'none';
  document.getElementById('htmlBody').style.display = 'none';
  document.getElementById('rawBody').style.display = 'none';
  document.getElementById('detailsBody').style.display = 'block';
  updateToggleButtons(3);
  buildTechDetails();
}

function buildTechDetails() {
  const container = document.getElementById('techDetails');
  if (!container) return;
  container.innerHTML = '';
  try {
    const raw = document.getElementById('emailRawContent').textContent || '';
    const lines = raw.split(/\r?\n/);
    const headers = {};
    let headerDone = false;
    for (const line of lines) {
      if (!headerDone && line.trim() === '') { headerDone = true; continue; }
      if (headerDone) break;
      const idx = line.indexOf(':');
      if (idx > 0) {
        const key = line.slice(0, idx).trim();
        const val = line.slice(idx + 1).trim();
        if (!headers[key]) headers[key] = [];
        headers[key].push(val);
      }
    }
    const get = (k) => (headers[k] ? headers[k].join(' | ') : '—');
    const received = (headers['Received'] || []).join('\n\n');
    const ipMatch = received.match(/\b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b/);
    const firstIp = ipMatch ? ipMatch[0] : '—';
    const fields = [
      ['Message-ID', get('Message-ID')],
      ['From', get('From')],
      ['To', get('To')],
      ['Subject', get('Subject')],
      ['Date', get('Date')],
      ['MIME-Version', get('MIME-Version')],
      ['Content-Type', get('Content-Type')],
      ['Content-Transfer-Encoding', get('Content-Transfer-Encoding')],
      ['Sender IP (from Received)', firstIp],
    ];
    for (const [label, value] of fields) {
      const item = document.createElement('div');
      item.className = 'tech-item';
      item.innerHTML = `<div class="label">${label}</div><div class="value">${value ? value.replace(/</g,'&lt;').replace(/>/g,'&gt;') : '—'}</div>`;
      container.appendChild(item);
    }
  } catch (e) {
    const item = document.createElement('div');
    item.className = 'tech-item';
    item.innerHTML = `<div class="label">Error</div><div class="value">Failed to parse headers</div>`;
    container.appendChild(item);
  }
}

function updateToggleButtons(activeIndex) {
  const buttons = document.querySelectorAll('.toggle-btn');
  buttons.forEach((btn, idx) => {
    if (idx === activeIndex) {
      btn.classList.add('active');
    } else {
      btn.classList.remove('active');
    }
  });
}

async function replyEmail(emailId) {
  const response = await fetch(`/api/email/${emailId}/reply-forward?action=reply`);
  const data = await response.json();
  if (data.success) {
    localStorage.setItem('emailDraft', JSON.stringify(data.data));
    window.location.href = '/compose';
  }
}

async function forwardEmail(emailId) {
  const response = await fetch(`/api/email/${emailId}/reply-forward?action=forward`);
  const data = await response.json();
  if (data.success) {
    localStorage.setItem('emailDraft', JSON.stringify(data.data));
    window.location.href = '/compose';
  }
}

function downloadEmail(emailId) {
  window.location.href = `/api/email/${emailId}/download`;
}

async function interceptEmail(emailId) {
  const response = await fetch(`/api/email/${emailId}/intercept`, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'}
  });

  const data = await response.json();
  if (data.success) {
    showSuccess('Email intercepted and moved to HELD status');
    setTimeout(() => window.location.reload(), 1000);
  } else {
    showError(data.error || 'Failed to intercept email');
  }
}

async function releaseEmail(emailId) {
  try {
    const response = await fetch(`/api/interception/release/${emailId}`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({target_folder: 'INBOX'})
    });

    let data = null;
    try {
      data = await response.json();
    } catch (err) {
      data = null;
    }

    if (!response.ok || !(data && (data.ok || data.success))) {
      const reason = data && (data.error || data.reason) ? (data.error || data.reason) : `Request failed with status ${response.status}`;
      throw new Error(reason);
    }

    showSuccess('Email released to inbox');
    setTimeout(() => window.location.reload(), 1000);
  } catch (error) {
    console.error('Error releasing email:', error);
    showError(error.message || 'Failed to release email');
  }
}

async function discardEmail(emailId) {
  if (confirm('Are you sure you want to discard this email?')) {
    try {
      const response = await fetch(`/api/interception/discard/${emailId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
      });

      const data = await response.json();
      if (data.success || data.ok) {
        showSuccess('Email discarded');
        setTimeout(() => window.location.href = '/interception', 1000);
      } else {
        showError(data.error || 'Failed to discard email');
      }
    } catch (error) {
      showError('Failed to discard email');
    }
  }
}

function editEmail(id, releaseMode = false) {
  releaseAfterSave = releaseMode;
  isEditMode = true;

  // Show edit mode banner
  document.getElementById('editModeBanner').classList.add('active');

  // Make fields editable
  const subjectField = document.getElementById('emailSubject');
  const bodyField = document.getElementById('emailBodyText');

  subjectField.readOnly = false;
  subjectField.classList.add('editable');
  bodyField.readOnly = false;
  bodyField.classList.add('editable');

  // Show save & release button if in release mode
  if (releaseMode) {
    document.getElementById('saveAndReleaseBtn').style.display = 'inline-flex';
  }

  // Focus on subject field
  subjectField.focus();

  showSuccess('Edit mode enabled - make your changes and save');
}

function cancelEdit() {
  if (confirm('Cancel editing? Any unsaved changes will be lost.')) {
    window.location.reload();
  }
}

async function saveEdit() {
  const subject = document.getElementById('emailSubject').value;
  const bodyText = document.getElementById('emailBodyText').value;

  try {
    const response = await fetch(`/api/email/${emailId}/edit`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        subject: subject,
        body_text: bodyText
      })
    });

    const data = await response.json();
    if (data && (data.ok || data.success)) {
      showSuccess('Email saved successfully');
      setTimeout(() => window.location.reload(), 1000);
    } else {
      showError((data && (data.error || data.reason)) || 'Failed to save changes');
    }
  } catch (error) {
    showError('Failed to save changes');
  }
}

document.addEventListener('DOMContentLoaded', () => {
  if (window.MailAttach) {
    window.MailAttach.render({
      emailId,
      container: document.getElementById('viewerAttachments'),
      listElement: document.getElementById('viewerAttachmentsList'),
      emptyElement: document.getElementById('viewerAttachmentsEmpty'),
      skeletonElement: document.getElementById('viewerAttachmentsSkeleton')
    });
  }
});

async function saveAndRelease() {
  const subject = document.getElementById('emailSubject').value;
  const bodyText = document.getElementById('emailBodyText').value;

  try {
    // First save the edit
    const editResponse = await fetch(`/api/email/${emailId}/edit`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        subject: subject,
        body_text: bodyText
      })
    });

    const editData = await editResponse.json();
    if (!(editData && (editData.ok || editData.success))) {
      showError((editData && (editData.error || editData.reason)) || 'Failed to save changes');
      return;
    }

    // Then release the email, sending the edited content for atomicity
    const releaseResponse = await fetch(`/api/interception/release/${emailId}`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({target_folder: 'INBOX', edited_subject: subject, edited_body: bodyText})
    });

    const releaseData = await releaseResponse.json();
    if (releaseData && (releaseData.success || releaseData.ok)) {
      showSuccess('Email saved and released to inbox');
      setTimeout(() => window.location.href = '/interception', 1500);
    } else {
      showError((releaseData && (releaseData.error || releaseData.reason)) || 'Failed to release email');
    }
  } catch (error) {
    showError('Failed to save and release email');
  }
}

function downloadAttachment(attachmentId) {
  if (window.MailAttach && typeof window.MailAttach.download === 'function') {
    window.MailAttach.download(attachmentId);
  } else {
    window.location.href = `/api/attachment/${attachmentId}/download`;
  }
}
</script>
{% endblock %}

