{% extends 'base.html' %}

{% block extra_css %}
<style>
  /* Note: btn-secondary and btn-ghost styling now in main.css */

  /* Form styling to match modern theme */
  .form-control {
    background: rgba(255, 255, 255, 0.06) !important;
    border: 1px solid var(--color-border) !important;
    color: var(--color-text) !important;
    border-radius: var(--radius-md) !important;
    padding: 12px 15px !important;
    font-size: 0.95rem;
    transition: all 0.2s ease;
  }

  .form-control:focus {
    background: rgba(255, 255, 255, 0.08) !important;
    border-color: rgba(220, 38, 38, 0.4) !important;
    box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1) !important;
    outline: none;
  }

  .form-label {
    color: var(--color-text) !important;
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 0.9rem;
  }

  /* Modern checkbox styling */
  .form-check {
    padding: 15px 0;
    margin-top: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .form-check-input {
    width: 20px;
    height: 20px;
    margin: 0;
    flex-shrink: 0;
    cursor: pointer;
    background-color: rgba(255, 255, 255, 0.06) !important;
    border: 2px solid var(--color-border) !important;
  }

  .form-check-input:checked {
    background-color: rgba(220, 38, 38, 0.8) !important;
    border-color: rgba(220, 38, 38, 0.8) !important;
  }

  .form-check-label {
    color: var(--color-text) !important;
    font-weight: 500;
    margin: 0;
    cursor: pointer;
    font-size: 0.95rem;
  }

  /* Code element styling to match theme */
  code {
    background: rgba(220, 38, 38, 0.12);
    color: #fca5a5;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: var(--font-mono);
    font-size: 0.85em;
    border: 1px solid rgba(220, 38, 38, 0.2);
  }

  /* Info box styling */
  .info-box {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: 16px 18px;
    margin-bottom: 20px;
    line-height: 1.7;
  }

  .info-box p {
    margin: 0;
  }

  .info-box strong {
    color: var(--color-text);
    font-weight: 600;
  }

  /* Result panel */
  .alert {
    padding: 12px 15px;
    border-radius: var(--radius-md);
    margin-top: 12px;
    border: 1px solid var(--color-border);
  }

  .alert-info {
    background: rgba(59, 130, 246, 0.15);
    border-color: rgba(59, 130, 246, 0.4);
    color: #93c5fd;
  }

  /* Panel styling */
  .panel-body {
    padding: 20px;
  }

  /* Fix form container padding */
  .form-container {
    padding: 0;
  }
</style>
{% endblock %}

{% block content %}
<div class="page-header mb-4">
  <div>
    <h2><i class="bi bi-cloud-upload"></i> Import Accounts</h2>
    <p class="text-muted mb-0">Bulk import email accounts from a CSV file.</p>
  </div>
  <div class="header-actions">
    <button class="btn btn-secondary btn-sm" type="button" id="downloadTemplate">
      <i class="bi bi-download"></i> Download Template
    </button>
    <a class="btn btn-ghost btn-sm" href="{{ url_for('accounts.email_accounts') }}">
      <i class="bi bi-arrow-left"></i> Back to Accounts
    </a>
  </div>
</div>

<div class="panel">
  <div class="panel-header">
    <div class="panel-title">CSV Import</div>
  </div>
  <div class="panel-body">
    <div class="info-box">
      <p>
        <strong>Upload a CSV to add or update accounts.</strong><br>
        <br>
        <strong>Required columns:</strong><br>
        <code>email_address</code>, <code>imap_password</code>, <code>smtp_password</code><br>
        <br>
        <strong>Optional columns:</strong><br>
        <code>account_name</code>, <code>imap_host</code>, <code>imap_port</code>, <code>imap_use_ssl</code>,<br>
        <code>smtp_host</code>, <code>smtp_port</code>, <code>smtp_use_ssl</code>, <code>imap_username</code>,<br>
        <code>smtp_username</code>, <code>is_active</code>
      </p>
    </div>

    <form id="importForm" action="{{ url_for('accounts.api_import_accounts') }}" method="post" enctype="multipart/form-data" class="mt-2">
      <div class="mb-3">
        <label class="form-label">CSV File</label>
        <input class="form-control" type="file" name="file" accept=".csv" required />
      </div>

      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" name="auto_detect" id="auto_detect" checked>
        <label class="form-check-label" for="auto_detect">
          Auto-detect server settings when missing
        </label>
      </div>

      <div class="d-flex gap-2">
        <button class="btn btn-secondary" type="submit">
          <i class="bi bi-upload"></i> Import Accounts
        </button>
      </div>
    </form>

    <div id="resultPanel" class="mt-3" style="display:none;">
      <div class="alert alert-info" id="resultText"></div>
    </div>
  </div>
</div>

<script>
  // Download sample CSV template (client-side generated)
  document.getElementById('downloadTemplate')?.addEventListener('click', function () {
    const csv = 'email_address,imap_password,smtp_password,account_name,imap_host,imap_port,imap_use_ssl,smtp_host,smtp_port,smtp_use_ssl,imap_username,smtp_username,is_active\nuser@example.com,app-password-here,app-password-here,Example Account,,,1,,,1,,,1\n';
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'accounts_template.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    if (window.showSuccess) {
      showSuccess('Template downloaded successfully');
    }
  });

  // AJAX import with toasts
  const form = document.getElementById('importForm');
  form?.addEventListener('submit', async function (e) {
    e.preventDefault();
    const fd = new FormData(form);

    // Show loading toast
    if (window.showInfo) {
      showInfo('Importing accounts...');
    }

    try {
      const resp = await fetch(form.action, { method: 'POST', body: fd });
      const data = await resp.json();

      if (!resp.ok || data.success === false) {
        const msg = (data && (data.error || data.message)) || ('Import failed (' + resp.status + ')');
        if (window.showError) showError(msg);
        document.getElementById('resultText').textContent = msg;
        document.getElementById('resultPanel').style.display = '';
        return;
      }

      const summary = `Inserted: ${data.inserted || 0} • Updated: ${data.updated || 0} • Errors: ${data.errors || 0}`;
      if (window.showSuccess) showSuccess('Import complete — ' + summary);
      document.getElementById('resultText').textContent = summary;
      document.getElementById('resultPanel').style.display = '';

      // Reset form on success
      if (data.inserted > 0 || data.updated > 0) {
        form.reset();
      }
    } catch (err) {
      const msg = 'Import error: ' + (err && err.message ? err.message : String(err));
      if (window.showError) showError(msg);
      document.getElementById('resultText').textContent = msg;
      document.getElementById('resultPanel').style.display = '';
    }
  });
</script>
{% endblock %}
