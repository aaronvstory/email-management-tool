{% extends "base.html" %}

{% block title %}Compose Email - Email Management Tool{% endblock %}

{% block extra_css %}
<style>
    .compose-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 30px;
        max-width: 800px;
        margin: 0 auto;
    }
    
    .compose-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px 10px 0 0;
        margin: -30px -30px 30px -30px;
    }
    
    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
    }
    
    .form-control, .form-select {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 10px 15px;
        transition: border-color 0.3s;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .btn-send {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: 500;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .btn-send:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        color: white;
    }
    
    .btn-cancel {
        background-color: #6c757d;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: 500;
        transition: background-color 0.2s;
    }
    
    .btn-cancel:hover {
        background-color: #5a6268;
        color: white;
    }
    
    .char-counter {
        font-size: 0.85rem;
        color: #6c757d;
        text-align: right;
        margin-top: 5px;
    }
    
    .required-field::after {
        content: " *";
        color: #dc3545;
    }
    
    .help-text {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 5px;
    }
    
    .email-toolbar {
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 10px;
        margin-bottom: 10px;
    }
    
    .toolbar-btn {
        background: transparent;
        border: 1px solid #dee2e6;
        padding: 5px 10px;
        margin-right: 5px;
        border-radius: 4px;
        color: #495057;
        transition: all 0.2s;
    }
    
    .toolbar-btn:hover {
        background-color: #f8f9fa;
        border-color: #667eea;
        color: #667eea;
    }
</style>
{% endblock %}

{% block content %}
<div class="compose-container">
    <div class="compose-header">
        <h2><i class="bi bi-envelope-plus"></i> Compose New Email</h2>
    </div>
    
    <form method="POST" action="/compose" id="composeForm">
        <!-- From Account Selection -->
        <div class="mb-4">
            <label for="from_account" class="form-label required-field">From Account</label>
            <select class="form-select" id="from_account" name="from_account" required>
                <option value="">Select sending account...</option>
                {% for account in accounts %}
                <option value="{{ account.id }}">
                    {{ account.account_name }} ({{ account.email_address }})
                </option>
                {% endfor %}
            </select>
            <div class="help-text">Select which email account to send from</div>
        </div>
        
        <!-- To Address -->
        <div class="mb-4">
            <label for="to" class="form-label required-field">To</label>
            <input type="email" class="form-control" id="to" name="to" 
                   placeholder="recipient@example.com" required>
            <div class="help-text">Enter recipient's email address</div>
        </div>
        
        <!-- CC Address (Optional) -->
        <div class="mb-4">
            <label for="cc" class="form-label">CC</label>
            <input type="text" class="form-control" id="cc" name="cc" 
                   placeholder="cc1@example.com, cc2@example.com">
            <div class="help-text">Optional: Enter CC recipients (comma-separated for multiple)</div>
        </div>
        
        <!-- Subject -->
        <div class="mb-4">
            <label for="subject" class="form-label required-field">Subject</label>
            <input type="text" class="form-control" id="subject" name="subject" 
                   placeholder="Enter email subject" required maxlength="200">
            <div class="char-counter">
                <span id="subjectCounter">0</span> / 200 characters
            </div>
        </div>
        
        <!-- Email Body -->
        <div class="mb-4">
            <label for="body" class="form-label required-field">Message</label>
            
            <!-- Simple Toolbar -->
            <div class="email-toolbar">
                <button type="button" class="toolbar-btn" onclick="insertText('body', 'Dear Sir/Madam,\n\n')" title="Formal Greeting">
                    <i class="bi bi-person-badge"></i> Formal
                </button>
                <button type="button" class="toolbar-btn" onclick="insertText('body', 'Hi,\n\n')" title="Casual Greeting">
                    <i class="bi bi-emoji-smile"></i> Casual
                </button>
                <button type="button" class="toolbar-btn" onclick="insertText('body', '\n\nBest regards,\n[Your Name]')" title="Signature">
                    <i class="bi bi-pen"></i> Signature
                </button>
                <button type="button" class="toolbar-btn" onclick="clearField('body')" title="Clear">
                    <i class="bi bi-eraser"></i> Clear
                </button>
            </div>
            
            <textarea class="form-control" id="body" name="body" rows="12" 
                      placeholder="Type your message here..." required></textarea>
            <div class="char-counter">
                <span id="bodyCounter">0</span> characters
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="d-flex justify-content-between">
            <a href="/inbox" class="btn btn-cancel">
                <i class="bi bi-x-circle"></i> Cancel
            </a>
            <button type="submit" class="btn btn-send">
                <i class="bi bi-send"></i> Send Email
            </button>
        </div>
    </form>
</div>

<!-- Success/Error Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show mt-3" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    {% endif %}
{% endwith %}
{% endblock %}

{% block extra_js %}
<script>
// Character counters
document.getElementById('subject').addEventListener('input', function() {
    document.getElementById('subjectCounter').textContent = this.value.length;
});

document.getElementById('body').addEventListener('input', function() {
    document.getElementById('bodyCounter').textContent = this.value.length;
});

// Helper functions for toolbar
function insertText(fieldId, text) {
    const field = document.getElementById(fieldId);
    const startPos = field.selectionStart;
    const endPos = field.selectionEnd;
    
    field.value = field.value.substring(0, startPos) + text + field.value.substring(endPos);
    field.focus();
    field.setSelectionRange(startPos + text.length, startPos + text.length);
    
    // Update counter
    if (fieldId === 'body') {
        document.getElementById('bodyCounter').textContent = field.value.length;
    }
}

function clearField(fieldId) {
    if (confirm('Are you sure you want to clear this field?')) {
        document.getElementById(fieldId).value = '';
        document.getElementById(fieldId).focus();
        
        // Update counter
        if (fieldId === 'body') {
            document.getElementById('bodyCounter').textContent = '0';
        }
    }
}

// Form validation
document.getElementById('composeForm').addEventListener('submit', function(e) {
    const fromAccount = document.getElementById('from_account').value;
    const to = document.getElementById('to').value;
    const subject = document.getElementById('subject').value;
    const body = document.getElementById('body').value;
    
    if (!fromAccount || !to || !subject || !body) {
        e.preventDefault();
        alert('Please fill in all required fields');
        return false;
    }
    
    // Email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(to)) {
        e.preventDefault();
        alert('Please enter a valid email address');
        return false;
    }
    
    // Disable submit button to prevent double submission
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Sending...';
});

// Auto-save draft (every 30 seconds)
let draftTimer;
function saveDraft() {
    const formData = {
        from_account: document.getElementById('from_account').value,
        to: document.getElementById('to').value,
        cc: document.getElementById('cc').value,
        subject: document.getElementById('subject').value,
        body: document.getElementById('body').value
    };
    
    localStorage.setItem('emailDraft', JSON.stringify(formData));
    console.log('Draft saved');
}

// Save draft on input
document.querySelectorAll('#composeForm input, #composeForm textarea, #composeForm select').forEach(field => {
    field.addEventListener('input', function() {
        clearTimeout(draftTimer);
        draftTimer = setTimeout(saveDraft, 2000); // Save after 2 seconds of inactivity
    });
});

// Load draft on page load
window.addEventListener('load', function() {
    const draft = localStorage.getItem('emailDraft');
    if (draft) {
        const formData = JSON.parse(draft);
        if (confirm('A draft was found. Would you like to restore it?')) {
            document.getElementById('from_account').value = formData.from_account || '';
            document.getElementById('to').value = formData.to || '';
            document.getElementById('cc').value = formData.cc || '';
            document.getElementById('subject').value = formData.subject || '';
            document.getElementById('body').value = formData.body || '';
            
            // Update counters
            document.getElementById('subjectCounter').textContent = formData.subject ? formData.subject.length : 0;
            document.getElementById('bodyCounter').textContent = formData.body ? formData.body.length : 0;
        } else {
            localStorage.removeItem('emailDraft');
        }
    }
});

// Clear draft on successful send
{% if 'success' in get_flashed_messages() %}
localStorage.removeItem('emailDraft');
{% endif %}
</script>
{% endblock %}