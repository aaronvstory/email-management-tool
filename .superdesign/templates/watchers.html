{% extends "base.html" %}
{% block title %}Watchers - Email Management Tool{% endblock %}

{% block content %}
<div id="watchers-page">
  <div class="page-header">
  <div>
    <h1><i class="bi bi-activity"></i> Watchers</h1>
    <p class="text-muted mb-0">Monitor and manage IMAP watchers for real-time email interception.</p>
  </div>
  <div class="header-actions">
    <button class="btn btn-secondary btn-sm" onclick="restartAll()">
      <i class="bi bi-arrow-repeat"></i> Restart All
    </button>
    <button class="btn btn-secondary btn-sm" onclick="refreshAll()">
      <i class="bi bi-arrow-clockwise"></i> Refresh All
    </button>
  </div>
</div>

<!-- Unified Panel for All Watchers -->
<div class="panel-unified">
  <div class="panel-unified-header">
    <h2 class="panel-unified-title">
      <i class="bi bi-collection"></i> Per-Account Watchers
    </h2>
    <div class="panel-actions">
      <span id="watchersCount" class="tag-chip">0 Active</span>
    </div>
  </div>
  
  <!-- This is the new grid for our spacious cards -->
  <div id="accountsGrid" class="watchers-grid">
    <!-- Watcher cards will be dynamically inserted here by JavaScript -->
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// (All the original JavaScript is preserved, but the card rendering function is updated)

const WATCHER_STATE_CHIPS = {
  active: { cls: 'success', icon: 'bi-lightning-charge', label: 'Active' },
  polling: { cls: 'success', icon: 'bi-wifi', label: 'Polling' },
  idle: { cls: 'warning', icon: 'bi-hourglass-split', label: 'Idle' },
  stopped: { cls: 'accent', icon: 'bi-exclamation-octagon', label: 'Stopped' },
  unknown: { cls: 'muted', icon: 'bi-question-circle', label: 'Unknown' }
};

const { escapeHtml, renderTimeCell, applyTimeFormatting } = window.MailOps;

function renderStateChip(state) {
  const normalized = (state || 'unknown').toString().toLowerCase();
  const mapping = WATCHER_STATE_CHIPS[normalized];
  const cls = mapping ? mapping.cls : 'muted';
  const icon = mapping ? mapping.icon : 'bi-question-circle';
  const label = mapping ? mapping.label : escapeHtml(normalized.toUpperCase());
  return `<span class="tag-chip ${cls}"><i class="bi ${icon}"></i> ${label}</span>`;
}

async function loadOverview() {
  try {
    const r = await fetch('/api/watchers/overview');
    if (!r.ok) throw new Error('Failed to load');
    const j = await r.json();

    const grid = document.getElementById('accountsGrid');
    grid.innerHTML = ''; // Clear previous cards
    let activeCount = 0;

    (j.accounts || []).forEach(acc => {
      const state = (acc.watcher && acc.watcher.state) || (acc.is_active ? 'unknown' : 'stopped');
      if (['polling', 'idle', 'active'].includes(state)) {
        activeCount++;
      }
      const stateChip = renderStateChip(state);
      const heartbeatHtml = renderTimeCell(acc.watcher && acc.watcher.last_heartbeat);
      const accountName = escapeHtml(acc.account_name || '');
      const emailAddress = escapeHtml(acc.email_address || '');
      const lastErrorHtml = acc.last_error
        ? `<div class="watcher-meta-label">Last Error</div><div class="watcher-meta-value text-danger">${escapeHtml(acc.last_error)}</div>`
        : '';

      const card = document.createElement('div');
      card.className = 'watcher-card-unified';
      card.innerHTML = `
        <div class="watcher-card-header">${accountName}</div>
        <div class="watcher-meta-grid">
          <div class="watcher-meta-label">Address</div>
          <div class="watcher-meta-value">${emailAddress}</div>
          
          <div class="watcher-meta-label">State</div>
          <div class="watcher-meta-value">${stateChip}</div>
          
          <div class="watcher-meta-label">Heartbeat</div>
          <div class="watcher-meta-value">${heartbeatHtml || 'N/A'}</div>
          
          ${lastErrorHtml}
        </div>
        <div class="watcher-action-bar">
          <button class="btn btn-secondary btn-sm" onclick="restartWatcher(${acc.id}, this)"><i class="bi bi-arrow-repeat"></i> Restart</button>
          <button class="btn btn-secondary btn-sm" onclick="stopWatcher(${acc.id}, this)"><i class="bi bi-stop-fill"></i> Stop</button>
          <button class="btn btn-primary btn-sm" onclick="startWatcher(${acc.id}, this)"><i class="bi bi-play-fill"></i> Start</button>
        </div>`;
      grid.appendChild(card);
    });

    document.getElementById('watchersCount').textContent = `${activeCount} Active`;
    applyTimeFormatting();
  } catch (e) {
    if (window.showError) showError('Failed to load watchers overview');
  }
}

// (The rest of the original JavaScript functions remain unchanged)
async function startWatcher(id, btn){ await controlWatcher(id, 'start', btn); }
async function stopWatcher(id, btn){ await controlWatcher(id, 'stop', btn); }
async function restartWatcher(id, btn){ await controlWatcher(id, 'restart', btn); }
async function controlWatcher(id, action, btn){
  try{
    if(btn){ btn.disabled = true; const t=btn.innerHTML; btn._t=t; btn.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>'+t; }
    const r = await fetch(`/api/accounts/${id}/monitor/${action}`, {method:'POST'});
    const j = await r.json();
    if(!j.success){ throw new Error(j.error || 'Failed'); }
    if(window.showSuccess) showSuccess(`Watcher ${action}ed`);
  }catch(e){ if(window.showError) showError(`Failed to ${action} watcher: ${e.message}`); }
  finally{ if(btn){ btn.innerHTML=btn._t; btn.disabled=false; } loadOverview(); }
}
async function restartAll(){
  try{
    const r = await fetch('/api/accounts');
    const j = await r.json();
    const ids = (j.accounts||[]).map(a=>a.id);
    for(const id of ids){ try{ await fetch(`/api/accounts/${id}/monitor/restart`, {method:'POST'}); }catch(e){} }
    if(window.showInfo) showInfo('Restarting all watchers...');
    setTimeout(loadOverview, 1500);
  }catch(e){ if(window.showError) showError('Failed to restart all'); }
}
function refreshAll(){ loadOverview(); }
document.addEventListener('DOMContentLoaded', ()=>{
  applyTimeFormatting();
  loadOverview();
  setInterval(loadOverview, 10000);
});
</script>
{% endblock %}
